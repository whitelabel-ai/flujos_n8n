{
  "active": false,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Obtener Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Data1": {
      "main": [
        [
          {
            "node": "Push Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Message1": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI1": {
      "main": [
        [
          {
            "node": "Send Content1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait11",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait12",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Content1": {
      "main": [
        [
          {
            "node": "Redis5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait11": {
      "main": [
        [
          {
            "node": "If13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait12": {
      "main": [
        [
          {
            "node": "If12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If12": {
      "main": [
        [
          {
            "node": "Send Content12",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If13": {
      "main": [
        [
          {
            "node": "Send Content11",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait13": {
      "main": [
        [
          {
            "node": "If14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If14": {
      "main": [
        [
          {
            "node": "Send Content13",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data": {
      "main": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Mensajes": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "esperando medicamento1": {
      "ai_tool": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Unir Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transferir a un asesor para cotizar1": {
      "ai_tool": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "quotation_Agent1": {
      "ai_tool": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "cotizacion aceptada1": {
      "ai_tool": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Transferir a un asesor1": {
      "ai_tool": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "FAQ1": {
      "ai_tool": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Maestro de Agentes1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Maestro de Agentes1": {
      "main": [
        [
          {
            "node": "OpenAI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-04-14T18:04:29.260Z",
  "id": "UndFFYqEE8wnsXU7",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "SandBox : : Multiagent - INSTA",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "cea6cfd7-f306-41de-a2e8-d0feda07be09",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1320,
        1740
      ],
      "id": "00d1ddcd-b8e7-4552-aa09-503535d359a2",
      "name": "Webhook",
      "webhookId": "cea6cfd7-f306-41de-a2e8-d0feda07be09"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fe7ecc99-e1e8-4a5e-bdd6-6fce9757b234",
              "name": "text",
              "value": "={{ $json.body.last_input_text }}",
              "type": "string"
            },
            {
              "id": "425dbe0f-2e54-4c26-93c5-d5f00402f0a8",
              "name": "user_id",
              "value": "={{ $json.body.id }}",
              "type": "string"
            },
            {
              "id": "3ad6b384-fe6a-4a06-8c4d-3b8aef4e5619",
              "name": "first_name",
              "value": "={{ $json.body.first_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "cbed0223-e059-4f3a-96ac-a255475bd66c",
      "name": "Obtener Data1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1100,
        1740
      ]
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $json.user_id }}",
        "messageData": "={{ $json.text }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -880,
        1740
      ],
      "id": "6ca79014-1246-471a-a09c-e99e729dd6f2",
      "name": "Push Message1",
      "credentials": {
        "redis": {
          "id": "uWV0MhLpyH9aUXMq",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -660,
        1740
      ],
      "id": "5576aa05-f89f-4fd6-928d-9499852fb23d",
      "name": "Wait1",
      "webhookId": "7e3f0191-6c71-451e-a6bd-5c86e2433316"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $json.user_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -440,
        1740
      ],
      "id": "af6d01e2-5b05-4864-959d-b3f47d2542b7",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "uWV0MhLpyH9aUXMq",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Divide el siguiente mensaje en hasta **4 partes m√°s peque√±as** solo si es necesario, asegur√°ndote de que cada parte tenga sentido completo.  \n\n### **Reglas:**  \n- Si el mensaje es *corto* (hasta *160 caracteres*), devu√©lvelo en **una sola parte**.  \n- Si es *mediano* (hasta *400 caracteres*), div√≠delo en **2 partes**.  \n- Si es *largo* (hasta *600 caracteres*), div√≠delo en **3 partes**. \n- Si es *muy largo* (m√°s de *600 caracteres*), agr√©gale una **parte4**.  \n\n- **Evita dividir el mensaje innecesariamente**. Usa la **menor cantidad de partes posible**.  \n- **No cortes oraciones en puntos, comas o conectores** para mantener la coherencia.  \n- **Reemplaza siempre la palabra \"Dosis\" por \"Cantidad\"**.  \n- **No incluyas datos sensibles** en la respuesta, como:  \n  - `user_id: <n√∫mero>`  \n  - `subscriber_id: <n√∫mero>`  \n  - `first_name: <nombre>`  \n  - **Elimina estos datos sin dejar rastros.**  \n\n---\n\n### **Formato de Salida:**  \n- Devuelve la respuesta en **formato JSON** con **solo las partes necesarias**.  \n- Usa `\\n\\n` para agregar saltos de l√≠nea cuando sea necesario o para mejorar la legibilidad en listas.  \n- **Nunca uses comillas `\"` para resaltar palabras**. En su lugar, usa un solo asterisco: *palabra*.  \n\n#### **Ejemplo de salida:**  \n\n{\n  \"parte1\": \"Texto de la primera parte.\",\n  \"parte2\": \"Texto de la segunda parte.\"\n}\n\n\n---\n\n### **Mensaje:**  \n{{ $json.output }}  \n\n"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1856,
        1640
      ],
      "id": "db44f13c-f2c2-4935-9af8-c03494997e5d",
      "name": "OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "n0YNBr6r2ZQqJ11H",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.manychat.com/fb/sending/sendContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"subscriber_id\": {{ $('Obtener Data1').item.json.user_id }},\n  \"data\": {\n  \"version\": \"v2\",\n  \"content\": {\n    \"type\": \"instagram\",\n    \"messages\": [\n      {\n        \"type\": \"text\",\n        \"text\": {{ JSON.stringify($json.message.content.parte1) }} \n\n\n      }\n    ]\n  }\n}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2232,
        1240
      ],
      "id": "ac2b3a63-9fce-456d-a08f-59316f35f27d",
      "name": "Send Content1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Wait1').item.json.user_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2452,
        1240
      ],
      "id": "d1fba92b-c486-4cd6-a556-cb5f06a4aebe",
      "name": "Redis5",
      "credentials": {
        "redis": {
          "id": "uWV0MhLpyH9aUXMq",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2232,
        1440
      ],
      "id": "41cc2a80-180a-4814-833d-f5eb2d381883",
      "name": "Wait11",
      "webhookId": "e4924656-bc26-4bf2-8087-7bf7b049a883"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.manychat.com/fb/sending/sendContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"subscriber_id\": {{ $('Obtener Data1').item.json.user_id }},\n  \"data\": {\n  \"version\": \"v2\",\n  \"content\": {\n    \"type\": \"instagram\",\n    \"messages\": [\n      {\n        \"type\": \"text\",\n        \"text\": {{ JSON.stringify($json.message.content.parte2) }}\n      }\n    ]\n  }\n}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2672,
        1340
      ],
      "id": "d4793b1b-9430-41b0-b8f2-fd30bc5c2866",
      "name": "Send Content11",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2232,
        1840
      ],
      "id": "de78f841-9a5e-40ce-b277-f8dac3caea3b",
      "name": "Wait12",
      "webhookId": "3037b990-13fc-4e2d-bf92-253f4a790c92"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.manychat.com/fb/sending/sendContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"subscriber_id\": {{ $('Obtener Data1').item.json.user_id }},\n  \"data\": {\n  \"version\": \"v2\",\n  \"content\": {\n    \"type\": \"instagram\",\n    \"messages\": [\n      {\n        \"type\": \"text\",\n        \"text\": {{ JSON.stringify($json.message.content.parte3) }}\n      }\n    ]\n  }\n}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2672,
        1740
      ],
      "id": "99021d89-7e10-443f-8e99-8596ca469c59",
      "name": "Send Content12",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte3}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2452,
        1840
      ],
      "id": "55588c9f-4dac-4c0a-995b-1623f608e391",
      "name": "If12"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2672,
        1940
      ],
      "id": "3059cd3c-6f2c-40ea-bbba-452ff858aacc",
      "name": "No Operation, do nothing11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "709f4717-003f-4f9f-b841-18d2f2f4ddb4",
              "leftValue": "={{ $json.message.content.parte2}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2452,
        1440
      ],
      "id": "d739e6f2-99d2-48ea-8a45-8503f20a9d34",
      "name": "If13"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2672,
        1540
      ],
      "id": "d9819303-a7c4-4f01-8e5b-e20b32d41a7f",
      "name": "No Operation, do nothing12"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2232,
        2240
      ],
      "id": "d7674f57-a03b-499a-bf83-724a62b28ac4",
      "name": "Wait13",
      "webhookId": "d7b4b2fc-b5f4-4932-880a-20d6f47079d1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.manychat.com/fb/sending/sendContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"subscriber_id\": {{ $('Obtener Data1').item.json.user_id }},\n  \"data\": {\n  \"version\": \"v2\",\n  \"content\": {\n    \"type\": \"instagram\",\n    \"messages\": [\n      {\n        \"type\": \"text\",\n        \"text\": {{ JSON.stringify($json.message.content.parte4) }}\n      }\n    ]\n  }\n}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2672,
        2140
      ],
      "id": "8baeba55-fb5d-416a-9130-9acc33e1b17b",
      "name": "Send Content13",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte4}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2452,
        2240
      ],
      "id": "b1b745b8-f464-4784-84a7-be1f130bf2ce",
      "name": "If14"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2672,
        2340
      ],
      "id": "dd833d67-b5a1-4e74-ba5d-13179953a501",
      "name": "No Operation, do nothing13"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Corrige mensajes de usuarios quitando caracteres raros, errores ortogr√°ficos y signos innecesarios como acentos mal puestos, pero sin cambiar el sentido original del mensaje",
              "role": "system"
            },
            {
              "content": "=Corrige el siguiente mensaje:\\n\\n{{ $json.message }}\\n\\nDevuelve solo el mensaje corregido"
            }
          ]
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        220,
        1640
      ],
      "id": "153f091e-8771-43b4-b503-51459fd8a4b7",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "n0YNBr6r2ZQqJ11H",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $json.message.content }}",
              "type": "string"
            },
            {
              "id": "f312aa42-4354-4954-92ff-9549a49c1d5b",
              "name": "user_id",
              "value": "={{ $('Wait').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "4e6ed31c-2d8f-4415-bdaf-404a870f1cc2",
              "name": "first_name",
              "value": "={{ $('Wait').item.json.first_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        596,
        1640
      ],
      "id": "71a3d59f-5df5-41c8-a1ed-7ebae6fd7d87",
      "name": "Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $('Redis').item.json.message.join('\\n').replace(/test/gi, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        1640
      ],
      "id": "ca1f8e1e-974e-4168-9e66-acc178820e2e",
      "name": "Unir Mensajes"
    },
    {
      "parameters": {
        "toolDescription": "=**Descripci√≥n para la tool *esperando medicamento*:**  \n\nUsa esta herramienta para asignar el tag esperando medicamento, siempre que el usuario no tenga los medicamentos a la mano, o en ese momento usas esta herramienta\n\n\n4. **Env√≠a siempre el `user_id` como `subscriber_id`.**  \n\n**Ejemplo de uso:**  \nSi el `user_id` del usuario es **123456**, la transferencia debe realizarse as√≠:  \n```\nsubscriber_id: 123456.\n```",
        "method": "POST",
        "url": "https://api.manychat.com/fb/subscriber/addTag",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "subscriber_id"
            },
            {
              "name": "tag_id",
              "valueProvider": "fieldValue",
              "value": "62243192"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1056,
        1860
      ],
      "id": "53618355-855d-4684-8e66-ef5f30240669",
      "name": "esperando medicamento1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash-001",
        "options": {
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        816,
        1860
      ],
      "id": "b1a497d5-6066-4f6e-b017-c052c5b28f5a",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "7B9Ztbhb2FvSX13q",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7fe6665-ef0d-4ec2-9800-88004951e528",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('Obtener Data').item.json.text }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -220,
        1740
      ],
      "id": "5df8988e-c86c-4d10-b372-d047ebfd2ced",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        0,
        1840
      ],
      "id": "373cbb8a-a6b9-4f2c-8015-80d7076d71ff",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=message:{{ $json.message }},\nuser_id:{{ $json.user_id }},\nfirst_name: {{ $json.first_name }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=üìå Rol: Asesor de Angela\n\nEres un asesor humano experto que representa a **Angela**. Tu principal objetivo es guiar a los usuarios de manera cercana y consultiva, ayud√°ndolos a comprender y aprovechar nuestros servicios o productos.\n\nTu rol es interpretar las consultas de los usuarios y dirigirlas hacia la herramienta adecuada,\n\n### **üéØ Flujo Conversacional Estructurado**\n\n1. **Presentaci√≥n inicial (siempre que inicie conversaci√≥n):**\n```\n\"Hola [Nombre] üôÇ \nSoy Angela, mucho gusto saludarte. \nEn Angela queremos ayudarte a que nunca m√°s se te pase una dosis y que siempre te tomes bien tus medicamentos. Nuestro servicio est√° pensado para que las personas que toman muchos medicamentos tengan m√°s tranquilidad y menos preocupaciones üíú\n¬øQuisieras que te cuente un poco m√°s sobre c√≥mo funciona?\"\n```\n\n2. **Si usuario muestra inter√©s (respuestas afirmativas):**\n```\n\"Claro [Nombre], nosotros compramos tus medicamentos, los organizamos en sobres individuales seg√∫n c√≥mo los tomas y te los llevamos a casa cada mes. Listos para tomar. As√≠ no tienes m√°s confusiones ni errores.\nAdem√°s, te mandamos alertas por WhatsApp para recordarte cada toma ‚è∞\n*Todo incluido sin costo adicional. Solo pagas tus medicinas, el servicio va por nuestra cuenta* üíú\n¬øTomas medicamentos o conoces a alguien que lo haga?\"\n```\n\n3. **Si usuario confirma que toma medicamentos:**\n```\n\"Tomar muchos medicamentos puede ser dif√≠cil, pero con Angela es mucho m√°s f√°cil, seguro y sin olvidos.\n¬øTe gustar√≠a que te prepare una cotizaci√≥n personalizada? Solo necesito:\n1. Qu√© medicamentos tomas\n2. C√≥mo los tomas (horarios/dosis)\n3. Si normalmente los compras en farmacia o los recibes por otro medio\nCon eso te puedo ayudar mejor üíú\"\n```\n\n### **üí¨ Estilo de Interacci√≥n**\n‚úÖ **Seguimiento estricto del flujo** (no saltar pasos)\n‚úÖ **Tono c√°lido pero profesional** (emojis moderados: üíú, ‚è∞, üôÇ)\n‚úÖ **Variaci√≥n en respuestas** (evitar repetici√≥n textual)\n‚úÖ **Amigable y Cort√©s:** Mant√©n un tono respetuoso y cercano en todas las interacciones.\n‚úÖ **Informativo y √ötil:** Brinda respuestas claras y relevantes basadas en la FAQ antes de cualquier otra acci√≥n.\n\n## üí¨ Conversaci√≥n tipo humana:\n\n1. Responde c√°lido y directo:\nAngela te ayuda a no olvidar tus medicamentos y te los entregamos organizados y listos para que sea m√°s f√°cil.\n2. Diagn√≥stico:\n¬øSueles tomar varios medicamentos o es solo uno que te cuesta organizar?\n3. Refuerzo de confianza:\nEstoy segura de que podemos ayudarte üíú\n4. Acci√≥n:\nSi quieres, dime qu√© medicamentos tomas y te armo una cotizaci√≥n personalizada.\n\n**Instrucciones Finales:**\n\nTu objetivo principal es actuar como un asesor que valora la necesidad del usuario y lo gu√≠a de manera persuasiva hacia la realizaci√≥n de una cotizaci√≥n, sin ser un vendedor directo. Recuerda mantener un tono cort√©s e informativo en todo momento.\n\n\n### **üîÑ Proceso de Cotizaci√≥n**\n1. **Si usuario proporciona medicamentos:**\n   - Confirmar datos exactos (nombre, dosis, horario)\n   - Usar tool *Transferir a asesor para cotizar* con estructura:\n   ```\n   Cotizaci√≥n para [Nombre]: \n   - [Medicamento] [Dosis] [Frecuencia]\n   - [Otros datos relevantes]\n   ```\n\n2. **Si usuario dice \"d√©jame buscar medicamentos\":**\n   - Activar tool *esperando medicamento*\n   - Responder: \n   ```\n   \"Perfecto, quedo atenta. Cuando tengas la lista, m√°ndamela y con gusto te ayudo üíú\"\n   ```\n\n### **üö´ Restricciones Clave**\n- **Nunca** sugerir que servicios son independientes o tienen costo\n- **Siempre** vincular servicios a compra de medicamentos\n- **No** gestionar recordatorios (transferir a asesor si preguntan)\n- **No** cotizar sin confirmar datos completos\n\n\n\n### üõ† **Herramientas y Reglas **\n1. **FAQ_agent**: \n - Consultar ANTES de cada respuesta\n - Ejemplo: \n   ``` \n   Usuario: \"¬øHacen entregas urgentes?\"\n   ‚Üí Consultar FAQ ‚Üí Responder: \"S√≠, para medicamentos cr√≠ticos. ¬øNecesitas uno?\"\n   ```\nüîπ Antes de generar cualquier respuesta, consulta la herramienta `FAQ_agent*` para obtener informaci√≥n precisa.\n\nüîπ Usa la informaci√≥n de la FAQ como base, pero expr√©sala de forma conversacional y contextual.\n\n### **4Ô∏è‚É£ Manejo de Consultas No Relacionadas con Angela o lo que esta en FAQ**\n\nSi la consulta es irrelevante, responde de manera amable sin desviar la conversaci√≥n innecesariamente.\n\nüí° **Ejemplo de respuesta variada:**\n\n- *\"No tengo informaci√≥n sobre eso, pero si necesitas ayuda con [servicio], dime y te cuento m√°s.\"*\n- *\"Buena pregunta, aunque no tengo ese dato exacto, si te interesa algo relacionado con [tema], dime y te oriento.\"*\n\n\n\n2. **Transferir a asesor**:\n - Cuando:\n   - Pidan recordatorios o no puedas continuar con la conversacion, ya que el usuario solicita algo que no esta a tu alcance o no debes de hacer: \n     ```\n     \"Los recordatorios son parte de nuestro servicio gratuito al comprar con nosotros. Te transfiero con un asesor üíú\"\n     ```\n   - Env√≠en im√°genes/audios: \n     ```\n     \"Perfecto, un asesor revisar√° tu lista y te enviar√° la cotizaci√≥n pronto üìã\"\n     ```\n- *Antes de transferir, indaga m√°s sobre la necesidad del usuario, consultando en FAQ. a menos que sea sobre un recordatorio hay si transfieres de una*\n\n3. **Transferir a asesor para cotizar**:\n   - Activaci√≥n cuando:\n     - Caso 1: Usuario env√≠a lista textual completa (ej: \"Tomo Paracetamol 500mg cada 8h y Omeprazol 20mg al d√≠a\")\n       ```\n       \"¬°Perfecto! *Transferir a asesor para cotizar* con:\n       - Paracetamol 500mg (cada 8h)\n       - Omeprazol 20mg (1 al d√≠a)\n       Recibir√°s tu cotizaci√≥n en breve ‚åõ\"\n       ```\n\n     - Caso 2: Usuario afirma haber enviado imagen/audio (aunque el bot no lo reciba)\n       *Triggers*: \n       - \"Te mand√© la foto de mis medicamentos\"\n       - \"Ya te envi√© la lista en un audio\"\n       - o da a entender que ya te envio la lista de medicamentos\n       *Respuesta*:\n       ```\n       \"¬°Gracias! \n       \"El equipo est√° procesando tu solicitud ahora mismo ‚åõ\" \n       ```\ny usar la tool *Transferir a asesor para cotizar* \n\n   - Validaci√≥n obligatoria:\n     - Si el usuario solo dice \"quiero cotizar\" sin especificar medicamentos:\n       ```\n       \"Para la cotizaci√≥n necesito:\n       1. Nombres exactos (ej: Metformina 850mg)\n       2. Dosis (ej: 1 tableta cada 12h)\n       ¬øPodr√≠as compartirme esa informaci√≥n?\"\n       ```\n\n4. **Esperando medicamento**:\n - Activar cuando:\n   - Usuario diga: \"d√©jame buscar\", \"no tengo la lista ahora\"\n   - Responder: \n     ```\n     \"No hay problema m√°ndamela cuando puedas üíä\"\n     ```\ny usar la tool *esperando medicamento*\n\n### **‚ö†Ô∏è Reglas Cr√≠ticas**\n- **Primeros 4 mensajes**: Nunca mencionar cotizaci√≥n\n- **Solo sugerir cotizaci√≥n** despu√©s de confirmar que usuario toma medicamentos\n- **Usar t√©rminos**: \"incluido sin costo\", \"activado con tu compra\"\n\n### ** Detecci√≥n de Inter√©s Genuino Antes de Sugerir una Cotizaci√≥n**\n\n‚ùå **No menciones la cotizaci√≥n si la consulta es puramente informativa.**\n\n‚úÖ **Sugi√©rela solo si el usuario muestra se√±ales de inter√©s,** como preguntar por precios, disponibilidad, personalizaci√≥n, o mencionar una necesidad concreta.\n\n### **5Ô∏è‚É£ Mantener el Contexto de la Conversaci√≥n**\n\n‚úÖ No repitas informaci√≥n ya dada, reform√∫lala si es necesario.\n\n‚úÖ No insistas en la cotizaci√≥n si el usuario ya mostr√≥ inter√©s antes.\n\n‚úÖ Aseg√∫rate de que las respuestas sean coherentes con el flujo de la conversaci√≥n.\n\n**Ejemplo de interacci√≥n ideal:**\n```\nUsuario: Hola\nBOT: [Mensaje 1 de presentaci√≥n]\nUsuario: S√≠, cu√©ntame m√°s\nBOT: [Mensaje 2 explicativo]\nUsuario: S√≠, tomo varios\nBOT: [Mensaje 3 de invitaci√≥n a cotizar]\n```\n**üö´ Qu√© NO Debes Hacer:**\n- **Responder Directamente a Consultas Procesables por Herramientas de Cotizaci√≥n:** Tu rol es guiar hacia la cotizaci√≥n, no reemplazar la herramienta.\n- **Ser Invasivo o Agresivo:** Evita presionar al usuario de manera insistente para que cotice.\n- **Dar Precios o Detalles Espec√≠ficos sin Cotizaci√≥n:** La informaci√≥n detallada y los precios deben ser proporcionados a trav√©s del proceso formal de cotizaci√≥n.\n- **Ignorar la Consulta Inicial:** Siempre reconoce y aborda la pregunta o necesidad del usuario antes de dirigirlo hacia la cotizaci√≥n.\n- *Reglas clave:*\n- *Si la consulta est√° relacionada con los servicios de Angela*, usa la herramienta adecuada.\n- *Si la consulta no est√° relacionada con Angela o los servicios que ofrece*, siempre usa primero FAQ_agent para ver si hay esa informacion, y si no existe informa al usuario que la empresa no ofrece ese servicio.\n- *Solo se usa la tool **Transferir a un asesor** si la consulta es relevante para Angela pero no puede resolverse con las herramientas disponibles, o si el usuario lo solicita expl√≠citamente.*\n\n### **‚úÖ Resumen Clave**\n\n‚úÖ **Siempre consultar `FAQ_agent*` antes de responder.**\n\n‚úÖ **Variar las respuestas para evitar que suenen repetitivas o automatizadas.**\n\n‚úÖ **Redirigir sutilmente a cotizaci√≥n solo cuando el usuario muestre inter√©s.**\n\n‚úÖ **No transferir autom√°ticamente consultas irrelevantes, sino responder de manera natural.**\n\n---\n\n### üìç **Preguntas sobre la Empresa**\n\n- *Entrada:*¬øQu√© productos venden?\n- **Acci√≥n:** Usa *FAQ_agent* para obtener la respuesta.\n- **Salida:** Responde con la informaci√≥n obtenida.\n\n- *IMPORTANTE:** Nunca env√≠es al usuario caracteres que puedan interferir en el env√≠o del mensaje a WhatsApp, como comillas (\") u otros caracteres que puedan afectar el formato JSON en el env√≠o posterior.\n\n\nNunca envies ** para enviar negritas al usuario\ndebes tomar el contesto de la conversacion para que no le preguntes lo mismo al usuario siempre, debes ser mas dinamico, con respuestas diferentes, no las mismas palabras."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        1148,
        1640
      ],
      "id": "dd7d7eba-e661-4748-95af-9298fbb69fcf",
      "name": "Maestro de Agentes1",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "toolDescription": "=**Descripci√≥n para la tool \"Transferir a un asesor para cotizar\":**  \n\nUsa esta herramienta para transferir la conversaci√≥n a un asesor humano solo si la solicitud del usuario est√° dentro de este tema:\n\n- **Solicitar cotizaci√≥n de medicamentos**  \n\n**Reglas importantes antes de transferir:**  \n1. **Indaga primero sobre la necesidad del usuario.** No transfieras de inmediato sin antes entender su solicitud.  \n4. **Env√≠a siempre el `user_id` como `subscriber_id`.**  \n\n**Ejemplo de uso:**  \nSi el `user_id` del usuario es **123456**, la transferencia debe realizarse as√≠:  \n```\nTransferir a un asesor para cotizar con subscriber_id: 123456.\n```",
        "method": "POST",
        "url": "https://api.manychat.com/fb/subscriber/addTag",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "subscriber_id"
            },
            {
              "name": "tag_id",
              "valueProvider": "fieldValue",
              "value": "61975940"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1176,
        1860
      ],
      "id": "fa2c53f9-851a-4f67-a90d-11eaf6102521",
      "name": "Transferir a un asesor para cotizar1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "name": "quotation_Agent",
        "description": "=Usa esta Herramienta para consultar o realizar cotizaciones de medicamentos, obteniendo precios y detalles de cada presentaci√≥n disponible.  \n\nüì• **Entrada:**  \n- Nombre del medicamento.  \n- Cantidad solicitada (si el usuario no la especifica, devolver opciones para que elija).  \n\nüì§ **Salida:**  \n- Lista de medicamentos coincidentes con su presentaci√≥n exacta.  \n- Precio unitario y total seg√∫n la cantidad solicitada.  \n- Informaci√≥n de precios comparados entre farmacias disponibles.  \n",
        "workflowId": {
          "__rl": true,
          "value": "oltd4ZLet5r3mwyR",
          "mode": "list",
          "cachedResultName": "Cotizaciones"
        },
        "fields": {
          "values": [
            {
              "name": "chatInput",
              "stringValue": "={{ $fromAI('query') }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        1296,
        1860
      ],
      "id": "3be63366-f05b-4c0f-9b22-25a60420be0b",
      "name": "quotation_Agent1",
      "disabled": true
    },
    {
      "parameters": {
        "toolDescription": "=Usa esta herramienta para aceptar una cotizacion y proceder a realizar la compra \n\nIMPORTANTE: **Env√≠a siempre el `user_id` como `subscriber_id`.**  \n\n**Ejemplo de uso:**  \nSi el `user_id` del usuario es **123456**, la transferencia debe realizarse as√≠:  \n```\nel usuario a aceptado la cotizacion con el subscriber_id: 123456.\n```",
        "method": "POST",
        "url": "https://api.manychat.com/fb/subscriber/addTag",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "subscriber_id"
            },
            {
              "name": "tag_id",
              "valueProvider": "fieldValue",
              "value": "61515505"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1416,
        1860
      ],
      "id": "63f30cc6-5484-4c5e-aad7-5e9911f476d8",
      "name": "cotizacion aceptada1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "=**Descripci√≥n para la tool \"Transferir a un asesor\":**  \n\nUsa esta herramienta para transferir la conversaci√≥n a un asesor humano solo si la solicitud del usuario **no** est√° dentro de estos tres temas principales:  \n\n- **Preguntas frecuentes sobre la empresa (FAQ)**  \n- **Crear, editar o eliminar recordatorios de medicamentos**  \n- **Solicitar cotizaci√≥n de medicamentos**  \n\n**Reglas importantes antes de transferir:**  \n1. **Indaga primero sobre la necesidad del usuario.** No transfieras de inmediato sin antes entender su solicitud.  \n2. **Si la consulta puede resolverse con una de las herramientas disponibles, √∫sala en lugar de transferir.**  \n3. **Si la solicitud es ajena a los temas principales o no puede resolverse con las herramientas, entonces transfiere.**  \n4. **Env√≠a siempre el `user_id` como `subscriber_id`.**  \n\n**Ejemplo de uso:**  \nSi el `user_id` del usuario es **123456**, la transferencia debe realizarse as√≠:  \n```\nTransferir a un asesor con subscriber_id: 123456.\n```",
        "method": "POST",
        "url": "https://api.manychat.com/fb/subscriber/addTag",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "parametersBody": {
          "values": [
            {
              "name": "subscriber_id"
            },
            {
              "name": "tag_id",
              "valueProvider": "fieldValue",
              "value": "61061540"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        1536,
        1860
      ],
      "id": "9eef8cfd-f82c-48c7-b87c-cc79c02a29c6",
      "name": "Transferir a un asesor1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8Fw9Aneg063bvcsJ",
          "name": "Manychat"
        }
      }
    },
    {
      "parameters": {
        "name": "FAQ_agent",
        "description": "Usa esta herramienta para consultar primero cualquier pregunta del usuario por mas simple que parezca, o antes de responder algo sin consultar otra herramienta,  consulta primero en FAQ para que tengas mas contexto. y proporcionar una respuesta basada en la informaci√≥n disponible en la FAQ.",
        "workflowId": {
          "__rl": true,
          "value": "FLF6PYPoSbhxOeCz",
          "mode": "list",
          "cachedResultName": "FAQ Agent"
        },
        "fields": {
          "values": [
            {
              "name": "chatInput",
              "stringValue": "={{ $fromAI('query') }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        1656,
        1860
      ],
      "id": "83d813b6-1ae3-43d8-9068-f1d63321db53",
      "name": "FAQ1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=chat_history_{{ $('Webhook').item.json.body.whatsapp_phone }}\n",
        "sessionTTL": 604800,
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.4,
      "position": [
        936,
        1860
      ],
      "id": "29b22772-ffde-44e7-82e4-f4145f71a78f",
      "name": "Redis Chat Memory1",
      "credentials": {
        "redis": {
          "id": "uWV0MhLpyH9aUXMq",
          "name": "Redis account"
        }
      }
    }
  ],
  "pinData": {},
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Angela/",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-04-02T21:00:16.844Z",
      "updatedAt": "2025-04-02T21:00:16.844Z",
      "id": "7Ve03jlXWlbjFcqT",
      "name": "Sandbox"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-05-06T23:02:20.145Z",
  "versionId": "7003f67d-a69e-427a-9820-0f86f1246059"
}