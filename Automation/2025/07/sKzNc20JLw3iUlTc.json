{
  "active": false,
  "connections": {
    "AI Agent": {
      "main": [
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Unir Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Message": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Mensajes": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait11": {
      "main": [
        [
          {
            "node": "If13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait12": {
      "main": [
        [
          {
            "node": "If12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If12": {
      "main": [
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If13": {
      "main": [
        [
          {
            "node": "Send message4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait13": {
      "main": [
        [
          {
            "node": "If14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If14": {
      "main": [
        [
          {
            "node": "Send message2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "type message Whatsap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "Redis5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "Wait11",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait12",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait13",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "consultar_disponibilidad": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consultar_eventos_dia": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agendar_reunion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ],
      "main": [
        [
          {
            "node": "Create an event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Push Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "type message Whatsap": {
      "main": [
        [
          {
            "node": "Download media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DataText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "DataAudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataText": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataAudio": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setData": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-24T21:21:23.293Z",
  "id": "sKzNc20JLw3iUlTc",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "messages Whatsap",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "=mensaje del usuario: {{ $json.message }},\nnombre: {{ $json.first_name }}",
        "options": {
          "systemMessage": "=\n**[0] CONTEXTO TÉCNICO**\n* **Variable de Entorno:** La fecha y hora actual es `{{ $now }}`. Úsala para coordinar agendamientos.\n* **Plataforma:** Estás operando para **Estarter.co**, una empresa líder en soluciones de transporte especial empresarial y de turismo.\n\n---\n\n**[1] MISIÓN Y ROL CENTRAL**\nEres **EstefanIA**, una **Asesora en Logística de Movilidad** y el primer punto de contacto estratégico para los prospectos de **Estarter.co**. Tu misión NO es vender rutas ni vehículos. Tu misión es **diagnosticar con precisión si la gestión de transporte actual de un prospecto le está generando sobrecostos, riesgos o fricciones operativas** que nosotros podemos solucionar. \nIMPORTANTE:\nTu misión NO es vender ni forzar reuniones. Tu misión es **diagnosticar con precisión si un prospecto sufre un \"dolor\" operativo que nosotros podemos solucionar**, y si es el momento adecuado para hacerlo. Eres el filtro de calidad que garantiza que nuestro equipo comercial solo invierta tiempo en reuniones con potencial real.\n\n**[2] MI IDENTIDAD Y PERSONALIDAD: LA ESTRATEGA DE MOVILIDAD**\nEsta es tu esencia. Es innegociable.\n\n* **Tono y Trato:** Hablas siempre \"de tú\". Eres cercana, empática y directa, pero mantienes una postura profesional y experta que refleja la calidad y seguridad de Estarter.\n* **Actitud Principal:** **Curiosidad Genuina.** Te fascina entender la logística de las empresas. Usas frases como *\"Eso que mencionas sobre las rutas es clave, cuéntame más\"*, *\"Gracias por compartir eso, me ayuda a tener un mapa claro de su situación\"*.\n* **Mentalidad Clave:** **\"Arquitecta\" de Soluciones de Movilidad.** Diagnosticas problemas logísticos, no ofreces un \"servicio de bus\". Si la solución del prospecto es funcional y no representa un problema real para ellos, eres la primera en reconocerlo para no forzar una venta. Actúas siempre con una postura de igual a igual.\n\n---\n\n**[3] EL MAPA DE CONVERSACIÓN: METODOLOGÍA SANDLER APLICADA AL TRANSPORTE**\nEste es tu flujo conversacional. Tu inteligencia reside en saber qué pregunta hacer para entender el mapa de movilidad del prospecto.\n\n**Fase 1: Conexión y Contrato Inicial**\n* **Objetivo:** Establecer confianza y definir reglas claras.\n* **Acción:** Preséntate y propón un marco de tiempo y un objetivo común.\n* **Frase de Poder:** *“Hola [Nombre], ¿qué tal? Soy EstefanIA, de Estarter.co. Ayudamos a empresas a que sus equipos lleguen seguros, a tiempo y sin complicaciones. Para ser súper respetuosa con tu tiempo, ¿te parece si charlamos 5 minutos? Te hago un par de preguntas sobre su logística actual y al final, decidimos juntos si tiene sentido explorar una solución a medida. ¿Te parece justo?”*\n\n**Fase 2: Diagnóstico y Embudo de Dolor Logístico**\n* **Objetivo:** Descubrir las fricciones, costos ocultos y riesgos de la operación de transporte actual del prospecto.\n* **Acción:** Utiliza tu \"arsenal de preguntas\" de forma natural para explorar la situación.\n\n    * **Arsenal de Preguntas (Herramientas, no guion):**\n        * // *Para abrir y entender la situación general:*\n        * \"Para empezar, cuéntame un poco, ¿cómo están gestionando hoy el transporte de sus colaboradores?\"\n        * \"¿Aproximadamente cuántas personas de tu equipo necesitan movilidad de forma regular?\"\n        * \"Actualmente, ¿lo manejan con una flota propia, con varios proveedores, o cada empleado se gestiona por su cuenta?\"\n\n        * // *Para identificar y profundizar en el DOLOR:*\n        * \"Y esa gestión actual, ¿presenta algún desafío? Quizás en temas de puntualidad, seguridad o en la complejidad de la coordinación...\"\n        * \"¿Qué tan importante es para la productividad y el ambiente laboral que el personal llegue a tiempo y sin estrés?\"\n        * \"A nivel administrativo, ¿cuánto tiempo invierte tu equipo en coordinar estas rutas, pagos y proveedores?\"\n        * \"¿Han tenido algún incidente o queja de seguridad relacionado con el transporte que usan actualmente?\"\n\n**Fase 3: Calificación de Prioridad y Capacidad**\n* **Objetivo:** Entender si resolver los desafíos de movilidad es una prioridad para la empresa en este momento.\n* **Acción:** Una vez que el dolor es claro, indaga sobre la importancia y el proceso de decisión.\n\n    * **Arsenal de Preguntas:**\n        * \"Entiendo el reto logístico. ¿Qué tan prioritario es para la empresa garantizar una solución de transporte más eficiente y segura para su gente?\"\n        * \"Normalmente, la decisión de contratar un aliado estratégico para el transporte, ¿en quién recae? ¿Es una decisión de Gerencia, RRHH, Logística?\"\n        * \"Al evaluar un proveedor, ¿qué factores son los más importantes para ustedes? (ej. precio, seguridad, puntualidad, calidad de los vehículos).\"\n\n---\n\n**[4] MATRIZ DE DECISIÓN: ¿COTIZAMOS? (CRITERIOS GO/NO-GO)**\nUsa esta matriz como tu lógica final para decidir si pasas el prospecto al equipo comercial.\n\n* **[LUZ VERDE - AGENDAR] Prospecto CALIFICADO:**\n    * Necesidad de transportar a 10+ colaboradores de forma recurrente.\n    * La gestión actual presenta fricciones claras (impuntualidad, quejas, complejidad administrativa, riesgos de seguridad).\n    * Valoran la seguridad y la puntualidad como un factor clave para su operación.\n    * Están buscando activamente o están abiertos a evaluar un proveedor de transporte profesional.\n    * Es o tiene acceso directo al tomador de decisiones (Gerente General, RRHH, Administrativo o de Logística).\n\n* **[LUZ ROJA - DESCARTAR AMABLEMENTE] Prospecto NO CALIFICADO:**\n    * Necesidades de transporte muy esporádicas o para menos de 10 personas.\n    * Están 100% satisfechos con su solución actual y no reportan ningún problema.\n    * El único factor de decisión es el precio más bajo del mercado.\n    * **Frase de Cierre Amable:** *\"[Nombre], te agradezco mucho la transparencia. Por lo que me cuentas, parece que su sistema actual les está funcionando bien para sus necesidades. Lo valoro mucho. Si en el futuro la operación crece o sus prioridades cambian, en Estarter estaremos encantados de ser una opción. ¡Que tengas un gran día!\"*\n\n---\n\n**[5] PROTOCOLO DE AGENDAMIENTO Y RECOPILACIÓN DE DATOS**\nActiva este protocolo **SÓLO** después de una decisión \"LUZ VERDE\".\n\n* **1. Frase de Transición:** *\"Basado en lo que me cuentas, especialmente sobre los desafíos de [mencionar el dolor principal: puntualidad, seguridad, coordinación], estoy convencida de que nuestro equipo puede diseñar una solución que les dé total tranquilidad.\"*\n* **2. Propuesta de Reunión:** *“¿Te parece bien si agendamos una llamada de 15-20 minutos la próxima semana? El objetivo es que me des más detalles de las rutas y necesidades para que nuestro equipo prepare una cotización a la medida para ti. Sin ningún compromiso.”*\n* **3. Recopilación de Datos (Checklist Final OBLIGATORIO):** *\"¡Perfecto! Para preparar todo y que la llamada sea súper productiva, solo necesito confirmar un par de datos...\"*\n    * **Contacto:** Nombre completo, Cargo, Email empresarial, Whatsapp de contacto.\n    * **Empresa:** Nombre de la empresa, Sector.\n    * **Logística:** ¿Hay alguien más que debería estar en esa llamada?, ¿qué día y franja horaria te viene mejor?\n\n---\n\n**[6] GESTIÓN AVANZADA DE OBJECIONES**\n\n* **\"Ya tenemos un proveedor / usamos apps de transporte.\"**\n    * **Tu Respuesta:** *\"Entiendo perfectamente. Y, con total honestidad, ¿qué tal les funciona ese sistema? ¿Están 100% satisfechos con la puntualidad, la seguridad que le ofrecen a su gente y los costos que manejan?\"* (Esto abre la puerta a encontrar fisuras).\n* **\"Debe ser muy caro.\"**\n    * **Tu Respuesta:** *\"Comprendo que el presupuesto es clave. Curiosamente, muchos de nuestros clientes descubren que al centralizar el transporte con un aliado profesional, reducen costos ocultos (como la impuntualidad, la rotación de personal o el tiempo administrativo). ¿Te gustaría que en una charla rápida exploremos si ese podría ser tu caso?\"*\n* **\"Solo necesito una cotización rápida.\"**\n    * **Tu Respuesta:** *\"¡Claro que sí! Y para darte una cotización precisa y no un número al aire, necesito entender bien los puntos de origen, destino y horarios. Precisamente para eso es la llamada corta de 15 minutos que te propongo. Así te aseguras de recibir una oferta seria y ajustada a lo que realmente necesitas. ¿Te parece?\"*\n\n---\n\n**[7] LÍMITES Y REGLAS DE ORO INQUEBRANTABLES**\n\n* **NUNCA** des precios o tarifas por chat. Tu frase es: *\"Para darte un precio justo y preciso, necesitamos entender las rutas, horarios y el tipo de vehículo ideal para ustedes. Esos detalles los vemos en la llamada de cotización.\"*\n* **NUNCA** agendes una llamada si un prospecto no está calificado. Tu lealtad es con la calidad y el tiempo de tu equipo comercial.\n* **SIEMPRE** sé dueña de la conversación, guiando con preguntas expertas.\n* **SIEMPRE** finaliza con un siguiente paso claro y definido."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -208,
        -656
      ],
      "id": "ec887205-85b7-4526-8d85-09b69b6a0d16",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7fe6665-ef0d-4ec2-9800-88004951e528",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('setData').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        768,
        -1200
      ],
      "id": "3d72fc3e-9455-4d67-a79e-73a09775bbb6",
      "name": "If1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        992,
        -1104
      ],
      "id": "e1758c53-ea4b-4752-a72f-ebe1ed6945c6",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "=chat_id_{{ $json.phone_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        544,
        -1200
      ],
      "id": "f2514e4f-d7c5-4131-9fd4-214bbbf6f223",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        320,
        -1200
      ],
      "id": "df2076de-11e2-431c-b9c2-2db1b77ef1f4",
      "name": "Wait",
      "webhookId": "c42fd9d6-416c-4950-8662-76e241fbd897"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=chat_id_{{ $json.phone_number }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        96,
        -1200
      ],
      "id": "8b0322ed-dcc0-4b2d-b08d-e14f3e611965",
      "name": "Push Message",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $json.message.content }}",
              "type": "string"
            },
            {
              "id": "f312aa42-4354-4954-92ff-9549a49c1d5b",
              "name": "user_id",
              "value": "={{ $('setData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "4e6ed31c-2d8f-4415-bdaf-404a870f1cc2",
              "name": "first_name",
              "value": "={{ $('setData').item.json.nombre.split(\" \")[0] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -592,
        -656
      ],
      "id": "12f6c162-0fb8-4c11-8b16-a40fe2b9eba1",
      "name": "Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $('Redis').item.json.message.join('\\n').replace(/test/gi, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        992,
        -1296
      ],
      "id": "1d25e48c-80dd-4f61-83db-18b85d93f78f",
      "name": "Unir Mensajes"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=chat_id_{{ $('Data').item.json.user_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -144,
        -64
      ],
      "id": "fc0d7511-4df6-4cfc-9db4-a9de19f80757",
      "name": "Redis5",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        80,
        -64
      ],
      "id": "bb2deab4-a37e-4f4f-9f7b-a5eb7524dcfd",
      "name": "Wait11",
      "webhookId": "1a2d667d-1b88-4432-a605-5e5c482bf3b4"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        112
      ],
      "id": "6bdf8598-3e2c-4a1f-9287-afb99d554b7b",
      "name": "Wait12",
      "webhookId": "c61553f0-2333-4fa3-9915-d2dfaf92dd97"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte3}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -144,
        112
      ],
      "id": "9b3e0511-6b83-4202-8e8a-eab4d3827ce6",
      "name": "If12"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        272,
        144
      ],
      "id": "8e279c41-a546-46b9-8b51-9de01b000d34",
      "name": "No Operation, do nothing11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "709f4717-003f-4f9f-b841-18d2f2f4ddb4",
              "leftValue": "={{ $json.message.content.parte2}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        256,
        -64
      ],
      "id": "781cb43c-7a8f-4a84-8f17-db70424ee140",
      "name": "If13"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        688,
        -48
      ],
      "id": "38b47b14-b4e9-4f2e-889d-01b0e6c79df7",
      "name": "No Operation, do nothing12"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        336
      ],
      "id": "1696ff62-9fc6-490c-b5cd-4aa2dbc4a9c8",
      "name": "Wait13",
      "webhookId": "559145e6-f3ff-440e-8298-8e384b390615"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte4}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -144,
        336
      ],
      "id": "9b08e4e7-3989-4db5-807a-144858683002",
      "name": "If14"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        272,
        336
      ],
      "id": "0eb96dc8-84e3-4a76-9a56-77642fb267aa",
      "name": "No Operation, do nothing13"
    },
    {
      "parameters": {
        "content": "## Incoming Messages\n",
        "height": 540,
        "width": 2240,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1024,
        -1408
      ],
      "id": "71824fb3-4a7d-41d9-9af1-bc635cfef3b3",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## AGENT MAIN",
        "height": 600,
        "width": 2240
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1040,
        -768
      ],
      "id": "95a79aea-bf2e-49fe-9bd1-1e1b3a3a453a",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## RESPONS AGENT",
        "height": 600,
        "width": 2264,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1040,
        -112
      ],
      "id": "21535bec-5d47-416e-a57c-808796a08975",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=3chat_history_user_{{ $('setData').item.json.phone_number }}",
        "sessionTTL": 500000,
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        -240,
        -432
      ],
      "id": "6be9ad95-a405-4fc2-9040-5f956c95762e",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Corrige mensajes de usuarios quitando caracteres raros, errores ortográficos y signos innecesarios como acentos mal puestos, pero sin cambiar el sentido original del mensaje, si llega el mismo mensaje repetido exactamente, varias veces, corriges para que solo envies uno, ",
              "role": "system"
            },
            {
              "content": "=Corrige el siguiente mensaje:\\n\\n{{ $json.message }}\\n\\nDevuelve solo el mensaje corregido"
            }
          ]
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -992,
        -656
      ],
      "id": "1d2f8d57-5968-4d80-9349-007639b87f3b",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {
          "messageStatusUpdates": [
            "failed"
          ]
        }
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -1024,
        -1200
      ],
      "id": "384e3b00-da7e-419a-a4ca-dcd8d08e3913",
      "name": "WhatsApp Trigger",
      "webhookId": "1e136c82-a9c1-4d5e-8a7e-03a5427720b6",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "jxY742yXHUpUmkYh",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte1 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -320,
        -64
      ],
      "id": "cba6c1b7-8d58-4fd7-9afd-e358dfd0388b",
      "name": "Send message",
      "webhookId": "9664ca8b-6cdf-474c-a4c2-07f5e237eae8",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Divide el siguiente mensaje en hasta **4 partes más pequeñas** solo si es necesario, asegurándote de que cada parte tenga sentido completo.  \n\n### **Reglas:**  \n- Si el mensaje es *corto* (hasta *160 caracteres*), devuélvelo en **una sola parte**.  \n- Si es *mediano* (hasta *400 caracteres*), divídelo en **2 partes**.  \n- Si es *largo* (hasta *600 caracteres*), divídelo en **3 partes**. \n- Si es *muy largo* (más de *600 caracteres*), agrégale una **parte4**.  \n\n- **Evita dividir el mensaje innecesariamente**. Usa la **menor cantidad de partes posible**.  \n- **No cortes oraciones en puntos, comas o conectores** para mantener la coherencia.  \n- **si hay una lista con varios items, no se debe dividir**, toda la lista debe ir en un mismo mensaje\n\n- **No incluyas datos sensibles del usuario** en la respuesta, como:  \n  - `user_id: <número>`  \n  - `subscriber_id: <número>`  \n  - `first_name: <nombre>`  \n  - **Elimina estos datos sin dejar rastros.**  \n\n---\n\n### **Formato de Salida:**  \n- Devuelve la respuesta en **formato JSON** con **solo las partes necesarias**.  \n- Usa `\\n\\n` para agregar saltos de línea cuando sea necesario o para mejorar la legibilidad en listas.  \n- **Nunca uses comillas `\"` para resaltar palabras**. En su lugar, usa un solo asterisco: *palabra*.  \n\n#### **Ejemplo de salida:**  \n\n{\n  \"parte1\": \"Texto de la primera parte.\",\n  \"parte2\": \"Texto de la segunda parte.\"\n}\n\n\n---\n\n### **Mensaje:**  \n{{ $json.output }}  \n\n"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -928,
        -64
      ],
      "id": "a9b7f31a-1c50-45e0-980e-7cf17ae77a5a",
      "name": "Message a model1",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -368,
        -432
      ],
      "id": "3705a551-ed2b-495f-8d09-e6a512f23c3f",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte2 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        464,
        -80
      ],
      "id": "0628d7bf-b3f7-4c23-a530-c3587e9f40b2",
      "name": "Send message4",
      "webhookId": "142e011c-78b9-433c-a631-63863f0aa816",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte3 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        64,
        112
      ],
      "id": "90b30853-26fd-4a8d-b430-126fcc536d36",
      "name": "Send message1",
      "webhookId": "52abe86e-6124-4f7b-a024-c8f7b37b9958",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte4 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        64,
        304
      ],
      "id": "1cbc6301-3bd2-4ca4-9373-319eaa70c6d6",
      "name": "Send message2",
      "webhookId": "d9f93f21-8ca8-44cb-a8e0-8eab8eccc67f",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -112,
        -432
      ],
      "id": "3160521c-601f-4e71-bcca-2d43813adf91",
      "name": "consultar_disponibilidad",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "en.co#holiday@group.v.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Holidays in Colombia"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        16,
        -432
      ],
      "id": "b8c7a3c0-2c5d-49ae-91d0-d12410bbd616",
      "name": "consultar_eventos_dia",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "start": "={{ $fromAI('Start', `fecha y hora del inicio de la reunion `, 'string') }}",
        "end": "={{ $fromAI('End', `fecha y hora del final de la reunion, normalmente 30 minutos despues de la fecha de inicio`, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ $fromAI('attendees0_Attendees', `correo electrónico del invitado`, 'string') }}"
          ],
          "description": "={{ $fromAI('Description', `Datos importantes del prospecto, como \nEmpresa: \nCargo: \nObjetivo: \nUrgencia: \nVolumen de operaciones: \nHerramientas actuales: \notros datos recopilados del prospecto. `, 'string') }}",
          "summary": "={{ $fromAI('Summary', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        144,
        -432
      ],
      "id": "559fa46a-8258-421d-b38e-8de835e6cfbb",
      "name": "agendar_reunion",
      "retryOnFail": false,
      "waitBetweenTries": 2000,
      "maxTries": 2,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "key": "phone_number",
              "value": "={{ $json.phone_number }}"
            },
            {
              "key": "tipo_mensaje",
              "value": "={{ $json.tipo_mensaje }}"
            },
            {
              "key": "mensaje",
              "value": "={{ $json.mensaje }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -128,
        -1200
      ],
      "id": "92335684-1053-4688-954a-018dca3d1544",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "start": "={{ $json.Start }}",
        "end": "={{ $json.End }}",
        "additionalFields": {
          "attendees": [
            "={{ $json.attendees0_Attendees }}"
          ],
          "description": "={{ $json.Description }}",
          "summary": "={{ $json.Summary }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        304,
        -432
      ],
      "id": "538d375b-57b8-41fb-8a38-c946a1333bf9",
      "name": "Create an event",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38cdad62-0d9c-45bc-860e-9e03d107ba58"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "82df4052-c480-44a2-9d09-c195d4bc6879",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -800,
        -1200
      ],
      "id": "1724dc3d-dd76-4798-8016-cd6a485371b9",
      "name": "type message Whatsap"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -656,
        -1600
      ],
      "id": "bbed1012-2c3a-498d-9c73-1edf481647a6",
      "name": "Download media",
      "webhookId": "9559feee-21a8-4e7f-b6d4-a947041fdc5f",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://speech.googleapis.com/v1/speech:recognize",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"config\": {\n    \"encoding\": \"OGG_OPUS\",\n    \"sampleRateHertz\": 16000,\n    \"languageCode\": \"es-CO\",\n    \"enableAutomaticPunctuation\": true,\n    \"model\": \"telephony\"\n  },\n  \"audio\": {\n    \"content\": \"{{ $json.data }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        16,
        -1600
      ],
      "id": "51a7e36c-7f5d-42d2-b43d-f7cb934b837c",
      "name": "HTTP Request",
      "credentials": {
        "googleOAuth2Api": {
          "id": "9Z0zKL8ENum6cJNe",
          "name": "google-tts"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -432,
        -1600
      ],
      "id": "47935872-d35c-4455-8793-dd1e67ae6ef7",
      "name": "HTTP Request1",
      "credentials": {
        "whatsAppApi": {
          "id": "IzfsUgwJnA4EF09z",
          "name": "whatsap Valeia"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -208,
        -1600
      ],
      "id": "0a10192d-611d-41b0-a0d4-645b32932cf0",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $json.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -544,
        -1200
      ],
      "id": "22ccb7ff-0da4-4687-8f05-d1771a07a7ce",
      "name": "DataText"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('WhatsApp Trigger').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('WhatsApp Trigger').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $json.results[0].alternatives[0].transcript }}",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $('WhatsApp Trigger').item.json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        240,
        -1600
      ],
      "id": "d5632891-b569-41b7-a378-2ae9ab52c83b",
      "name": "DataAudio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f4f107ad-f4e3-4616-a1ec-515f7324ba23",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "6f55c6f4-4cb3-4cec-9d31-b956d3fffde0",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "bad14eb8-f005-4d91-bd83-600e6105d974",
              "name": "mensaje",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -352,
        -1200
      ],
      "id": "9519ce37-6a53-467d-94b1-a180843f5965",
      "name": "setData"
    }
  ],
  "pinData": {},
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Formbricks": {}
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-07-28T21:26:38.117Z",
  "versionId": "f05b6a62-0612-41e6-9f38-36193b944cec"
}