{
  "active": false,
  "connections": {
    "AI Agent": {
      "main": [
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait11": {
      "main": [
        [
          {
            "node": "If13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait12": {
      "main": [
        [
          {
            "node": "If12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If12": {
      "main": [
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If13": {
      "main": [
        [
          {
            "node": "Send message4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait13": {
      "main": [
        [
          {
            "node": "If14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If14": {
      "main": [
        [
          {
            "node": "Send message2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        []
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "Wait11",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait12",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait13",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "consultar_disponibilidad": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consultar_eventos_dia": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agendar_reunion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ],
      "main": [
        [
          {
            "node": "Create an event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media2": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "DataImage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataImage": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media3": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "DataPdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataPdf": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Unir Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Message": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Push Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setData": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "type message Whatsap": {
      "main": [
        [
          {
            "node": "Download media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download media3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download media2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataText": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing2": {
      "main": [
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing3": {
      "main": [
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing4": {
      "main": [
        [
          {
            "node": "DataText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataAudio": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "DataAudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataText1": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing": {
      "main": [
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing5": {
      "main": [
        [
          {
            "node": "No Operation, do nothing6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing6": {
      "main": [
        [
          {
            "node": "DataText1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Mensajes": {
      "main": [
        [
          {
            "node": "Redis5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "whatsap trigger": {
      "main": [
        [
          {
            "node": "whatsappData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "whatsappData": {
      "main": [
        [
          {
            "node": "type message Whatsap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-24T21:21:23.293Z",
  "id": "sKzNc20JLw3iUlTc",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "messages Whatsap",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "=mensaje del usuario: {{ $json.message }},\nnombre: {{ $json.first_name }}",
        "options": {
          "systemMessage": "=\n**[0] CONTEXTO T√âCNICO**\n* **Variable de Entorno:** La fecha y hora actual es `{{ $now }}`. √ösala para coordinar agendamientos.\n* **Plataforma:** Est√°s operando para **Estarter.co**, una empresa l√≠der en soluciones de transporte especial empresarial y de turismo.\n\n---\n\n**[1] MISI√ìN Y ROL CENTRAL**\nEres **EstefanIA**, una **Asesora en Log√≠stica de Movilidad** y el primer punto de contacto estrat√©gico para los prospectos de **Estarter.co**. Tu misi√≥n NO es vender rutas ni veh√≠culos. Tu misi√≥n es **diagnosticar con precisi√≥n si la gesti√≥n de transporte actual de un prospecto le est√° generando sobrecostos, riesgos o fricciones operativas** que nosotros podemos solucionar. \nIMPORTANTE:\nTu misi√≥n NO es vender ni forzar reuniones. Tu misi√≥n es **diagnosticar con precisi√≥n si un prospecto sufre un \"dolor\" operativo que nosotros podemos solucionar**, y si es el momento adecuado para hacerlo. Eres el filtro de calidad que garantiza que nuestro equipo comercial solo invierta tiempo en reuniones con potencial real.\n\n**[2] MI IDENTIDAD Y PERSONALIDAD: LA ESTRATEGA DE MOVILIDAD**\nEsta es tu esencia. Es innegociable.\n\n* **Tono y Trato:** Hablas siempre \"de t√∫\". Eres cercana, emp√°tica y directa, pero mantienes una postura profesional y experta que refleja la calidad y seguridad de Estarter.\n* **Actitud Principal:** **Curiosidad Genuina.** Te fascina entender la log√≠stica de las empresas. Usas frases como *\"Eso que mencionas sobre las rutas es clave, cu√©ntame m√°s\"*, *\"Gracias por compartir eso, me ayuda a tener un mapa claro de su situaci√≥n\"*.\n* **Mentalidad Clave:** **\"Arquitecta\" de Soluciones de Movilidad.** Diagnosticas problemas log√≠sticos, no ofreces un \"servicio de bus\". Si la soluci√≥n del prospecto es funcional y no representa un problema real para ellos, eres la primera en reconocerlo para no forzar una venta. Act√∫as siempre con una postura de igual a igual.\n\n---\n\n**[3] EL MAPA DE CONVERSACI√ìN: METODOLOG√çA SANDLER APLICADA AL TRANSPORTE**\nEste es tu flujo conversacional. Tu inteligencia reside en saber qu√© pregunta hacer para entender el mapa de movilidad del prospecto.\n\n**Fase 1: Conexi√≥n y Contrato Inicial**\n* **Objetivo:** Establecer confianza y definir reglas claras.\n* **Acci√≥n:** Pres√©ntate y prop√≥n un marco de tiempo y un objetivo com√∫n.\n* **Frase de Poder:** *‚ÄúHola [Nombre], ¬øqu√© tal? Soy EstefanIA, de Estarter.co. Ayudamos a empresas a que sus equipos lleguen seguros, a tiempo y sin complicaciones. Para ser s√∫per respetuosa con tu tiempo, ¬øte parece si charlamos 5 minutos? Te hago un par de preguntas sobre su log√≠stica actual y al final, decidimos juntos si tiene sentido explorar una soluci√≥n a medida. ¬øTe parece justo?‚Äù*\n\n**Fase 2: Diagn√≥stico y Embudo de Dolor Log√≠stico**\n* **Objetivo:** Descubrir las fricciones, costos ocultos y riesgos de la operaci√≥n de transporte actual del prospecto.\n* **Acci√≥n:** Utiliza tu \"arsenal de preguntas\" de forma natural para explorar la situaci√≥n.\n\n    * **Arsenal de Preguntas (Herramientas, no guion):**\n        * // *Para abrir y entender la situaci√≥n general:*\n        * \"Para empezar, cu√©ntame un poco, ¬øc√≥mo est√°n gestionando hoy el transporte de sus colaboradores?\"\n        * \"¬øAproximadamente cu√°ntas personas de tu equipo necesitan movilidad de forma regular?\"\n        * \"Actualmente, ¬ølo manejan con una flota propia, con varios proveedores, o cada empleado se gestiona por su cuenta?\"\n\n        * // *Para identificar y profundizar en el DOLOR:*\n        * \"Y esa gesti√≥n actual, ¬øpresenta alg√∫n desaf√≠o? Quiz√°s en temas de puntualidad, seguridad o en la complejidad de la coordinaci√≥n...\"\n        * \"¬øQu√© tan importante es para la productividad y el ambiente laboral que el personal llegue a tiempo y sin estr√©s?\"\n        * \"A nivel administrativo, ¬øcu√°nto tiempo invierte tu equipo en coordinar estas rutas, pagos y proveedores?\"\n        * \"¬øHan tenido alg√∫n incidente o queja de seguridad relacionado con el transporte que usan actualmente?\"\n\n**Fase 3: Calificaci√≥n de Prioridad y Capacidad**\n* **Objetivo:** Entender si resolver los desaf√≠os de movilidad es una prioridad para la empresa en este momento.\n* **Acci√≥n:** Una vez que el dolor es claro, indaga sobre la importancia y el proceso de decisi√≥n.\n\n    * **Arsenal de Preguntas:**\n        * \"Entiendo el reto log√≠stico. ¬øQu√© tan prioritario es para la empresa garantizar una soluci√≥n de transporte m√°s eficiente y segura para su gente?\"\n        * \"Normalmente, la decisi√≥n de contratar un aliado estrat√©gico para el transporte, ¬øen qui√©n recae? ¬øEs una decisi√≥n de Gerencia, RRHH, Log√≠stica?\"\n        * \"Al evaluar un proveedor, ¬øqu√© factores son los m√°s importantes para ustedes? (ej. precio, seguridad, puntualidad, calidad de los veh√≠culos).\"\n\n---\n\n**[4] MATRIZ DE DECISI√ìN: ¬øCOTIZAMOS? (CRITERIOS GO/NO-GO)**\nUsa esta matriz como tu l√≥gica final para decidir si pasas el prospecto al equipo comercial.\n\n* **[LUZ VERDE - AGENDAR] Prospecto CALIFICADO:**\n    * Necesidad de transportar a 10+ colaboradores de forma recurrente.\n    * La gesti√≥n actual presenta fricciones claras (impuntualidad, quejas, complejidad administrativa, riesgos de seguridad).\n    * Valoran la seguridad y la puntualidad como un factor clave para su operaci√≥n.\n    * Est√°n buscando activamente o est√°n abiertos a evaluar un proveedor de transporte profesional.\n    * Es o tiene acceso directo al tomador de decisiones (Gerente General, RRHH, Administrativo o de Log√≠stica).\n\n* **[LUZ ROJA - DESCARTAR AMABLEMENTE] Prospecto NO CALIFICADO:**\n    * Necesidades de transporte muy espor√°dicas o para menos de 10 personas.\n    * Est√°n 100% satisfechos con su soluci√≥n actual y no reportan ning√∫n problema.\n    * El √∫nico factor de decisi√≥n es el precio m√°s bajo del mercado.\n    * **Frase de Cierre Amable:** *\"[Nombre], te agradezco mucho la transparencia. Por lo que me cuentas, parece que su sistema actual les est√° funcionando bien para sus necesidades. Lo valoro mucho. Si en el futuro la operaci√≥n crece o sus prioridades cambian, en Estarter estaremos encantados de ser una opci√≥n. ¬°Que tengas un gran d√≠a!\"*\n\n---\n\n**[5] PROTOCOLO DE AGENDAMIENTO Y RECOPILACI√ìN DE DATOS**\nActiva este protocolo **S√ìLO** despu√©s de una decisi√≥n \"LUZ VERDE\".\n\n* **1. Frase de Transici√≥n:** *\"Basado en lo que me cuentas, especialmente sobre los desaf√≠os de [mencionar el dolor principal: puntualidad, seguridad, coordinaci√≥n], estoy convencida de que nuestro equipo puede dise√±ar una soluci√≥n que les d√© total tranquilidad.\"*\n* **2. Propuesta de Reuni√≥n:** *‚Äú¬øTe parece bien si agendamos una llamada de 15-20 minutos la pr√≥xima semana? El objetivo es que me des m√°s detalles de las rutas y necesidades para que nuestro equipo prepare una cotizaci√≥n a la medida para ti. Sin ning√∫n compromiso.‚Äù*\n* **3. Recopilaci√≥n de Datos (Checklist Final OBLIGATORIO):** *\"¬°Perfecto! Para preparar todo y que la llamada sea s√∫per productiva, solo necesito confirmar un par de datos...\"*\n    * **Contacto:** Nombre completo, Cargo, Email empresarial, Whatsapp de contacto.\n    * **Empresa:** Nombre de la empresa, Sector.\n    * **Log√≠stica:** ¬øHay alguien m√°s que deber√≠a estar en esa llamada?, ¬øqu√© d√≠a y franja horaria te viene mejor?\n\n---\n\n**[6] GESTI√ìN AVANZADA DE OBJECIONES**\n\n* **\"Ya tenemos un proveedor / usamos apps de transporte.\"**\n    * **Tu Respuesta:** *\"Entiendo perfectamente. Y, con total honestidad, ¬øqu√© tal les funciona ese sistema? ¬øEst√°n 100% satisfechos con la puntualidad, la seguridad que le ofrecen a su gente y los costos que manejan?\"* (Esto abre la puerta a encontrar fisuras).\n* **\"Debe ser muy caro.\"**\n    * **Tu Respuesta:** *\"Comprendo que el presupuesto es clave. Curiosamente, muchos de nuestros clientes descubren que al centralizar el transporte con un aliado profesional, reducen costos ocultos (como la impuntualidad, la rotaci√≥n de personal o el tiempo administrativo). ¬øTe gustar√≠a que en una charla r√°pida exploremos si ese podr√≠a ser tu caso?\"*\n* **\"Solo necesito una cotizaci√≥n r√°pida.\"**\n    * **Tu Respuesta:** *\"¬°Claro que s√≠! Y para darte una cotizaci√≥n precisa y no un n√∫mero al aire, necesito entender bien los puntos de origen, destino y horarios. Precisamente para eso es la llamada corta de 15 minutos que te propongo. As√≠ te aseguras de recibir una oferta seria y ajustada a lo que realmente necesitas. ¬øTe parece?\"*\n\n---\n\n**[7] L√çMITES Y REGLAS DE ORO INQUEBRANTABLES**\n\n* **NUNCA** des precios o tarifas por chat. Tu frase es: *\"Para darte un precio justo y preciso, necesitamos entender las rutas, horarios y el tipo de veh√≠culo ideal para ustedes. Esos detalles los vemos en la llamada de cotizaci√≥n.\"*\n* **NUNCA** agendes una llamada si un prospecto no est√° calificado. Tu lealtad es con la calidad y el tiempo de tu equipo comercial.\n* **SIEMPRE** s√© due√±a de la conversaci√≥n, guiando con preguntas expertas.\n* **SIEMPRE** finaliza con un siguiente paso claro y definido."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -208,
        -656
      ],
      "id": "ec887205-85b7-4526-8d85-09b69b6a0d16",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $json.message.content }}",
              "type": "string"
            },
            {
              "id": "f312aa42-4354-4954-92ff-9549a49c1d5b",
              "name": "user_id",
              "value": "={{ $('setData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "4e6ed31c-2d8f-4415-bdaf-404a870f1cc2",
              "name": "first_name",
              "value": "={{ $('setData').item.json.nombre.split(\" \")[0] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -592,
        -656
      ],
      "id": "12f6c162-0fb8-4c11-8b16-a40fe2b9eba1",
      "name": "Data"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=chat_id_{{ $('Data').item.json.user_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1824,
        -1536
      ],
      "id": "fc0d7511-4df6-4cfc-9db4-a9de19f80757",
      "name": "Redis5",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        80,
        -64
      ],
      "id": "bb2deab4-a37e-4f4f-9f7b-a5eb7524dcfd",
      "name": "Wait11",
      "webhookId": "1a2d667d-1b88-4432-a605-5e5c482bf3b4"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        112
      ],
      "id": "6bdf8598-3e2c-4a1f-9287-afb99d554b7b",
      "name": "Wait12",
      "webhookId": "c61553f0-2333-4fa3-9915-d2dfaf92dd97"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte3}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -144,
        112
      ],
      "id": "9b3e0511-6b83-4202-8e8a-eab4d3827ce6",
      "name": "If12"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        272,
        144
      ],
      "id": "8e279c41-a546-46b9-8b51-9de01b000d34",
      "name": "No Operation, do nothing11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "709f4717-003f-4f9f-b841-18d2f2f4ddb4",
              "leftValue": "={{ $json.message.content.parte2}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        256,
        -64
      ],
      "id": "781cb43c-7a8f-4a84-8f17-db70424ee140",
      "name": "If13"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        688,
        -48
      ],
      "id": "38b47b14-b4e9-4f2e-889d-01b0e6c79df7",
      "name": "No Operation, do nothing12"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        336
      ],
      "id": "1696ff62-9fc6-490c-b5cd-4aa2dbc4a9c8",
      "name": "Wait13",
      "webhookId": "559145e6-f3ff-440e-8298-8e384b390615"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte4}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -144,
        336
      ],
      "id": "9b08e4e7-3989-4db5-807a-144858683002",
      "name": "If14"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        272,
        336
      ],
      "id": "0eb96dc8-84e3-4a76-9a56-77642fb267aa",
      "name": "No Operation, do nothing13"
    },
    {
      "parameters": {
        "content": "## AGENT MAIN",
        "height": 600,
        "width": 2240
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1040,
        -768
      ],
      "id": "95a79aea-bf2e-49fe-9bd1-1e1b3a3a453a",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## RESPONS AGENT",
        "height": 600,
        "width": 2264,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1040,
        -112
      ],
      "id": "21535bec-5d47-416e-a57c-808796a08975",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=3chat_history_user_{{ $('setData').item.json.phone_number }}",
        "sessionTTL": 500000,
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        -240,
        -432
      ],
      "id": "6be9ad95-a405-4fc2-9040-5f956c95762e",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Corrige mensajes de usuarios quitando caracteres raros, errores ortogr√°ficos y signos innecesarios como acentos mal puestos, pero sin cambiar el sentido original del mensaje, si llega el mismo mensaje repetido exactamente, varias veces, corriges para que solo envies uno, ",
              "role": "system"
            },
            {
              "content": "=Corrige el siguiente mensaje:\\n\\n{{ $json.message }}\\n\\nDevuelve solo el mensaje corregido"
            }
          ]
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -992,
        -656
      ],
      "id": "1d2f8d57-5968-4d80-9349-007639b87f3b",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte1 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -320,
        -64
      ],
      "id": "cba6c1b7-8d58-4fd7-9afd-e358dfd0388b",
      "name": "Send message",
      "webhookId": "9664ca8b-6cdf-474c-a4c2-07f5e237eae8",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Divide el siguiente mensaje en hasta **4 partes m√°s peque√±as** solo si es necesario, asegur√°ndote de que cada parte tenga sentido completo.  \n\n### **Reglas:**  \n- Si el mensaje es *corto* (hasta *160 caracteres*), devu√©lvelo en **una sola parte**.  \n- Si es *mediano* (hasta *400 caracteres*), div√≠delo en **2 partes**.  \n- Si es *largo* (hasta *600 caracteres*), div√≠delo en **3 partes**. \n- Si es *muy largo* (m√°s de *600 caracteres*), agr√©gale una **parte4**.  \n\n- **Evita dividir el mensaje innecesariamente**. Usa la **menor cantidad de partes posible**.  \n- **No cortes oraciones en puntos, comas o conectores** para mantener la coherencia.  \n- **si hay una lista con varios items, no se debe dividir**, toda la lista debe ir en un mismo mensaje\n\n- **No incluyas datos sensibles del usuario** en la respuesta, como:  \n  - `user_id: <n√∫mero>`  \n  - `subscriber_id: <n√∫mero>`  \n  - `first_name: <nombre>`  \n  - **Elimina estos datos sin dejar rastros.**  \n\n---\n\n### **Formato de Salida:**  \n- Devuelve la respuesta en **formato JSON** con **solo las partes necesarias**.  \n- Usa `\\n\\n` para agregar saltos de l√≠nea cuando sea necesario o para mejorar la legibilidad en listas.  \n- **Nunca uses comillas `\"` para resaltar palabras**. En su lugar, usa un solo asterisco: *palabra*.  \n\n#### **Ejemplo de salida:**  \n\n{\n  \"parte1\": \"Texto de la primera parte.\",\n  \"parte2\": \"Texto de la segunda parte.\"\n}\n\n\n---\n\n### **Mensaje:**  \n{{ $json.output }}  \n\n"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -928,
        -64
      ],
      "id": "a9b7f31a-1c50-45e0-980e-7cf17ae77a5a",
      "name": "Message a model1",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -368,
        -432
      ],
      "id": "3705a551-ed2b-495f-8d09-e6a512f23c3f",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte2 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        464,
        -80
      ],
      "id": "0628d7bf-b3f7-4c23-a530-c3587e9f40b2",
      "name": "Send message4",
      "webhookId": "142e011c-78b9-433c-a631-63863f0aa816",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte3 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        64,
        112
      ],
      "id": "90b30853-26fd-4a8d-b430-126fcc536d36",
      "name": "Send message1",
      "webhookId": "52abe86e-6124-4f7b-a024-c8f7b37b9958",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte4 }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        64,
        304
      ],
      "id": "1cbc6301-3bd2-4ca4-9373-319eaa70c6d6",
      "name": "Send message2",
      "webhookId": "d9f93f21-8ca8-44cb-a8e0-8eab8eccc67f",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        -112,
        -432
      ],
      "id": "3160521c-601f-4e71-bcca-2d43813adf91",
      "name": "consultar_disponibilidad",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "en.co#holiday@group.v.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Holidays in Colombia"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        16,
        -432
      ],
      "id": "b8c7a3c0-2c5d-49ae-91d0-d12410bbd616",
      "name": "consultar_eventos_dia",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "start": "={{ $fromAI('Start', `fecha y hora del inicio de la reunion `, 'string') }}",
        "end": "={{ $fromAI('End', `fecha y hora del final de la reunion, normalmente 30 minutos despues de la fecha de inicio`, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ $fromAI('attendees0_Attendees', `correo electr√≥nico del invitado`, 'string') }}"
          ],
          "description": "={{ $fromAI('Description', `Datos importantes del prospecto, como \nEmpresa: \nCargo: \nObjetivo: \nUrgencia: \nVolumen de operaciones: \nHerramientas actuales: \notros datos recopilados del prospecto. `, 'string') }}",
          "summary": "={{ $fromAI('Summary', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        144,
        -432
      ],
      "id": "559fa46a-8258-421d-b38e-8de835e6cfbb",
      "name": "agendar_reunion",
      "retryOnFail": false,
      "waitBetweenTries": 2000,
      "maxTries": 2,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "start": "={{ $json.Start }}",
        "end": "={{ $json.End }}",
        "additionalFields": {
          "attendees": [
            "={{ $json.attendees0_Attendees }}"
          ],
          "description": "={{ $json.Description }}",
          "summary": "={{ $json.Summary }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        304,
        -432
      ],
      "id": "538d375b-57b8-41fb-8a38-c946a1333bf9",
      "name": "Create an event",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "ZzftNjdS2XERKRri",
          "name": "Calendar Pedro"
        }
      }
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('Start').item.json.messages[0].image.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -640,
        -1056
      ],
      "id": "981c4c87-852e-468e-bc7e-04e1f213cb48",
      "name": "Download media2",
      "webhookId": "9559feee-21a8-4e7f-b6d4-a947041fdc5f",
      "credentials": {
        "whatsAppApi": {
          "id": "vxdq4Km4pHfuOQVV",
          "name": "MONY"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "=Act√∫a como un contador p√∫blico certificado experto en Colombia, con amplios conocimientos tributarios y financieros en Am√©rica Latina. Tambi√©n eres un ingeniero experto en prompts y an√°lisis OCR. Tu tarea es analizar de forma precisa y estructurada la imagen proporcionada (comprobante, recibo, factura, voucher, etc.) y extraer la siguiente informaci√≥n en formato JSON, validando cada campo cuidadosamente:\n\n1. **Tipo de Documento**: (Ej: Factura POS, Factura Electr√≥nica, Recibo de Caja, Voucher, Cuenta de Cobro, etc.)\n2. **Fecha del Comprobante**: en formato `dd-mm-yyyy`. (Validar que no est√© incompleta o ausente).\n3. **Monto Total**: En pesos colombianos (COP). Usar solo valores totales (ignorar subtotales).\n4. **Glosa / Descripci√≥n**: Breve texto explicando de qu√© trata el gasto o ingreso (Ej: \"Compra de v√≠veres\", \"Pago de arriendo\", etc.)\n5. **Proveedor o Comercio**: Nombre del establecimiento donde se hizo la transacci√≥n.\n6. **NIT o Documento Tributario**: Detecta y extrae el NIT del proveedor. Si no existe NIT, intenta identificar c√©dula o alg√∫n documento oficial. Si no se encuentra, informar que no hay documento tributario.\n7. **M√©todo de Pago**: Detectar si fue con Efectivo, Tarjeta de Cr√©dito, Tarjeta de D√©bito, Transferencia, Nequi, Daviplata, etc. (En caso de duda, indicar \"No especificado\").\n8. **Categor√≠a sugerida** (opcional): Prop√≥n una categor√≠a financiera general (Ej: Alimentaci√≥n, Transporte, Servicios, Arriendo, etc.).\n9. **Ingreso o Gasto**: Detectar si el documento corresponde a un **Ingreso** o un **Gasto**, basado en contexto, glosa y encabezados.\n\nAdem√°s, incluye al final una breve descripci√≥n en lenguaje natural del tipo de imagen analizada. Por ejemplo: ‚ÄúSe trata de un recibo POS con fecha clara y valor total, pero no se detecta NIT.‚Äù o ‚ÄúFactura electr√≥nica v√°lida con todos los campos presentes‚Äù.\n\nüîé Si falta alguno de los datos obligatorios (como fecha, monto), ind√≠calo expl√≠citamente con el mensaje `\"error\": \"Campo faltante: ...\"` o `\"advertencia\": \"No se detect√≥ la fecha del documento \"`.\n\nTu respuesta debe estar en formato JSON estructurado y f√°cil de procesar por un sistema automatizado.\n",
        "inputType": "base64",
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -192,
        -1056
      ],
      "id": "648df1cf-234f-4512-abab-16ca9285f636",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -416,
        -1056
      ],
      "id": "53cafb12-a76e-4934-b8b7-47de7e8ad56a",
      "name": "HTTP Request",
      "credentials": {
        "whatsAppApi": {
          "id": "vxdq4Km4pHfuOQVV",
          "name": "MONY"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('Start').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('Start').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<img>{{ $json.choices[0].message.content }}</img>",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $('Start').item.json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        32,
        -1056
      ],
      "id": "a0daacad-bcd0-408c-9a37-5ee662b77a42",
      "name": "DataImage"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1600,
        -1344
      ],
      "id": "3d484f61-1971-4c12-9957-c07f991ac834",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('Start').item.json.messages[0].document.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -640,
        -1248
      ],
      "id": "4a91dc2f-c6bf-4693-84bd-75dd303a5dc4",
      "name": "Download media3",
      "webhookId": "9559feee-21a8-4e7f-b6d4-a947041fdc5f",
      "credentials": {
        "whatsAppApi": {
          "id": "vxdq4Km4pHfuOQVV",
          "name": "MONY"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -416,
        -1248
      ],
      "id": "56f2c509-c239-4c05-b981-15114a7a87ef",
      "name": "HTTP Request3",
      "credentials": {
        "whatsAppApi": {
          "id": "vxdq4Km4pHfuOQVV",
          "name": "MONY"
        }
      }
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -192,
        -1248
      ],
      "id": "2f6bdbca-3f40-47b3-97f8-c4022dc81c63",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('Start').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('Start').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<pdf>{{ $json.text }}</pdf>",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $('Start').item.json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        32,
        -1248
      ],
      "id": "76463a3a-8c5e-4cf8-9fd2-997084ef1152",
      "name": "DataPdf"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7fe6665-ef0d-4ec2-9800-88004951e528",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('setData').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1376,
        -1440
      ],
      "id": "3ca55f40-84f4-4aa2-b4e6-93306f217bb5",
      "name": "If1"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "=chat_id_{{ $json.phone_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1152,
        -1440
      ],
      "id": "a15ed584-0e77-4ee5-97b9-2996c200cf18",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        928,
        -1440
      ],
      "id": "da3f9f39-84bf-4c33-9cf6-c8d688d82000",
      "name": "Wait",
      "webhookId": "c42fd9d6-416c-4950-8662-76e241fbd897"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=chat_id_{{ $json.phone_number }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        704,
        -1440
      ],
      "id": "294fc18b-8b5a-4bc5-84ad-1741229089ad",
      "name": "Push Message",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "key": "phone_number",
              "value": "={{ $json.phone_number }}"
            },
            {
              "key": "tipo_mensaje",
              "value": "={{ $json.tipo_mensaje }}"
            },
            {
              "key": "mensaje",
              "value": "={{ $json.mensaje }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        480,
        -1440
      ],
      "id": "b1f060ca-dae3-414e-b4c2-2b23aaad710f",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f4f107ad-f4e3-4616-a1ec-515f7324ba23",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "6f55c6f4-4cb3-4cec-9d31-b956d3fffde0",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "bad14eb8-f005-4d91-bd83-600e6105d974",
              "name": "mensaje",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            },
            {
              "id": "d4a104fc-db17-404b-aa9b-e8014ee283d0",
              "name": "usuario_data",
              "value": "={{ $('Start').item.json.usuario_data }}",
              "type": "object"
            },
            {
              "id": "0dbf888e-59e9-4096-ad72-6d0a053a5acb",
              "name": "redis_message",
              "value": "=chat_id_{{ $json.phone_number }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        256,
        -1440
      ],
      "id": "aa737f92-d342-4705-b172-b7e376bceab4",
      "name": "setData"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38cdad62-0d9c-45bc-860e-9e03d107ba58"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "82df4052-c480-44a2-9d09-c195d4bc6879",
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8713f778-dafe-4a52-916e-0289f4e7faad",
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "reaction",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reaction"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d9c1a8cf-af4e-4bca-a66c-184829c009d8",
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "document"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "71778507-22f2-4e0f-99d7-fdd87ed1f26b",
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -976,
        -1488
      ],
      "id": "70bff7b6-4f7b-41cd-a8d5-e62397ef10af",
      "name": "type message Whatsap"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $('Redis').item.json.message.join('\\n').replace(/test/gi, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1600,
        -1536
      ],
      "id": "6ce4d600-5243-400c-a6f8-cead94193ca3",
      "name": "Unir Mensajes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('Start').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('Start').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $('Start').item.json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        32,
        -1632
      ],
      "id": "ded0031f-3ee4-4f67-abb0-60fbe83ef08d",
      "name": "DataText"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -640,
        -1632
      ],
      "id": "812b3153-0084-4af4-a813-6ca8c54cdd38",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -416,
        -1632
      ],
      "id": "0c8dacda-f172-4960-bded-f977d71d7ffc",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -192,
        -1632
      ],
      "id": "89f788dd-d68a-40c1-8eaf-5462ff015080",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('Start').item.json.messages[0].audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -640,
        -1824
      ],
      "id": "d527309f-34a6-4c85-b810-6b3a1ea31f12",
      "name": "Download media",
      "webhookId": "9559feee-21a8-4e7f-b6d4-a947041fdc5f",
      "credentials": {
        "whatsAppApi": {
          "id": "vxdq4Km4pHfuOQVV",
          "name": "MONY"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -416,
        -1824
      ],
      "id": "313185ba-aee5-40ed-8c11-db8a5069a1c6",
      "name": "HTTP Request1",
      "credentials": {
        "whatsAppApi": {
          "id": "IzfsUgwJnA4EF09z",
          "name": "whatsap Valeia"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('Start').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('Start').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<audio>{{ $json.content.parts[0].text }}</audio>",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $('Start').item.json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        32,
        -1824
      ],
      "id": "07ab4d74-e520-4eaf-8ee2-eeccbc63f211",
      "name": "DataAudio"
    },
    {
      "parameters": {
        "content": "## Incoming Messages\n",
        "height": 764,
        "width": 2912,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1040,
        -1664
      ],
      "id": "183d1e7f-5436-4546-afc7-632d69569ee9",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -192,
        -1824
      ],
      "id": "b97d9fb6-a9d8-428f-861d-bf234b26080e",
      "name": "Transcribe a recording",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('Start').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('Start').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $json.messages[0].reaction.emoji }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        32,
        -1440
      ],
      "id": "ebe4d850-f234-472a-9570-e51aac8fe987",
      "name": "DataText1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -640,
        -1440
      ],
      "id": "0c79f5f6-3543-40fe-8faa-01efd5bbc08b",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -416,
        -1440
      ],
      "id": "85b8dfdd-91c6-4928-b2a6-3ce30353367d",
      "name": "No Operation, do nothing5"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -192,
        -1440
      ],
      "id": "a93cd403-5587-4850-9c45-92037848ec41",
      "name": "No Operation, do nothing6"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsap",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1440,
        -1568
      ],
      "id": "810a0c94-bc0b-4560-adb6-712fc3e654a5",
      "name": "whatsap trigger",
      "webhookId": "6704f599-c49e-4dd2-848c-7d9401baf9a1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7fba40fd-13ea-470a-a784-d886fa69b736",
              "name": "account_id",
              "value": "={{ $json.metadata.display_phone_number }}",
              "type": "string"
            },
            {
              "id": "cb120617-0a0f-4b8d-8979-909001725c0d",
              "name": "phone_number_id",
              "value": "={{ $json.metadata.phone_number_id }}",
              "type": "string"
            },
            {
              "id": "5276d674-1b57-4af7-88f3-5f9616e64cc3",
              "name": "nombre",
              "value": "={{ $json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "92d97526-26b7-461c-b7ec-7cd13074512e",
              "name": "phone_number",
              "value": "={{ $json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "0605a012-1740-4b13-8e7f-57e156ad2fbe",
              "name": "mensaje",
              "value": "={{ $json.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "5060779d-87fc-49af-9212-c7972aae9ff0",
              "name": "tipo_mensaje",
              "value": "={{ $json.messages[0].type }}",
              "type": "string"
            },
            {
              "id": "358f4697-0d6f-4184-bfbd-31ff4f2e2ac2",
              "name": "tags",
              "value": "={{ $json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1248,
        -1536
      ],
      "id": "c59b8dd0-d7e3-413c-8a1e-b5c1ff7638e6",
      "name": "whatsappData"
    }
  ],
  "pinData": {
    "whatsap trigger": [
      {
        "json": {
          "messaging_product": "whatsapp",
          "metadata": {
            "display_phone_number": "573143400476",
            "phone_number_id": "735679592965149"
          },
          "contacts": [
            {
              "profile": {
                "name": "Pedro Rodriguez"
              },
              "wa_id": "573228854498"
            }
          ],
          "messages": [
            {
              "from": "573228854498",
              "id": "wamid.HBgMNTczMjI4ODU0NDk4FQIAEhgUM0ZCOUNFRjE5M0FFNzZENzAxQUEA",
              "timestamp": "1755298718",
              "text": {
                "body": "organizar gastos"
              },
              "type": "text"
            }
          ],
          "field": "messages"
        }
      }
    ]
  },
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Formbricks": {}
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-08-16T22:08:01.874Z",
  "versionId": "8417d87a-a34d-42c7-b6cd-e0ee4f7ad71a"
}