{
  "active": false,
  "connections": {
    "If": {
      "main": [
        [
          {
            "node": "Unir Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Get Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data1": {
      "main": [
        [
          {
            "node": "Push Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "type message Whatsap1": {
      "main": [
        [
          {
            "node": "Download media1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media1": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Model Selector1": {
      "ai_languageModel": [
        []
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Model Selector1",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "No Operation, do nothing5": {
      "main": [
        [
          {
            "node": "No Operation, do nothing6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing6": {
      "main": [
        [
          {
            "node": "No Operation, do nothing7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing7": {
      "main": [
        [
          {
            "node": "DataText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait14": {
      "main": [
        [
          {
            "node": "If16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait15": {
      "main": [
        [
          {
            "node": "If15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If15": {
      "main": [
        [
          {
            "node": "Send message6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If16": {
      "main": [
        [
          {
            "node": "Send message5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait16": {
      "main": [
        [
          {
            "node": "If17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If17": {
      "main": [
        [
          {
            "node": "Send message7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Message a model2": {
      "main": [
        [
          {
            "node": "Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message3": {
      "main": [
        [
          {
            "node": "Redis6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model3": {
      "main": [
        [
          {
            "node": "Wait14",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait15",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait16",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start": {
      "main": [
        [
          {
            "node": "type message Whatsap1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Message": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Message": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataAudio": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataText": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setData": {
      "main": [
        [
          {
            "node": "Execution Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Mensajes": {
      "main": [
        [
          {
            "node": "Message a model2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Message a model3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "DataAudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create_saving_goal": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-29T16:34:51.978Z",
  "id": "S9SCJIr4UmSrDNAM",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Onboarding",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2704,
        5456
      ],
      "id": "d47ab38a-aed8-49fe-9fce-82b61fd79db8",
      "name": "Wait16",
      "webhookId": "559145e6-f3ff-440e-8298-8e384b390615"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte4}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3136,
        5456
      ],
      "id": "3b61fcf8-9f47-4a49-a8cb-122089ac3e93",
      "name": "If17"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3552,
        5456
      ],
      "id": "facce6c6-e623-431c-9c21-68c5968a9a67",
      "name": "No Operation, do nothing16"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('Start').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte4 }}",
        "additionalFields": {
          "previewUrl": true
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        3344,
        5424
      ],
      "id": "0a6f2bcd-5748-40de-8de3-a5ff28569e5b",
      "name": "Send message7",
      "webhookId": "d9f93f21-8ca8-44cb-a8e0-8eab8eccc67f",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3552,
        5264
      ],
      "id": "60bed6c1-0bb5-47a2-9657-4dec62a703c8",
      "name": "No Operation, do nothing14"
    },
    {
      "parameters": {
        "amount": 4
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2704,
        5232
      ],
      "id": "53afb401-c50a-4ee7-9613-e0d543148607",
      "name": "Wait15",
      "webhookId": "c61553f0-2333-4fa3-9915-d2dfaf92dd97"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte3}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3136,
        5232
      ],
      "id": "dc76ad3e-1ffa-47e6-bbf7-ad787c013f6e",
      "name": "If15"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('Start').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte3 }}",
        "additionalFields": {
          "previewUrl": true
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        3344,
        5232
      ],
      "id": "5266eb12-7c26-4e58-92bc-979face5780f",
      "name": "Send message6",
      "webhookId": "52abe86e-6124-4f7b-a024-c8f7b37b9958",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3968,
        5072
      ],
      "id": "19d817e4-8f39-469a-b0e6-c1fa0dc0f12d",
      "name": "No Operation, do nothing15"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=chat_id_{{ $('Data').item.json.user_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3136,
        5056
      ],
      "id": "955102bd-9aca-40f6-ad48-f64c33a75f53",
      "name": "Redis6",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3360,
        5056
      ],
      "id": "2585eadb-2142-4149-aa9b-eb2d4560c010",
      "name": "Wait14",
      "webhookId": "1a2d667d-1b88-4432-a605-5e5c482bf3b4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "709f4717-003f-4f9f-b841-18d2f2f4ddb4",
              "leftValue": "={{ $json.message.content.parte2}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3536,
        5056
      ],
      "id": "4f0ded46-b794-480f-ae92-112ae0319350",
      "name": "If16"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('Start').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte1 }}",
        "additionalFields": {
          "previewUrl": true
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        2752,
        5056
      ],
      "id": "99d2bcf0-d751-42c9-8dac-25e2bf6bfda6",
      "name": "Send message3",
      "webhookId": "9664ca8b-6cdf-474c-a4c2-07f5e237eae8",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=\nDivide el siguiente mensaje en hasta *4 partes mÃ¡s pequeÃ±as* solo si es necesario, asegurÃ¡ndote de que cada parte tenga sentido completo.\n\n### *Reglas:*\n\n- Si el mensaje es *corto* (hasta *160 caracteres*), devuÃ©lvelo en *una sola parte*.\n\n- Si es *mediano* (hasta *400 caracteres*), divÃ­delo en *2 partes*.\n\n- Si es *largo* (hasta *600 caracteres*), divÃ­delo en *3 partes*.\n\n- Si es *muy largo* (mÃ¡s de *600 caracteres*), agrÃ©gale una *parte4*.\n\n- *Evita dividir el mensaje innecesariamente*. Usa la *menor cantidad de partes posible*.\n\n- *No cortes oraciones en puntos, comas o conectores* para mantener la coherencia.\n\n- *Si hay una lista con varios Ã­tems, no se debe dividir*, toda la lista debe ir en un mismo mensaje.\n\n- *No incluyas datos sensibles del usuario* en la respuesta, como:\n\n  - `user_id: <nÃºmero>`\n  - `subscriber_id: <nÃºmero>`\n  - `first_name: <nombre>`\n  - *Elimina estos datos sin dejar rastros.*\n\n- *Si no hay mensaje, no devuelvas nada.*\n\n---\n\n### *Formato de Salida:*\n\n- Devuelve la respuesta en *formato JSON* con *solo las partes necesarias*.\n- Usa `\\n\\n` para agregar saltos de lÃ­nea cuando sea necesario o para mejorar la legibilidad en listas.\n- *Nunca uses comillas `\"` para resaltar palabras*. En su lugar, usa un solo asterisco: *palabra*.\n\n#### *Ejemplo de salida:*\n\n{\n\"parte1\": \"Texto de la primera parte.\",\n\"parte2\": \"Texto de la segunda parte.\"\n}\n\n### *Mensaje:*\n\n\"{{ $json.output }}\"\n"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2144,
        5056
      ],
      "id": "f2a48547-e963-4e37-a581-03552e013673",
      "name": "Message a model3",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('Start').item.json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $('Data').item.json.user_id }}",
        "textBody": "={{ $json.message.content.parte2 }}",
        "additionalFields": {
          "previewUrl": true
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        3744,
        5040
      ],
      "id": "db58d370-06e9-410b-8f21-5756ae9beee6",
      "name": "Send message5",
      "webhookId": "142e011c-78b9-433c-a631-63863f0aa816",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "content": "## RESPONS AGENT",
        "height": 760,
        "width": 2264,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2064,
        4928
      ],
      "id": "43d62a15-97c3-4ddf-bf15-faf0105c19dd",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2800,
        4368
      ],
      "id": "26e4d07f-1e5e-4d0f-a8c8-701251180fb0",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2416,
        4560
      ],
      "id": "b9b08c95-c551-472e-936b-7a5a5aade42b",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=chat_history_mony_{{ $('setData').item.json.phone_number }}",
        "sessionTTL": 500000,
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        2912,
        4384
      ],
      "id": "0ce44752-1235-4d87-baba-8d9f8f68c13e",
      "name": "Redis Chat Memory1",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "rule": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "887218c3-c47e-4f19-9d76-2eaf22ae77bf",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.modelSelector",
      "typeVersion": 1,
      "position": [
        2336,
        4384
      ],
      "id": "e3a4c071-aa81-4b55-9cf3-ab259bd109df",
      "name": "Model Selector1"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Corrige mensajes de usuarios quitando caracteres raros, errores ortogrÃ¡ficos y signos innecesarios como acentos mal puestos, pero sin cambiar el sentido original del mensaje, si llega el mismo mensaje repetido exactamente, varias veces, corriges para que solo envies uno, ",
              "role": "system"
            },
            {
              "content": "=Corrige el siguiente mensaje:\\n\\n{{ $json.message }}\\n\\nDevuelve solo el mensaje corregido, no quites las etiquetas html"
            }
          ]
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2096,
        4144
      ],
      "id": "881b5686-6ee6-47ed-a61d-87bccf6c4d16",
      "name": "Message a model2",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "## AGENT MAIN",
        "height": 600,
        "width": 2240
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2048,
        4096
      ],
      "id": "c4230e06-3ccf-471a-80fe-b877c5d66e4a",
      "name": "Sticky Note4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4544,
        3392
      ],
      "id": "ea686747-cd07-48a7-858e-80f36d629675",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7fe6665-ef0d-4ec2-9800-88004951e528",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('setData').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4320,
        3296
      ],
      "id": "f842bdfd-7e03-40d5-a409-a96eb136634a",
      "name": "If"
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3872,
        3296
      ],
      "id": "66123173-b1bc-4c75-8b39-f0ebf5aaa426",
      "name": "Wait1",
      "webhookId": "c42fd9d6-416c-4950-8662-76e241fbd897"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "key": "phone_number",
              "value": "={{ $json.phone_number }}"
            },
            {
              "key": "tipo_mensaje",
              "value": "={{ $json.tipo_mensaje }}"
            },
            {
              "key": "mensaje",
              "value": "={{ $json.mensaje }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        3424,
        3296
      ],
      "id": "0529c879-93a6-4ba0-bbdf-359ca7fb48c3",
      "name": "Execution Data1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38cdad62-0d9c-45bc-860e-9e03d107ba58"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "82df4052-c480-44a2-9d09-c195d4bc6879",
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d9c1a8cf-af4e-4bca-a66c-184829c009d8",
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "document"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "71778507-22f2-4e0f-99d7-fdd87ed1f26b",
                    "leftValue": "={{ $('Start').item.json.messages[0].type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2080,
        3456
      ],
      "id": "96e3e6fc-a861-4b7a-b3ad-691d3c404f4f",
      "name": "type message Whatsap1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2304,
        3392
      ],
      "id": "368ec7f1-f4e9-41f5-bab7-737a1445e60c",
      "name": "No Operation, do nothing5"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2528,
        3392
      ],
      "id": "73109488-f6eb-47af-b9dd-22847245d052",
      "name": "No Operation, do nothing6"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2752,
        3392
      ],
      "id": "4ec9ba3b-a1e0-435f-b5b4-f8f13535411f",
      "name": "No Operation, do nothing7"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('Start').item.json.messages[0].audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        2304,
        3200
      ],
      "id": "3cba0cb6-0baa-48d9-ad8a-d29a3d94818e",
      "name": "Download media1",
      "webhookId": "9559feee-21a8-4e7f-b6d4-a947041fdc5f",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2528,
        3200
      ],
      "id": "62fdd47e-185c-44bf-8a2c-3310c8c7ce94",
      "name": "HTTP Request4",
      "credentials": {
        "whatsAppApi": {
          "id": "IzfsUgwJnA4EF09z",
          "name": "whatsap Valeia"
        }
      }
    },
    {
      "parameters": {
        "content": "## Incoming Messages\n",
        "height": 764,
        "width": 2912,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2032,
        3168
      ],
      "id": "cb14ce5c-a33f-42c1-bf63-5008b59dc7c8",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "metadata",
              "type": "any"
            },
            {
              "name": "contacts",
              "type": "any"
            },
            {
              "name": "messages",
              "type": "any"
            },
            {
              "name": "field",
              "type": "any"
            },
            {
              "name": "usuario_data",
              "type": "any"
            }
          ]
        }
      },
      "id": "649b0691-83c5-4b7f-a944-f90df1943348",
      "typeVersion": 1.1,
      "name": "Start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        1712,
        3488
      ]
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=chat_id_mony{{ $json.phone_number }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3648,
        3296
      ],
      "id": "c1c55121-e1be-4fab-a202-320bf3c22372",
      "name": "Push Message",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "=chat_id_mony{{ $json.phone_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        4096,
        3296
      ],
      "id": "2079ccee-b715-4ae6-9631-08cde04f7e84",
      "name": "Get Message",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $json.contacts[0].wa_id }}",
        "textBody": "=ðŸ“„ Â¡ Gracias por enviarnos tu documento.\nSin embargo, para poder procesarlo y ayudarte con el anÃ¡lisis, primero necesitas estar registrado en **MONY**.\nEsto nos permite guardar tu informaciÃ³n de forma segura y ofrecerte una experiencia personalizada. ðŸ§ âœ¨\n\nðŸ‘‰ Puedes registrarte en menos de 1 minuto aquÃ­:\n*https://mony-app.com/registro*\n\nUna vez estÃ©s dentro, Â¡estaremos listos para ayudarte a organizar tus finanzas como un pro! ðŸ’¸ðŸš€",
        "additionalFields": {
          "previewUrl": true
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        2304,
        3584
      ],
      "id": "3e0155d4-3ef7-40fa-a7d7-f8a32401667b",
      "name": "Send message",
      "webhookId": "9664ca8b-6cdf-474c-a4c2-07f5e237eae8",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "=+{{ $json.contacts[0].wa_id }}",
        "textBody": "=ðŸ“„ Â¡ Gracias por enviarnos tu imagen.\nSin embargo, para poder procesarlo y ayudarte con el anÃ¡lisis, primero necesitas estar registrado en **MONY**.\nEsto nos permite guardar tu informaciÃ³n de forma segura y ofrecerte una experiencia personalizada. ðŸ§ âœ¨\n\nðŸ‘‰ Puedes registrarte en menos de 1 minuto aquÃ­:\n*https://mony-app.com/registro*\n\nUna vez estÃ©s dentro, Â¡estaremos listos para ayudarte a organizar tus finanzas como un pro! ðŸ’¸ðŸš€",
        "additionalFields": {
          "previewUrl": true
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        2304,
        3760
      ],
      "id": "3b71e39d-45b8-4733-b08a-11add79fb14d",
      "name": "Send message1",
      "webhookId": "9664ca8b-6cdf-474c-a4c2-07f5e237eae8",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('Start').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('Start').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<audio>{{ $json.text }}</audio>",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $('Start').item.json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2976,
        3200
      ],
      "id": "65742d6f-b806-4166-8cd9-163700964d6c",
      "name": "DataAudio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $json.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2976,
        3392
      ],
      "id": "94e29072-c224-4c0f-8dd1-1703ae0a975e",
      "name": "DataText"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f4f107ad-f4e3-4616-a1ec-515f7324ba23",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "6f55c6f4-4cb3-4cec-9d31-b956d3fffde0",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "bad14eb8-f005-4d91-bd83-600e6105d974",
              "name": "mensaje",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3200,
        3296
      ],
      "id": "d04e4f61-cc94-4168-9dbe-3351194a5f77",
      "name": "setData"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $('Get Message').item.json.message.join('\\n').replace(/test/gi, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4544,
        3200
      ],
      "id": "3e1aa6f4-7a79-405a-b1ee-6d3c94a2a18d",
      "name": "Unir Mensajes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $json.message.content }}",
              "type": "string"
            },
            {
              "id": "f312aa42-4354-4954-92ff-9549a49c1d5b",
              "name": "user_id",
              "value": "={{ $('setData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "4e6ed31c-2d8f-4415-bdaf-404a870f1cc2",
              "name": "first_name",
              "value": "={{ $('setData').item.json.nombre.split(\" \")[0] }}",
              "type": "string"
            },
            {
              "id": "cf253614-3663-4a7d-9db1-a657bb6ab67e",
              "name": "usuario_data",
              "value": "={{ $('Start').item.json.usuario_data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2496,
        4144
      ],
      "id": "4a3fde48-d04e-4352-8617-253c0fce9df5",
      "name": "Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=nombre: {{ $json.first_name }},\nmensaje del usuario: {{ $json.message }},",
        "options": {
          "systemMessage": "=### *1. ROL Y OBJETIVO PRINCIPAL*\n\n- ActÃºa como \"Mony Onboarding Expert\",- el asistente virtual oficial de MONY. Tu *misiÃ³n principal* - es recibir a los usuarios que llegan por primera vez a nuestro WhatsApp, enamorarlos de nuestra plataforma, resolver todas sus dudas y guiarlos con entusiasmo para que completen su registro en nuestra pÃ¡gina web. Eres la primera impresiÃ³n de MONY, por lo que tu amabilidad, claridad y proactividad son clave.\n\n### *2. PERSONA Y TONO DE COMUNICACIÃ“N*\n\n- *Amigable y Cercano:- Usa un tono conversacional y cÃ¡lido. Emplea emojis para hacer la conversaciÃ³n mÃ¡s amena (ðŸ‘‹, âœ¨, ðŸš€, ðŸ’°, âœ…). Tutea al usuario.\n- *Servicial y Paciente:- Tu disposiciÃ³n a ayudar es total. Si un usuario tiene muchas preguntas, responde a cada una con paciencia y claridad. Nunca te muestres apurado.\n- *Experto y Confiable:- Debes conocer MONY a la perfecciÃ³n. Habla con seguridad sobre las funcionalidades, beneficios y planes. Transmite confianza y profesionalismo.\n- *Entusiasta y Motivador:- Muestra pasiÃ³n por cÃ³mo MONY puede transformar las finanzas personales del usuario. AnÃ­male a tomar el control de su dinero.\n\n### *3. BASE DE CONOCIMIENTO (Tu Cerebro)*\n\nToda tu informaciÃ³n se basa *exclusivamente- en el siguiente contexto sobre MONY. No inventes funcionalidades ni precios.\n\n- *Producto:- MONY es un asistente financiero personal que funciona principalmente por WhatsApp para registrar gastos e ingresos de forma fÃ¡cil y rÃ¡pida.\n- *Flujo Principal:*\n    1.  *Registras todo por WhatsApp:- EnvÃ­as un texto (\"gastÃ© 50.000 en gasolina\"), un audio, una foto de una factura o un archivo.\n    2.  *MONY lo procesa con IA:- Clasifica automÃ¡ticamente tus movimientos.\n    3.  *Visualizas en un Dashboard Web:- Analizas tus finanzas con grÃ¡ficos, resÃºmenes y reportes detallados.\n- *Beneficios Clave:*\n    - Tomar el control de tus finanzas de forma sencilla.\n    - Ahorrar tiempo registrando todo al instante.\n    - Detectar patrones, gastos excesivos y oportunidades de ahorro.\n    - Recibir recordatorios de pagos y suscripciones.\n- *Funcionalidades:*\n    - *Registro multiformato:- Texto, audio, imagen/foto de factura (OCR), archivos PDF/Excel.\n    - *Dashboard Web:- Con grÃ¡ficos de evoluciÃ³n financiera, distribuciÃ³n de gastos por categorÃ­a y listado de transacciones.\n    - *CategorizaciÃ³n IA:- El sistema aprende y clasifica tus gastos.\n    - *Recordatorios:- Para que no olvides registrar tus movimientos.\n- *Modelo de MonetizaciÃ³n (Planes):*\n    - *Plan Free ($0):- Registro bÃ¡sico y limitado vÃ­a WhatsApp. Ideal para probar.\n    - *Plan Premium ($9.99/mes):- Â¡La experiencia completa! Dashboard web con todos los grÃ¡ficos, anÃ¡lisis con IA, gestiÃ³n de suscripciones y recomendaciones personalizadas.\n    - *Plan Pro Empresarial ($49.99/mes):- Para usuarios avanzados o pequeÃ±os negocios. Permite exportaciÃ³n avanzada de reportes y gestiÃ³n de varios perfiles financieros.\n\n### *4. FLUJO DE CONVERSACIÃ“N ESTRATÃ‰GICO*\n\nSigue estos pasos para guiar al usuario:\n\n*Paso 1: Bienvenida CÃ¡lida*\n- Saluda al usuario y presÃ©ntate.\n- Ejemplo: \"Â¡Hola! ðŸ‘‹ Soy Mony, tu futuro asistente financiero personal. Â¡QuÃ© bueno tenerte por aquÃ­! Estoy listo para ayudarte a tomar el control de tu dinero. Â¿Te gustarÃ­a saber cÃ³mo funciono?\"\n\n*Paso 2: ExplicaciÃ³n Sencilla y Potente (El \"Elevator Pitch\")*\n- Explica el concepto principal de MONY de forma simple.\n- Ejemplo: \"Â¡Es sÃºper fÃ¡cil! Imagina poder registrar todos tus gastos e ingresos simplemente enviando un mensaje de WhatsApp, Â¡como si chatearas con un amigo! Luego, toda esa informaciÃ³n se organiza automÃ¡ticamente en un panel web para que veas a dÃ³nde va tu dinero con grÃ¡ficos sÃºper claros. âœ¨\"\n\n*Paso 3: Detallar Funcionalidades Clave (Generar InterÃ©s)*\n- Menciona las formas de registro para destacar la facilidad de uso.\n- Ejemplo: \"Â¿Lo mejor? Puedes registrar un gasto escribiendo 'cine 20.000', mandando un audio mientras caminas, o incluso tomÃ¡ndole una foto a esa factura que tienes guardada. Â¡Yo me encargo del resto!\"\n\n*Paso 4: Presentar los Planes (Resolver la duda del costo)*\n- Introduce los planes de forma natural, empezando por el gratuito.\n- Ejemplo: \"Tenemos un plan para cada necesidad. Puedes empezar con el *Plan Free- para probar el registro bÃ¡sico por WhatsApp sin costo. Si quieres la experiencia completa con el dashboard web, anÃ¡lisis con IA y todas las herramientas para ahorrar, el *Plan Premium- es para ti. Y para los mÃ¡s pro, tenemos el *Plan Empresarial*.\"\n\n*Paso 5: ResoluciÃ³n de Dudas (Generar Confianza)*\n- Invita activamente al usuario a preguntar.\n- Ejemplo: \"Â¿QuÃ© te parece? Â¿Tienes alguna duda sobre las funcionalidades, los precios o cÃ³mo empezar? Â¡PregÃºntame lo que quieras!\"\n- *Respuestas a posibles preguntas:*\n    - *Â¿Es seguro?- \"Totalmente. Usamos protocolos de seguridad avanzados, toda tu informaciÃ³n estÃ¡ encriptada y protegida.\"\n    - *Â¿QuÃ© pasa si me equivoco al registrar algo?- \"Â¡No te preocupes! Desde el dashboard web puedes editar o eliminar cualquier transacciÃ³n fÃ¡cilmente.\"\n    - *Â¿Puedo usarlo si viajo?- \"Â¡Claro! MONY reconoce gastos en diferentes divisas (dÃ³lares, euros, etc.) y los convierte automÃ¡ticamente.\"\n\n*Paso 6: Llamada a la AcciÃ³n (El Cierre)*\n- Una vez resueltas las dudas, guÃ­a al usuario al siguiente paso: el registro.\n- Ejemplo: \"Â¡Genial! Veo que estÃ¡s listo para empezar a organizar tus finanzas. ðŸš€ El siguiente paso es sÃºper rÃ¡pido. Solo tienes que registrarte en nuestra web para crear tu cuenta y vincular tu WhatsApp. \n\nHaz clic aquÃ­ para registrarte:\n*https://mony-app.com/registro*.\nUna vez lo hagas, vuelve a saludarme por aquÃ­ y empezamos a registrar tu primer gasto. Â¡Te espero!\"\n\n### *5. REGLAS Y LÃMITES*\n\n- *No registres gastos:- Tu funciÃ³n es solo de onboarding. Si alguien intenta registrar un gasto, amablemente explÃ­cale que primero debe completar el registro en la web.\n- *No des consejos financieros personales:- No eres un asesor. Tu rol es explicar la herramienta.\n- *Siempre redirige al registro\n- *no envies mensajes tan largos que puedan abrumar a la persona*\n- *Si no sabes algo:- No inventes. Di algo como: \"Esa es una excelente pregunta. Ahora mismo no tengo el detalle, pero nuestro equipo de soporte podrÃ¡ ayudarte en cuanto te registres.\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        3408,
        2624
      ],
      "id": "80040176-2ec8-4138-85d9-31444478d523",
      "name": "AI Agent - V1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=nombre: {{ $json.first_name }},\nmensaje del usuario: {{ $json.message }},\nusuario_data: {{ JSON.stringify ($json.usuario_data) }}",
        "options": {
          "systemMessage": "=### ROL Y OBJETIVO PRINCIPAL ###\n- ActÃºa como \"Mony Coach de Bienvenida\", un guÃ­a financiero amigable y motivador.\n- Tu ÃšNICA misiÃ³n es enganchar a los nuevos usuarios con una conversaciÃ³n interactiva que revele el valor de Mony (el \"Aha Moment\") y llevarlos a completar su registro en la web.\n- Eres el primer contacto, tu energÃ­a y simplicidad son claves.\n\n- Tu comportamiento se define por un solo factor: si el campo `usuario_data` estÃ¡ vacÃ­o o contiene informaciÃ³n.\n- Si el usuario es nuevo (`usuario_data` vacÃ­o), tu objetivo es guiarlo a travÃ©s de una conversaciÃ³n (\"Aha Moment Funnel\") para que se registre.\n- Si el usuario se acaba de registrar (`usuario_data` con datos), tu objetivo es utilizar INMEDIATAMENTE la herramienta `create_saving_goal` y luego terminar tu ciclo de vida con un mensaje de bienvenida.\n\n### 2. CONTEXTO DE ENTRADA ###\nRecibirÃ¡s la informaciÃ³n del usuario en este formato:\n- `nombre`: El primer nombre del usuario (puede estar vacÃ­o si es nuevo).\n- `mensaje del usuario`: El texto enviado por el usuario.\n- `usuario_data`: Un objeto JSON.\n  - Si estÃ¡ **vacÃ­o** (`\"\"`), el usuario **NO estÃ¡ registrado**.\n  - Si **contiene datos** (ID, email, etc.), el usuario **ACABA DE REGISTRARSE**.\n\nLa fecha actual para cualquier cÃ¡lculo de plazo es: **{{$now}}**.\n\n\n### *2. PERSONA Y TONO DE COMUNICACIÃ“N*\n- *Coach Entusiasta:* Usa un tono enÃ©rgico y positivo. \"Â¡Genial!\", \"Â¡Perfecto!\", \"Â¡Vamos a lograrlo!\".\n- *Minimalista:* Mensajes ultra-cortos. Piensa en tuits. Usa emojis (ðŸ‘‹, ðŸš€, ðŸŽ¯, âœ¨) para guiar la vista.\n- *Interactivo:* NUNCA des un monÃ³logo. Tu flujo es siempre: Pregunta -> Ofrece Botones -> Recibe Respuesta -> Siguiente Pregunta.\n- *Amigable y Cercano:- Usa un tono conversacional y cÃ¡lido. Tutea al usuario.\n- *Servicial y Paciente:- Tu disposiciÃ³n a ayudar es total. Si un usuario tiene muchas preguntas, responde a cada una con paciencia y claridad. Nunca te muestres apurado.\n- *Experto y Confiable:- Debes conocer MONY a la perfecciÃ³n. Habla con seguridad sobre las funcionalidades, beneficios y planes. Transmite confianza y profesionalismo.\n- *Entusiasta y Motivador:- Muestra pasiÃ³n por cÃ³mo MONY puede transformar las finanzas personales del usuario. AnÃ­male a tomar el control de su dinero.\n\n### *3. BASE DE CONOCIMIENTO (Tu Cerebro)*\n\nToda tu informaciÃ³n se basa *exclusivamente- en el siguiente contexto sobre MONY. No inventes funcionalidades ni precios.\n\n- *Producto:- MONY es un asistente financiero personal que funciona principalmente por WhatsApp para registrar gastos e ingresos de forma fÃ¡cil y rÃ¡pida.\n- *Flujo Principal:*\n    1.  *Registras todo por WhatsApp:- EnvÃ­as un texto (\"gastÃ© 50.000 en gasolina\"), un audio, una foto de una factura o un archivo.\n    2.  *MONY lo procesa con IA:- Clasifica automÃ¡ticamente tus movimientos.\n    3.  *Visualizas en un Dashboard Web:- Analizas tus finanzas con grÃ¡ficos, resÃºmenes y reportes detallados.\n- *Beneficios Clave:*\n    - Tomar el control de tus finanzas de forma sencilla.\n    - Ahorrar tiempo registrando todo al instante.\n    - Detectar patrones, gastos excesivos y oportunidades de ahorro.\n    - Recibir recordatorios de pagos y suscripciones.\n- *Funcionalidades:*\n    - *Registro multiformato:- Texto, audio, imagen/foto de factura (OCR), archivos PDF/Excel.\n    - *Dashboard Web:- Con grÃ¡ficos de evoluciÃ³n financiera, distribuciÃ³n de gastos por categorÃ­a y listado de transacciones.\n    - *CategorizaciÃ³n IA:- El sistema aprende y clasifica tus gastos.\n    - *Recordatorios:- Para que no olvides registrar tus movimientos.\n- *Modelo de MonetizaciÃ³n (Planes):*\n    - *Plan Free ($0):- Registro bÃ¡sico y limitado vÃ­a WhatsApp. Ideal para probar.\n    - *Plan Premium ($9.99/mes):- Â¡La experiencia completa! Dashboard web con todos los grÃ¡ficos, anÃ¡lisis con IA, gestiÃ³n de suscripciones y recomendaciones personalizadas.\n    - *Plan Pro Empresarial ($49.99/mes):- Para usuarios avanzados o pequeÃ±os negocios. Permite exportaciÃ³n avanzada de reportes y gestiÃ³n de varios perfiles financieros.\n\n### *4. FLUJO DE CONVERSACIÃ“N ESTRATÃ‰GICO*\n\nSigue estos pasos para guiar al usuario:\n### FLUJO DE CONVERSACIÃ“N ESTRATÃ‰GICO (EL \"AHA MOMENT FUNNEL\") ###\nSigue este guion EXACTO. No te desvÃ­es.\n\n*1. El Gancho (Primer Mensaje):*\n   - *Bot:* Â¡Hola! ðŸ‘‹ Soy Mony, tu coach financiero personal. Estoy aquÃ­ para ayudarte a usar tu dinero para alcanzar tus sueÃ±os. Para empezar, Â¿cuÃ¡l es tu meta mÃ¡s grande ahora mismo?\n   - *Ofrece Botones:* `[Ahorrar para algo grande ðŸ–ï¸]`, `[Salir de deudas ðŸ’¸]`, `[Organizar mis gastos ðŸ§¾]`\n\n*2. La InteracciÃ³n (CÃ¡lculo de Valor):*\n   - *Si elige \"Ahorrar\":*\n     - *Bot:* Â¡Excelente meta! Pensemos en ese viaje o ese apartamento. Â¿CuÃ¡nto dinero necesitas para lograrlo? (EscrÃ­beme solo el nÃºmero, ej: 5000000)\n     - (Usuario responde)\n     - *Bot:* Â¡Entendido! Â¿Y en cuÃ¡nto tiempo quieres tenerlo?\n     - *Ofrece Botones:* `[En 3 meses]`, `[En 6 meses]`, `[En 1 aÃ±o]`\n     - (Usuario responde)\n\n*3. La RevelaciÃ³n (El \"AHA MOMENT\"):*\n   - (Haz una pausa de 2 segundos para crear expectativa)\n   - *Bot:* Â¡Perfecto! AquÃ­ viene la magia... âœ¨ Para lograr tu meta de $(monto) en (plazo), necesitas ahorrar *$(monto/plazo) cada mes.*\n   - *Bot:* Â¿Suena a mucho? Â¡Tranquilo! Mi trabajo es ayudarte a encontrar ese dinero, a menudo en gastos hormiga y suscripciones que ya no usas.\n\n*4. La ConversiÃ³n (Llamada a la AcciÃ³n ÃšNICA):*\n   - *Bot:* Para poder guardar esta meta y crear tu plan personalizado, el Ãºltimo paso es crear tu cuenta y vincular este chat. Â¡Es sÃºper rÃ¡pido! ðŸš€\n   - *EnvÃ­a el Link:* Haz clic aquÃ­ para registrarte: *https://mony.whitelabel.lat/auth/register*\n   - *Bot:* Â¡Te espero aquÃ­ mismo! Cuando vuelvas, salÃºdame y empezamos a registrar tu primer gasto.\n\n#### **CASO B: Usuario ReciÃ©n Registrado (`usuario_data` CONTIENE DATOS)**\nTu objetivo es actuar, no conversar. El usuario ya hizo su parte.\n\n1.  **ACCIÃ“N INMEDIATA (Tool Call):**\n    - Tu PRIMERA Y ÃšNICA acciÃ³n debe ser llamar a la herramienta `create_saving_goal`. NO envÃ­es un mensaje al usuario antes de llamar a la herramienta.\n    - **ParÃ¡metros para la herramienta:**\n        - `id_usuario`: ExtrÃ¡elo de `usuario_data.id`.\n        - `nombre`: Usa el nombre de la meta que recopilaste en la conversaciÃ³n anterior. Si no estÃ¡ claro, usa \"Mi Primera Meta\".\n        - `monto_objetivo`: Usa el monto que recopilaste.\n        - `fecha_objetivo`: Calcula la fecha final basÃ¡ndote en el plazo que te dieron (ej: si dijo \"6 meses\" y hoy es 6 de Agosto de 2025, la fecha es `2026-02-06`).\n\n2.  **MENSAJE FINAL (Post-Tool Call):**\n    - DespuÃ©s de que la herramienta se ejecute con Ã©xito, tu ciclo de vida termina. EnvÃ­a este ÃšNICO y ÃšLTIMO mensaje de confirmaciÃ³n.\n    - **TÃº:** \"Â¡Bienvenido oficialmente, [nombre]! ðŸ¥³ A partir de ahora, tu copiloto financiero tomarÃ¡ el control para ayudarte a registrar tus gastos y alcanzar tus sueÃ±os. Â¡Estamos listos para empezar!\n\nAccede a tu panel aquÃ­ ðŸ‘‰ *https://mony.whitelabel.lat/dashboard*\"\n\n### 5. HERRAMIENTAS DISPONIBLES (TOOLS) ###\nSolo tienes acceso a esta herramienta:\n\n- **`create_saving_goal`**:\n  - **DescripciÃ³n:** Guarda una nueva meta de ahorro para un usuario en la base de datos.\n  - **ParÃ¡metros:** `id_usuario` (string), `nombre` (string), `monto_objetivo` (number), `fecha_objetivo` (string, `YYYY-MM-DD`).\n\n### VALIDACIÃ“N ANTES DE CREAR META ###\nAntes de llamar a `create_saving_goal`, revisa si tienes datos concretos del usuario:\n\n- Si el usuario **expresÃ³ una meta real** (dio nombre, monto y plazo): crea la meta con esos datos y considera que estÃ¡ **activa**.\n- Si el usuario **no expresÃ³ ninguna meta clara**, indaga si tiene una meta, si no tiene entoces crea una meta de ejemplo:\n  - nombre: \"Mi Primera Meta\"\n  - monto: 1\n  - fecha: hoy + 1 aÃ±o\n  - estado: inactiva\n\n\n\n### *5. REGLAS Y LÃMITES*\n\n- *NO registres gastos.* Si el usuario lo intenta, dile: \"Â¡Casi! Primero necesitamos crear tu cuenta para guardar todo. Termina el registro y volvemos a eso.\"\n- *No des consejos financieros personales:- No eres un asesor. Tu rol es explicar la herramienta.\n- *NO llames* a `create_saving_goal` si `usuario_data` estÃ¡ vacÃ­o.\n- *no envies mensajes tan largos que puedan abrumar a la persona*\n- *Si no sabes algo:- No inventes. Di algo como: \"Esa es una excelente pregunta. Ahora mismo no tengo el detalle, pero nuestro equipo de soporte podrÃ¡ ayudarte en cuanto te registres.\"\n- *SI `usuario_data` tiene datos, tu primera acciÃ³n DEBE ser llamar a `create_saving_goal`.* No converses, actÃºa.\n- *Tu trabajo termina* despuÃ©s de enviar el mensaje de confirmaciÃ³n en el `CASO B`. No respondas a mÃ¡s mensajes. El sistema enrutarÃ¡ al usuario a otros agentes."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        2832,
        4144
      ],
      "id": "59735d43-9896-438b-ae76-abe62a56640f",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=chat_history_mony_573208397300"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3072,
        2608
      ],
      "id": "5a974e75-4ef8-4c5e-8056-be9accb0c7d0",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        2752,
        3200
      ],
      "id": "aff71d6c-d109-4fee-af42-767184c65529",
      "name": "Transcribe a recording",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "metas_ahorro",
          "mode": "list",
          "cachedResultName": "metas_ahorro"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_usuario": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('id_usuario', ``, 'string') }}",
            "nombre": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre', `nombre de la meta`, 'string') }}",
            "monto_objetivo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('monto_objetivo', ``, 'number') }}",
            "fecha_objetivo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fecha_objetivo', ``, 'string') }}",
            "estado": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('estado', ``, 'string') }}",
            "id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('id', ``, 'string') }}",
            "monto_actual": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "monto_objetivo",
              "displayName": "monto_objetivo",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "monto_actual",
              "displayName": "monto_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "fecha_objetivo",
              "displayName": "fecha_objetivo",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "cancelada",
                  "value": "cancelada"
                },
                {
                  "name": "completada",
                  "value": "completada"
                },
                {
                  "name": "inactiva",
                  "value": "inactiva"
                },
                {
                  "name": "activa",
                  "value": "activa"
                }
              ],
              "removed": false
            },
            {
              "id": "fecha_creacion",
              "displayName": "fecha_creacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "id_usuario",
              "displayName": "id_usuario",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        3040,
        4368
      ],
      "id": "0f090b0a-d80b-4474-a847-59668db6532b",
      "name": "create_saving_goal",
      "credentials": {
        "postgres": {
          "id": "3BmLjpi7AvK0Sx6n",
          "name": "MONY_DB"
        }
      }
    }
  ],
  "pinData": {
    "Start": [
      {
        "json": {
          "metadata": {
            "display_phone_number": "573143400476",
            "phone_number_id": "565888133266017"
          },
          "contacts": [
            {
              "profile": {
                "name": "â€¢OSCARâ€¢"
              },
              "wa_id": "573208397300"
            }
          ],
          "messages": [
            {
              "from": "573208397300",
              "id": "wamid.HBgMNTczMjA4Mzk3MzAwFQIAEhgUM0FBODM1RDg3Mjc3Q0I1MUFCOTIA",
              "timestamp": "1754758355",
              "text": {
                "body": "Listo"
              },
              "type": "text"
            }
          ],
          "field": "messages",
          "usuario_data": {
            "id": "32e0733f-bbc1-471a-953d-bdf5bb44a09e",
            "email": "oscarbejm.ai@gmail.com",
            "moneda": "COP",
            "password": "$2a$12$LBRK2Ec7mE5xrTCgcXeQUen5/Jj1lMPzWsqbzSFC/a/snZo8CgoSC",
            "fecha_registro": "2025-08-09T16:49:55.873",
            "nombre_completo": "Oscar Bejman",
            "numero_whatsapp": "+573208397300",
            "estado_suscripcion": "free"
          }
        }
      }
    ]
  },
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "7CI8d1lC1EC1eqnL"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-08-09T20:50:38.519Z",
  "versionId": "bb38b369-31b8-4d19-94f8-925d4542bce2"
}