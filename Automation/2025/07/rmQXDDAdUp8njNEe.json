{
  "active": false,
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "User test1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Usuario": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Mensaje": {
      "main": [
        [
          {
            "node": "Procesar Imagen",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar Archivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Imagen": {
      "main": [
        [
          {
            "node": "Extraer Datos Imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Audio": {
      "main": [
        [
          {
            "node": "Extraer Datos Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Archivo": {
      "main": [
        [
          {
            "node": "Extraer Datos Archivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Texto": {
      "main": [
        [
          {
            "node": "Obtener Categoría",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos Imagen": {
      "main": [
        [
          {
            "node": "Obtener Categoría",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos Audio": {
      "main": [
        [
          {
            "node": "Obtener Categoría",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos Archivo": {
      "main": [
        [
          {
            "node": "Obtener Categoría",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Categoría": {
      "main": [
        [
          {
            "node": "Confirmar Categoría",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Categoría": {
      "main": [
        [
          {
            "node": "Esperar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar Respuesta": {
      "main": [
        [
          {
            "node": "Validar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Respuesta": {
      "main": [
        [
          {
            "node": "Guardar Transacción",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener Nueva Categoría",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Nueva Categoría": {
      "main": [
        [
          {
            "node": "Guardar Transacción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Transacción": {
      "main": [
        [
          {
            "node": "Confirmar Registro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Programar Recordatorios": {
      "main": [
        [
          {
            "node": "Obtener Usuarios Recordatorios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Usuarios Recordatorios": {
      "main": [
        [
          {
            "node": "Enviar Recordatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Verificar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "type message Whatsap",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "inicio sin registro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Unir Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Message": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Push Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "type message Whatsap": {
      "main": [
        [
          {
            "node": "Download media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DataText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "DataAudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataText": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataAudio": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setData": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-28T20:07:09.475Z",
  "id": "rmQXDDAdUp8njNEe",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "My workflow 3",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        384,
        -992
      ],
      "id": "2594ae8c-9bed-48ad-9d66-cb2dd9828bc0",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- EXTENSIONES ÚTILES\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\nCREATE EXTENSION IF NOT EXISTS \"pgcrypto\";\n\n-- TABLA: Usuarios\nCREATE TABLE usuarios (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    nombre_completo TEXT NOT NULL,\n    email TEXT UNIQUE NOT NULL,\n    password_hash TEXT NOT NULL,\n    numero_whatsapp TEXT UNIQUE NOT NULL,\n    moneda_defecto TEXT DEFAULT 'COP',\n    estado_suscripcion TEXT DEFAULT 'gratuito',\n    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- TABLA: Categorías\nCREATE TABLE categorias (\n    id SERIAL PRIMARY KEY,\n    nombre TEXT NOT NULL UNIQUE,\n    tipo TEXT CHECK (tipo IN ('Ingreso', 'Gasto')) NOT NULL\n);\n\n-- Insertar categorías iniciales\nINSERT INTO categorias (nombre, tipo) VALUES\n    ('Comida', 'Gasto'),\n    ('Transporte', 'Gasto'),\n    ('Entretenimiento', 'Gasto'),\n    ('Salud', 'Gasto'),\n    ('Servicios', 'Gasto'),\n    ('Salario', 'Ingreso'),\n    ('Otros', 'Gasto');\n\n-- TABLA: Fuentes de Registro\nCREATE TABLE fuentes_registro (\n    id SERIAL PRIMARY KEY,\n    nombre TEXT NOT NULL UNIQUE -- Ej: WhatsApp, Web, OCR, Audio, PDF\n);\n\n-- Insertar fuentes iniciales\nINSERT INTO fuentes_registro (nombre) VALUES\n    ('WhatsApp'),\n    ('Web'),\n\n\n-- TABLA: Transacciones\nCREATE TABLE transacciones (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    id_usuario UUID REFERENCES usuarios(id) ON DELETE CASCADE,\n    descripcion TEXT,\n    monto NUMERIC(12, 2) NOT NULL,\n    moneda TEXT NOT NULL DEFAULT 'COP',\n    tipo TEXT CHECK (tipo IN ('Ingreso', 'Gasto')) NOT NULL,\n    fecha_transaccion TIMESTAMP NOT NULL,\n    id_categoria INTEGER REFERENCES categorias(id),\n    id_fuente INTEGER REFERENCES fuentes_registro(id),\n    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- TABLA: Suscripciones\nCREATE TABLE suscripciones (\n    id SERIAL PRIMARY KEY,\n    id_usuario UUID REFERENCES usuarios(id) ON DELETE CASCADE,\n    tipo TEXT CHECK (tipo IN ('gratuito', 'premium')) NOT NULL,\n    fecha_inicio TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    fecha_expiracion TIMESTAMP\n);\n\n-- TABLA: Recordatorios\nCREATE TABLE recordatorios (\n    id SERIAL PRIMARY KEY,\n    id_usuario UUID REFERENCES usuarios(id) ON DELETE CASCADE,\n    frecuencia TEXT CHECK (frecuencia IN ('diario', 'semanal', 'nunca')) NOT NULL,\n    hora_envio TIME DEFAULT '08:00:00'\n);\n\n-- TABLA: Anuncios\nCREATE TABLE anuncios (\n    id SERIAL PRIMARY KEY,\n    titulo TEXT NOT NULL,\n    imagen_url TEXT,\n    enlace TEXT,\n    texto TEXT,\n    frecuencia TEXT DEFAULT '1_por_sesion',\n    pais_destino TEXT,\n    moneda_destino TEXT,\n    fecha_inicio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    fecha_fin TIMESTAMP\n);\n\n-- TABLA: Logs de visualización de anuncios (opcional)\nCREATE TABLE anuncios_usuarios (\n    id SERIAL PRIMARY KEY,\n    id_anuncio INTEGER REFERENCES anuncios(id),\n    id_usuario UUID REFERENCES usuarios(id),\n    fecha_visto TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        592,
        -992
      ],
      "id": "b9aebc97-33bb-4279-b877-c50e46c04cbf",
      "name": "CREATE DATABASE",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "3BmLjpi7AvK0Sx6n",
          "name": "MONY_DB"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp/mony",
        "options": {}
      },
      "name": "Webhook WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        848,
        -1136
      ],
      "id": "8bfa3d3c-5fef-4718-b93c-87719e70d86f",
      "webhookId": "ab9eb1e5-2b76-439c-9d0e-0a779ae79854"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH dummy AS (\n    SELECT NULL::uuid AS id\n)\nSELECT \n    to_jsonb(u) AS usuario_data,\n    (u.id IS NOT NULL) AS existe\nFROM \n    dummy\nLEFT JOIN \n    usuarios u ON u.numero_whatsapp = $1;\n",
        "additionalFields": {
          "queryParams": "='573228854498'"
        }
      },
      "name": "Verificar Usuario",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        1184,
        -1008
      ],
      "id": "a622c1ef-e30e-424d-8b67-8ea4799f5683",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "3BmLjpi7AvK0Sx6n",
          "name": "MONY_DB"
        }
      }
    },
    {
      "parameters": {
        "value1": "={{ 0 }}"
      },
      "name": "Procesar Mensaje",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        240,
        -2000
      ],
      "id": "012e0861-8f14-4b90-8cba-eb8063d31a3f"
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "prompt": "Extrae la siguiente información del mensaje '{{$node['Webhook WhatsApp'].json.body.Body}}' en formato JSON: {monto: number, tipo: 'Ingreso'|'Gasto', categoria: string, fecha: string (formato ISO), descripcion: string}. Si no se especifica la fecha, usa la fecha actual. Ejemplo: 'Gasté 50,000 en supermercado' → {monto: 50000, tipo: 'Gasto', categoria: 'Comida', fecha: '2025-07-28T00:00:00Z', descripcion: 'Supermercado'}.",
        "options": {},
        "requestOptions": {}
      },
      "name": "Procesar Texto",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        688,
        -1664
      ],
      "id": "b75b8017-419c-4ecd-a52b-3d4fae5ae57d",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "https://vision.googleapis.com/v1/images:annotate?key={{your-google-vision-api-key}}",
        "options": {}
      },
      "name": "Procesar Imagen",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        464,
        -1872
      ],
      "id": "6c1ba06a-4447-4c73-a458-44691ac6c707"
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "prompt": "Extrae la siguiente información del texto OCR '{{$node['Procesar Imagen'].json.responses[0].fullTextAnnotation.text}}' en formato JSON: {monto: number, tipo: 'Ingreso'|'Gasto', categoria: string, fecha: string (formato ISO), descripcion: string}. Si no se especifica la fecha, usa la fecha actual.",
        "options": {},
        "requestOptions": {}
      },
      "name": "Extraer Datos Imagen",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        688,
        -1872
      ],
      "id": "05e80d71-3d21-4627-8485-2c39ca578f1d",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "url": "https://api.openai.com/v1/audio/transcriptions",
        "options": {}
      },
      "name": "Procesar Audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        464,
        -2064
      ],
      "id": "d82e23a1-f5db-4733-baa8-b912d7c50688"
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "prompt": "Extrae la siguiente información del texto transcrito '{{$node['Procesar Audio'].json.text}}' en formato JSON: {monto: number, tipo: 'Ingreso'|'Gasto', categoria: string, fecha: string (formato ISO), descripcion: string}. Si no se especifica la fecha, usa la fecha actual.",
        "options": {},
        "requestOptions": {}
      },
      "name": "Extraer Datos Audio",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        688,
        -2064
      ],
      "id": "03522398-7868-4ea2-9389-2168456f913c",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "basicAuth",
        "url": "https://api.konfuzio.com/v3/documents",
        "options": {}
      },
      "name": "Procesar Archivo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        464,
        -2272
      ],
      "id": "4eb58415-4201-4e9d-be4b-244d83229a32",
      "credentials": {
        "httpBasicAuth": {
          "id": "lZ0efOUQUlbFdSMe",
          "name": "Vapi"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "prompt": "Extrae la siguiente información del texto extraído '{{$node['Procesar Archivo'].json.text}}' en formato JSON: {monto: number, tipo: 'Ingreso'|'Gasto', categoria: string, fecha: string (formato ISO), descripcion: string}. Si no se especifica la fecha, usa la fecha actual.",
        "options": {},
        "requestOptions": {}
      },
      "name": "Extraer Datos Archivo",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        688,
        -2272
      ],
      "id": "55454ac6-308c-4009-a4bd-cdf2653a3ac9",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "additionalFields": {}
      },
      "name": "Obtener Categoría",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        912,
        -1872
      ],
      "id": "f4d365b1-5b6d-4ed9-a7b6-7ec0e78e5c04",
      "credentials": {
        "postgres": {
          "id": "gFhB2sfDoFHEQ7Pn",
          "name": "pgvector n8n_scrapper"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "url": "https://api.twilio.com/2010-04-01/Accounts/{{your-twilio-account-sid}}/Messages.json",
        "options": {}
      },
      "name": "Confirmar Categoría",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1136,
        -1872
      ],
      "id": "2ae75639-3b08-4dd2-907a-8a2c81fc111e"
    },
    {
      "parameters": {},
      "name": "Esperar Respuesta",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        1360,
        -1872
      ],
      "id": "b525e695-d1a6-4f74-8d4d-926a6a84ff0e",
      "webhookId": "e7b569f0-8329-457f-8966-99631bf93d72"
    },
    {
      "parameters": {},
      "name": "Validar Respuesta",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        1584,
        -1904
      ],
      "id": "5a7fe308-49ac-49e8-8a25-f9fadd619834"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "additionalFields": {}
      },
      "name": "Obtener Nueva Categoría",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        1808,
        -1792
      ],
      "id": "f497db89-ff90-40c3-b167-6ccc062e2fdc",
      "credentials": {
        "postgres": {
          "id": "3BmLjpi7AvK0Sx6n",
          "name": "MONY_DB"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "additionalFields": {}
      },
      "name": "Guardar Transacción",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        2032,
        -1872
      ],
      "id": "97ffee5f-90c6-40d6-aadd-0913eccbe34e",
      "credentials": {
        "postgres": {
          "id": "gFhB2sfDoFHEQ7Pn",
          "name": "pgvector n8n_scrapper"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "url": "https://api.twilio.com/2010-04-01/Accounts/{{your-twilio-account-sid}}/Messages.json",
        "options": {}
      },
      "name": "Confirmar Registro",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2256,
        -1872
      ],
      "id": "2a7da8f9-bf28-4cc4-92ce-ce2f4da55c31"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "name": "Programar Recordatorios",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        960,
        -384
      ],
      "id": "bee4c4e7-1624-4f07-9e22-e6d3030333d4"
    },
    {
      "parameters": {
        "additionalFields": {}
      },
      "name": "Obtener Usuarios Recordatorios",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        1184,
        -384
      ],
      "id": "d88691ba-fc5f-4726-a522-94475db88094",
      "credentials": {
        "postgres": {
          "id": "3BmLjpi7AvK0Sx6n",
          "name": "MONY_DB"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "url": "https://api.twilio.com/2010-04-01/Accounts/{{your-twilio-account-sid}}/Messages.json",
        "options": {}
      },
      "name": "Enviar Recordatorio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1408,
        -384
      ],
      "id": "0b7e1e6a-05e2-434d-af5b-7bc29d129f81"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        1504,
        -784
      ],
      "id": "0f5e2feb-1751-4f45-84b8-8205d3c6b270",
      "name": "inicio sin registro",
      "disabled": true
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        960,
        -1008
      ],
      "id": "6d355b4a-23db-4855-a14c-8a1d3f2b9b18",
      "name": "WhatsApp Trigger",
      "webhookId": "22e117ba-6848-499c-b9ff-8b6b13b1f278",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "jxY742yXHUpUmkYh",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- 2. Ahora insertar el usuario\nINSERT INTO usuarios (\n    nombre_completo,\n    email,\n    password_hash,\n    numero_whatsapp,\n    moneda_defecto,\n    estado_suscripcion\n) VALUES (\n    'Pedro Rodriguez',\n    'pro.pedro0413@gmail.com',\n    crypt('propro93', gen_salt('bf')),  -- Encriptación segura\n    '573228854498',\n    'COP',\n    'gratuito'\n)\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        576,
        -784
      ],
      "id": "3174561b-a579-48d5-a34a-c2a1b0d1c208",
      "name": "User test",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "3BmLjpi7AvK0Sx6n",
          "name": "MONY_DB"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "usuarios",
          "mode": "list",
          "cachedResultName": "usuarios"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        560,
        -608
      ],
      "id": "4054dadf-ed25-4bf5-935b-165b8efc8ede",
      "name": "User test1",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "3BmLjpi7AvK0Sx6n",
          "name": "MONY_DB"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "true",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9c38cf88-8498-4e41-b8b6-9c9bf0465b55"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Registrado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d20501b2-6c3d-42b4-9617-995adf90e423",
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "false",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Sin Registrar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1632,
        -1008
      ],
      "id": "792048ec-8c27-45ce-936e-588334d818ad",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1daf1e5a-7028-4ec4-a5d1-a7e6343738dc",
              "name": "messages",
              "value": "={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "90dc24fa-85a0-4b98-ad7f-a0f2ab094722",
              "name": "existe",
              "value": "={{ $json.existe }}",
              "type": "string"
            },
            {
              "id": "70bf3769-05a5-4f09-9ead-f39029fc7167",
              "name": "usuario_data",
              "value": "={{ $json.usuario_data }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1392,
        -1008
      ],
      "id": "5aa43e16-51e2-4dc0-b7c5-6447c5d425da",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7fe6665-ef0d-4ec2-9800-88004951e528",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('setData').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3760,
        -1088
      ],
      "id": "5e088256-5ef9-45a7-94c0-64284a6f5513",
      "name": "If1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3984,
        -992
      ],
      "id": "cf8fdf15-d597-441a-b463-fa657a476b01",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "=chat_id_{{ $json.phone_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3536,
        -1088
      ],
      "id": "a01f18e9-1120-47e4-b520-dbf1604739bb",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3312,
        -1088
      ],
      "id": "b26ae8f9-982b-463c-9281-abe7f22fe856",
      "name": "Wait",
      "webhookId": "c42fd9d6-416c-4950-8662-76e241fbd897"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=chat_id_{{ $json.phone_number }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3088,
        -1088
      ],
      "id": "d0597622-e2d2-476a-973a-d7359fba0a5b",
      "name": "Push Message",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $('Redis').item.json.message.join('\\n').replace(/test/gi, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3984,
        -1184
      ],
      "id": "a055186e-5628-43ec-9a5b-d45d8ffa0546",
      "name": "Unir Mensajes"
    },
    {
      "parameters": {
        "content": "## Incoming Messages\n",
        "height": 540,
        "width": 2240,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1968,
        -1296
      ],
      "id": "5f62c8bc-9a89-4596-b3ed-f9a073430a1a",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "key": "phone_number",
              "value": "={{ $json.phone_number }}"
            },
            {
              "key": "tipo_mensaje",
              "value": "={{ $json.tipo_mensaje }}"
            },
            {
              "key": "mensaje",
              "value": "={{ $json.mensaje }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        2864,
        -1088
      ],
      "id": "e2ee0d57-e1ac-40b1-9e2e-cab93494fae3",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38cdad62-0d9c-45bc-860e-9e03d107ba58"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "82df4052-c480-44a2-9d09-c195d4bc6879",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2192,
        -1088
      ],
      "id": "44741ca5-9593-426b-a456-83d3779b2c3d",
      "name": "type message Whatsap"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        2336,
        -1488
      ],
      "id": "2331b067-2771-48b8-b21e-6aa51471bd3f",
      "name": "Download media",
      "webhookId": "9559feee-21a8-4e7f-b6d4-a947041fdc5f",
      "credentials": {
        "whatsAppApi": {
          "id": "YohohlgP3bBq85IL",
          "name": "Test Pedro"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://speech.googleapis.com/v1/speech:recognize",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"config\": {\n    \"encoding\": \"OGG_OPUS\",\n    \"sampleRateHertz\": 16000,\n    \"languageCode\": \"es-CO\",\n    \"enableAutomaticPunctuation\": true,\n    \"model\": \"telephony\"\n  },\n  \"audio\": {\n    \"content\": \"{{ $json.data }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3008,
        -1488
      ],
      "id": "e886e4fd-e08d-4a8c-88e2-8495ff14ec88",
      "name": "HTTP Request",
      "credentials": {
        "googleOAuth2Api": {
          "id": "9Z0zKL8ENum6cJNe",
          "name": "google-tts"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2560,
        -1488
      ],
      "id": "c7ff40a5-d264-4ae0-a71f-c3863d4307c7",
      "name": "HTTP Request1",
      "credentials": {
        "whatsAppApi": {
          "id": "IzfsUgwJnA4EF09z",
          "name": "whatsap Valeia"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2784,
        -1488
      ],
      "id": "92009a2e-b3a5-4592-9f46-acd061631faa",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $json.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2448,
        -1088
      ],
      "id": "0ac75478-27fd-4026-9544-77e79547a965",
      "name": "DataText"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('WhatsApp Trigger1').item.json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('WhatsApp Trigger1').item.json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $json.results[0].alternatives[0].transcript }}",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $('WhatsApp Trigger1').item.json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3232,
        -1488
      ],
      "id": "9f311bf2-2fe9-4271-a448-11d98ac2d5a0",
      "name": "DataAudio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f4f107ad-f4e3-4616-a1ec-515f7324ba23",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "6f55c6f4-4cb3-4cec-9d31-b956d3fffde0",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "bad14eb8-f005-4d91-bd83-600e6105d974",
              "name": "mensaje",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2640,
        -1088
      ],
      "id": "b130f89f-4be4-415a-bbe1-4e06245cb4b8",
      "name": "setData"
    }
  ],
  "pinData": {
    "WhatsApp Trigger": [
      {
        "json": {
          "messaging_product": "whatsapp",
          "metadata": {
            "display_phone_number": "573143400476",
            "phone_number_id": "565888133266017"
          },
          "contacts": [
            {
              "profile": {
                "name": "Pedro Rodriguez"
              },
              "wa_id": "573228854498"
            }
          ],
          "messages": [
            {
              "from": "573228854498",
              "id": "wamid.HBgMNTczMjI4ODU0NDk4FQIAEhgUM0Y1QkI2NDMzNkIyMUM0MEU3QUMA",
              "timestamp": "1753738987",
              "text": {
                "body": "hola"
              },
              "type": "text"
            }
          ],
          "field": "messages"
        }
      }
    ]
  },
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-07-28T22:20:36.191Z",
  "versionId": "65fda680-fd10-453a-9c61-96753f88f04b"
}