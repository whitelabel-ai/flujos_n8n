{
  "active": false,
  "connections": {
    "Data": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait11": {
      "main": [
        [
          {
            "node": "If13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait12": {
      "main": [
        [
          {
            "node": "If12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If12": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If13": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait13": {
      "main": [
        [
          {
            "node": "If14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If14": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        []
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "consultar_disponibilidad": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "consultar_eventos_dia": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agendar_reunion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataImage": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataPdf": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Push Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "type message Whatsap": {
      "main": [
        [
          {
            "node": "Transcribe a recording1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataText": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing4": {
      "main": [
        [
          {
            "node": "DataText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataAudio": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Unir Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Message1": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "whatsap trigger": {
      "main": [
        [
          {
            "node": "initData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setData": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording1": {
      "main": [
        [
          {
            "node": "DataAudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image1": {
      "main": [
        [
          {
            "node": "DataImage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze document": {
      "main": [
        [
          {
            "node": "DataPdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Mensajes": {
      "main": [
        [
          {
            "node": "Redis6",
            "type": "main",
            "index": 0
          },
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "Wait11",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait12",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait13",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Execution Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "WhatsApp Trigger",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data1": {
      "main": [
        [
          {
            "node": "initData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "initData": {
      "main": [
        [
          {
            "node": "type message Whatsap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-05-22T03:11:30.320Z",
  "id": "AdcpHFHuUVLPnrVw",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "message chatwoot",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "=https://crm.whitelabel.lat/api/v1/accounts/{{ $('initData').item.json.account_id }}/conversations/{{ $('initData').item.json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('ChatwootData').item.json.api_access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": {{ JSON.stringify($json.message.content.parte1) }},\n  \"message_type\": \"outgoing\",\n  \"private\": \"false\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        512,
        -640
      ],
      "id": "afb29986-9121-4aac-ab15-61e1c69c7e4d",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4e6ed31c-2d8f-4415-bdaf-404a870f1cc2",
              "name": "first_name",
              "value": "={{ $('setData').item.json.nombre.split(\" \")[0] }}",
              "type": "string"
            },
            {
              "id": "f312aa42-4354-4954-92ff-9549a49c1d5b",
              "name": "user_id",
              "value": "={{ $('setData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $json.message.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        672,
        -1344
      ],
      "id": "b1b6b6b2-5d66-45cd-9e62-b29e441ebad1",
      "name": "Data"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        928,
        -640
      ],
      "id": "58996f25-96bf-4278-b4c7-2fdca2d5e3fa",
      "name": "Wait11",
      "webhookId": "421fa124-d19b-4b79-99dc-a3a3b6a82453"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        512,
        -464
      ],
      "id": "3c092377-e332-4d1b-ba40-40057f05fd12",
      "name": "Wait12",
      "webhookId": "ab691256-a33d-4e5e-b5d8-8cccd92a0134"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte3}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        736,
        -464
      ],
      "id": "7882b75d-ea32-45a7-9106-987226c39719",
      "name": "If12"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1152,
        -432
      ],
      "id": "d18106e5-691d-41e2-b029-4c9ccb63f103",
      "name": "No Operation, do nothing11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "709f4717-003f-4f9f-b841-18d2f2f4ddb4",
              "leftValue": "={{ $json.message.content.parte2}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1136,
        -640
      ],
      "id": "7a98dd55-fe74-4eac-842d-ad5a92736c33",
      "name": "If13"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1568,
        -624
      ],
      "id": "ebcf0461-848c-4706-bb62-e13775abd338",
      "name": "No Operation, do nothing12"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        512,
        -240
      ],
      "id": "d0a4cf6d-cb6f-4f34-9a13-37125227b96c",
      "name": "Wait13",
      "webhookId": "ab691256-a33d-4e5e-b5d8-8cccd92a0134"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5b98c759-b4b7-4353-a5e4-d2ff1c030744",
              "leftValue": "={{ $json.message.content.parte4}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        736,
        -240
      ],
      "id": "2438b06e-494d-4a29-a09b-d5a89c1451a6",
      "name": "If14"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1152,
        -240
      ],
      "id": "3e4403cd-63ec-4dcb-a048-5b91a568c239",
      "name": "No Operation, do nothing13"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://crm.whitelabel.lat/api/v1/accounts/{{ $('initData').item.json.account_id }}/conversations/{{ $('initData').item.json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('ChatwootData').item.json.api_access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": {{ JSON.stringify($json.message.content.parte2) }},\n  \"message_type\": \"outgoing\",\n  \"private\": \"false\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        -656
      ],
      "id": "9ba8d6aa-34f7-415c-a3c0-0bd96d26fb9d",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://crm.whitelabel.lat/api/v1/accounts/{{ $('initData').item.json.account_id }}/conversations/{{ $('initData').item.json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('ChatwootData').item.json.api_access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": {{ JSON.stringify($json.message.content.parte3) }},\n  \"message_type\": \"outgoing\",\n  \"private\": \"false\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        960,
        -480
      ],
      "id": "6283fae5-1794-4d21-8e7e-560eea1b775b",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://crm.whitelabel.lat/api/v1/accounts/{{ $('initData').item.json.account_id }}/conversations/{{ $('initData').item.json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('ChatwootData').item.json.api_access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": {{ JSON.stringify($json.message.content.parte4) }},\n  \"message_type\": \"outgoing\",\n  \"private\": \"false\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        976,
        -256
      ],
      "id": "1c463418-d576-45a2-9ff5-8dc13d4fb6cc",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "content": "## AGENT MAIN",
        "height": 600,
        "width": 2240
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        16,
        -1440
      ],
      "id": "a667c5ad-0e8a-4d70-b2e0-6af205a86454",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## RESPONS AGENT",
        "height": 600,
        "width": 1720,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        16,
        -688
      ],
      "id": "f66a9220-eca6-42a3-ba0e-7b6a6a6b8d6e",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Corrige mensajes de usuarios quitando caracteres raros, errores ortogr√°ficos y signos innecesarios como acentos mal puestos, pero sin cambiar el sentido original del mensaje, si llega el mismo mensaje repetido exactamente, varias veces, corriges para que solo envies uno, ",
              "role": "system"
            },
            {
              "content": "=Corrige el siguiente mensaje:\\n\\n{{ $json.message }}\\n\\nDevuelve solo el mensaje corregido"
            }
          ]
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        112,
        -1344
      ],
      "id": "d3135e7e-6234-45ab-8409-41e0f0e87572",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        624,
        -1088
      ],
      "id": "1306584a-a0b1-49cc-a8a9-f99ca523a15c",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "resource": "calendar",
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1088,
        -1088
      ],
      "id": "834dd7ae-4923-4b6f-b1ea-49db34677877",
      "name": "consultar_disponibilidad",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "RMuQyYsn6eGZTZPX",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "en.co#holiday@group.v.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Holidays in Colombia"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1536,
        -1072
      ],
      "id": "63b86405-c9d5-4f53-b2df-646864854f7f",
      "name": "consultar_eventos_dia",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "RMuQyYsn6eGZTZPX",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "start": "={{ $fromAI('Start', `fecha y hora del inicio de la reunion `, 'string') }}",
        "end": "={{ $fromAI('End', `fecha y hora del final de la reunion, normalmente 30 minutos despues de la fecha de inicio`, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ $fromAI('attendees0_Attendees', `correo electr√≥nico del invitado`, 'string') }}"
          ],
          "color": "1",
          "conferenceDataUi": {
            "conferenceDataValues": {
              "conferenceSolution": "hangoutsMeet"
            }
          },
          "description": "={{ $fromAI('Description', `Datos importantes del prospecto, como \nEmpresa: \nCargo: \nObjetivo: \nUrgencia: \nVolumen de operaciones: \nHerramientas actuales: \notros datos recopilados del prospecto. `, 'string') }}",
          "guestsCanInviteOthers": true,
          "sendUpdates": "all",
          "summary": "={{ $fromAI('Summary', ``, 'string') }}",
          "visibility": "private"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1760,
        -1104
      ],
      "id": "1de0dcfb-10a1-402e-9627-cfa5177ba051",
      "name": "agendar_reunion",
      "retryOnFail": false,
      "waitBetweenTries": 2000,
      "maxTries": 2,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "RMuQyYsn6eGZTZPX",
          "name": "hola@whitelabel.lat"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=mensaje del usuario: {{ $json.message }},\nnombre: {{ $json.first_name }}\nnombre completo: {{ $json.name }}\nWhatsApp: {{ $json.WhatsApp  }}",
        "options": {
          "systemMessage": "=**[0] CONTEXTO Y MISI√ìN CENTRAL**\n\n* **Plataforma:** Eres ValeIA una Asistente de IA para Whitelabel.lat, una firma que realiza automatizacion a partir de agentes IA \n* **Variable de Entorno:** La fecha y hora actual es `{{ $now }}`. √ösala para coordinar agendamientos.\n* **Misi√≥n Principal:** Tu objetivo no es solo agendar reuniones, es agendar **reuniones de alto valor**. Act√∫as como un filtro de calidad inteligente para asegurar que el tiempo del equipo comercial se invierta √∫nicamente en prospectos con un problema real que podamos solucionar y que tengan la capacidad de actuar.\n\n**[1] IDENTIDAD Y PERSONALIDAD: LA ALIADA EXPERTA**\n\nEsta es tu esencia. Es innegociable.\n\n* **Rol:** Eres una consultora de diagn√≥stico, no una vendedora.\n* **Tono:** Cercano, seguro y profesionalmente amigable. Transmites la confianza de una experta que sabe de lo que habla.\n* **Trato:** **Hablas siempre \"de t√∫\"**. Olvida el \"usted\". La comunicaci√≥n es directa, emp√°tica y de igual a igual.\n* **Actitud:** Tu motor es la **curiosidad genuina**. Te interesa entender los retos operativos de las empresas. Usas frases que validan y animan a compartir, como \"Entiendo perfecto lo que dices\", \"Gracias por la claridad, eso ayuda mucho\", \"Justo ese es el tipo de reto que nos encanta resolver\".\n\n**[2] FASE 2: DIAGN√ìSTICO LIGERO Y CONVERSACIONAL**\n\nEste es tu flujo l√≥gico. √ösalo como una gu√≠a, adapt√°ndote a la conversaci√≥n, Evita lanzar muchas preguntas. Invita a compartir con contexto y suavidad trata que te envie todo el contexto en una sola nota de voz, asi evitaremos preguntar.\n\n* **FASE 1: APERTURA Y CONEXI√ìN**\n    * **Acci√≥n:** Pres√©ntate de forma concisa y establece el marco de la conversacion.\n    * ‚ÄúHola [Nombre], ¬øqu√© tal? Soy Vale.ia de Whitelabel.lat.\nAyudamos a empresas a escalar sin necesidad de contratar m√°s gente.\nPara respetar tu tiempo, ¬øte parece si me cuentas un poco sobre c√≥mo est√°n funcionando hoy en d√≠a?\nCon eso ya veo si hace sentido tener una charla m√°s a fondo.\n\nSi prefieres mandarme una nota de voz, estaria perfecto üòä‚Äù\n\n* **FASE 2: DIAGN√ìSTICO LIGERO (NO UN FORMULARIO)**\n    * **Instrucci√≥n:** No dispares preguntas como robot. Usa m√°ximo 2 o 3 seg√∫n fluya la conversaci√≥n. Si la persona ya ofrece contexto, valida y avanza.\n\n- Preguntas sugeridas (elige con criterio):\n        * \"¬øSientes que el equipo est√° trabajando al l√≠mite de su capacidad?\"\n        * ‚Äú¬øQu√© tareas repetitivas o procesos sientes que m√°s desgastan al equipo?‚Äù\n        ‚Äú¬øUsan alguna herramienta como CRM, WhatsApp o similar para gestionar operaci√≥n?‚Äù\n        * \"¬øLa idea ser√≠a optimizar la operaci√≥n sin tener que cambiar esas herramientas que ya usan?\"\n        * ‚Äú¬øEn qu√© parte del proceso sientes que se pierde m√°s tiempo?‚Äù\n        * \"Para tomar una decisi√≥n sobre una optimizaci√≥n as√≠, ¬øqui√©n m√°s, adem√°s de ti, participa en el proceso?\"\n\nFrase para avanzar cuando ya hay buen contexto:\n‚ÄúCon eso tengo una muy buena idea inicial. \nEn la reuni√≥n podemos profundizar m√°s si hace sentido.‚Äù\n\n* **FASE 3: MATRIZ DE DECISI√ìN (GO / NO-GO)**\n    * **Instrucci√≥n:** Usa esta l√≥gica interna para decidir si agendar o no. Deben cumplirse la mayor√≠a de los criterios \"CALIFICADO\".\n\n    * **[LUZ VERDE - AGENDAR] Prospecto CALIFICADO:**\n        * Equipo de 5+ personas con sobrecarga evidente.\n        * Procesos manuales y repetitivos identificados.\n        * Uso de herramientas digitales (est√°n en el ecosistema).\n        * Urgencia clara (calificaci√≥n 6+).\n        * Es o tiene acceso directo al tomador de decisiones.\n\n    * **[LUZ ROJA - DESCARTAR AMABLEMENTE] Prospecto NO CALIFICADO:**\n        * Menos de 5 empleados sin planes de escalar.\n        * Sin urgencia o dolor aparente (\"estamos bien as√≠\").\n        * No es la persona adecuada y no tiene acceso a quien decide.\n        * **Guion de Cierre Amable:** *Ver secci√≥n [5] Cierres de Conversaci√≥n.*\n\n**[3] PROTOCOLO DE AGENDAMIENTO: EL CIERRE EXITOSO**\n\n*Activa este protocolo S√ìLO despu√©s de una decisi√≥n \"LUZ VERDE\". Es un flujo de di√°logo, no una lista de tareas.*\n\n* **Paso 1. Transici√≥n de Confianza:**\n    * \"Gracias por compartir esto. Lo que mencionas sobre [mencionar el dolor principal, ej: 'el tiempo que pierden en tareas manuales'] es el tipo de reto que nos encanta resolver. Estoy segura de que podemos ayudar.\"\n\n* **Paso 2. Propuesta de Valor (La Reuni√≥n):**\n    * \"El siguiente paso l√≥gico es agendar una sesi√≥n de diagn√≥stico de 30 minutos con un especialista. Ah√≠ podr√°n analizar tu operaci√≥n a fondo y mostrarte, sin ning√∫n compromiso, c√≥mo se ver√≠a una soluci√≥n. ¬øQu√© te parece?\"\n\n* **Paso 3. Log√≠stica Amigable (Recopilaci√≥n de Datos):**\n    * *(Una vez que el prospecto dice \"s√≠\" o muestra inter√©s)*  \n      \"¬°Genial! Para que la reuni√≥n sea s√∫per productiva y nuestro especialista llegue con ideas claras para ti, necesito confirmar un par de datos.  \n      Primero, para enviarte la invitaci√≥n, ¬øme confirmas tu nombre completo (solo si detectas que el nombre que llega en userPrompt no es el del usuario), el nombre de tu empresa, tu cargo y tu email?\"\n\n* **Paso 4. Coordinaci√≥n Sencilla (proceso interno y respuesta al usuario):**\n    * Usa la herramienta `consultar_disponibilidad` para obtener los horarios disponibles lo m√°s pronto posible desde `{{ $now }}`.\n    * Encuentra:\n        * Una opci√≥n **en la ma√±ana** (entre 9:00 a.m. y 11:00 a.m.).\n        * Una opci√≥n **en la tarde** (entre 2:00 p.m. y 5:00 p.m.).\n    * Ambos horarios deben ser para el **d√≠a m√°s cercano disponible** (ma√±ana, pasado ma√±ana o el d√≠a h√°bil m√°s pr√≥ximo).\n    * Evita s√°bados, domingos o festivos.\n    * Una vez tengas los dos horarios, resp√≥ndele al usuario con un mensaje amigable, por ejemplo:  \n      \"¬°Perfecto! Tengo estas dos opciones cercanas: ma√±ana a las 10:00 a.m. o pasado ma√±ana a las 3:00 p.m. ¬øCu√°l prefieres?\"\n\n* **Paso 5. Participantes Clave (confirmaci√≥n final):**\n    * Despu√©s de enviar las opciones de reuni√≥n, consulta si hay alguien m√°s que deba participar:  \n      \"Y para asegurarnos de que la conversaci√≥n sea lo m√°s √°gil posible, ¬øhay alguien m√°s de tu equipo que consideres clave que participe en esta primera charla?\"  \n    * Solicita tambi√©n el **nombre** y el **correo electr√≥nico** de la persona tomadora de decisi√≥n o que se deba incluir en la reuni√≥n.\n\nsiempre envia la confirmacion de la reunion, con el enlace de la misma. \n\n**[4] GESTI√ìN AVANZADA DE OBJECIONES**\n\n* **\"No tengo tiempo para reuniones\":** \"Te entiendo perfectamente. De hecho, existimos para devolverle tiempo a equipos como el tuyo. Estos 30 minutos son una inversi√≥n para ahorrarles horas cada semana. Si vemos que no podemos ayudarte, seremos los primeros en decirlo.\"\n* **\"Ya probamos automatizaci√≥n y no funcion√≥\":** \"Esa experiencia es muy valiosa, gracias por compartirla. Para no repetir errores, cu√©ntame, ¬øqu√© fue lo que no funcion√≥ como esperaban? As√≠ vemos si nuestro enfoque es realmente diferente.\"\n* **\"No estoy seguro si lo necesitamos\":** \"Esa es una duda totalmente v√°lida. Justamente para eso es esta primera charla sin compromiso: para que ambos evaluemos si esto tiene sentido para ustedes ahora mismo. No se trata de vender, se trata de diagnosticar.\"\n\n**[5] CIERRES DE CONVERSACI√ìN**\n\n* **Si se agenda la reuni√≥n:**\n    * \"¬°Listo, [Nombre]! Agendado para el [fecha] a las [hora]. Ya mismo te env√≠o la invitaci√≥n a tu correo con todos los detalles para que la aceptes. Va a ser una sesi√≥n muy valiosa. ¬°Hablamos pronto!\"\n* **Si el prospecto no califica (Cierre Amable):**\n    * \"Te agradezco un mont√≥n la transparencia, [Nombre]. Por lo que me cuentas, parece que de momento tienen todo bajo control y no es una prioridad urgente. Respeto mucho eso. Si m√°s adelante las cosas cambian y escalar se vuelve un objetivo clave, ya sabes d√≥nde encontrarnos. ¬°Que tengas un excelente d√≠a!\"\n\n**[6] REGLAS DE ORO Y L√çMITES (INQUEBRANTABLES)**\n\n1.  **NUNCA des precios o estimaciones.** Tu guion es: \"Los costos dependen de cada operaci√≥n. Se revisan en detalle en la reuni√≥n de diagn√≥stico para crear una propuesta a medida\".\n2.  **NUNCA prometas resultados espec√≠ficos.** Habla de potencial y de casos de √©xito, no de garant√≠as.\n3.  **NUNCA agendes una reuni√≥n si no se cumplen los criterios de calificaci√≥n.** Tu lealtad es con la calidad de la reuni√≥n, no con la cantidad.\n4.  **SIEMPRE mant√©n el control de la conversaci√≥n** guiando con preguntas.\n5.  **SIEMPRE finaliza con un siguiente paso claro y definido** (reuni√≥n agendada o despedida amable).\n6.  **Trata que no se hagan mas de 2 o 3 preguntas, puedes hacer que te envie un audio contandote todo lo que necesites**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1024,
        -1376
      ],
      "id": "9683e582-b8ec-4900-b802-d8b486411290",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=chat_history_valeia_{{ $('Data').item.json.user_id }}",
        "sessionTTL": 500000,
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        864,
        -1056
      ],
      "id": "f70aa1ea-bfb5-4e17-84e2-1d27b78fe67f",
      "name": "Redis Chat Memory1",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<img>{{ $json.content.parts[0].text }}</img>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        -1696
      ],
      "id": "605c574d-6e07-4b03-afc6-78f3300d8602",
      "name": "DataImage"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<pdf>{{ $json.content.parts[0].text }}</pdf>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        -1888
      ],
      "id": "12c69d61-abde-49cb-a2b6-768f785f6842",
      "name": "DataPdf"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "key": "phone_number",
              "value": "={{ $json.phone_number }}"
            },
            {
              "key": "tipo_mensaje",
              "value": "={{ $json.tipo_mensaje }}"
            },
            {
              "key": "mensaje",
              "value": "={{ $json.mensaje }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        960,
        -1984
      ],
      "id": "23ab4878-c04e-48ab-8e2e-1dea07a05e6e",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38cdad62-0d9c-45bc-860e-9e03d107ba58"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "82df4052-c480-44a2-9d09-c195d4bc6879",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d9c1a8cf-af4e-4bca-a66c-184829c009d8",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "=file",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "document"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "71778507-22f2-4e0f-99d7-fdd87ed1f26b",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        64,
        -2016
      ],
      "id": "b7b59226-b11f-4b24-8b1f-074c6835a35d",
      "name": "type message Whatsap"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $('initData').item.json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        -2080
      ],
      "id": "a2661501-a0c7-432f-a1fb-a8caaa42d64c",
      "name": "DataText"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        288,
        -2080
      ],
      "id": "933793ca-5891-4134-961d-d6b3d09e2ade",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<audio>{{ $json.content.parts[0].text }}</audio>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        -2272
      ],
      "id": "06462352-4985-4c54-9db0-4793e38d766f",
      "name": "DataAudio"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=chat_id_{{ $('setData').item.json.phone_number }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2304,
        -2080
      ],
      "id": "8c9aefa2-26ce-429c-bfdc-1a5bc0a45352",
      "name": "Redis6",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2080,
        -1888
      ],
      "id": "a3146725-99ad-4535-889f-f2a74cdc7085",
      "name": "No Operation, do nothing7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7fe6665-ef0d-4ec2-9800-88004951e528",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('setData').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1856,
        -1984
      ],
      "id": "41bf1e8e-4ebe-4f4b-a596-404a3cf697fb",
      "name": "If2"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "=chat_id_{{ $json.phone_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1632,
        -1984
      ],
      "id": "22fbb43d-e1ae-4993-8331-c09c69635f7e",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1408,
        -1984
      ],
      "id": "77be34dc-d05b-455d-8819-f5c159c53cc1",
      "name": "Wait1",
      "webhookId": "c42fd9d6-416c-4950-8662-76e241fbd897"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=chat_id_{{ $json.phone_number }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1184,
        -1984
      ],
      "id": "e15aec55-916e-4d86-893c-7f7b78fb1d5d",
      "name": "Push Message1",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Incoming Messages\n",
        "height": 812,
        "width": 2512,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -16,
        -2336
      ],
      "id": "dab9bbcd-a88d-49ce-8daa-9678381eaa7a",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsap",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -848,
        -2288
      ],
      "id": "5618d2e5-2f89-4f3f-8ff6-6a1ffbf9107f",
      "name": "whatsap trigger",
      "webhookId": "6704f599-c49e-4dd2-848c-7d9401baf9a1",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f4f107ad-f4e3-4616-a1ec-515f7324ba23",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "6f55c6f4-4cb3-4cec-9d31-b956d3fffde0",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "bad14eb8-f005-4d91-bd83-600e6105d974",
              "name": "mensaje",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        736,
        -1984
      ],
      "id": "2597956b-97ed-4ae7-80ea-17660af5acf9",
      "name": "setData"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "audioUrls": "={{ $json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        288,
        -2272
      ],
      "id": "0d729530-e18f-4bba-8ab2-fb2c4889f1da",
      "name": "Transcribe a recording1",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash-lite",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash-lite"
        },
        "text": "Act√∫a como un contador p√∫blico certificado experto en Colombia, con amplios conocimientos tributarios y financieros en Am√©rica Latina. Tambi√©n eres un ingeniero experto en prompts y an√°lisis OCR. Tu tarea es analizar de forma precisa y estructurada la imagen proporcionada (comprobante, recibo, factura, voucher, etc.) y extraer la siguiente informaci√≥n en formato JSON, validando cada campo cuidadosamente:\n\n1. **Tipo de Documento**: (Ej: Factura POS, Factura Electr√≥nica, Recibo de Caja, Voucher, Cuenta de Cobro, etc.)\n2. **Fecha del Comprobante**: en formato `dd-mm-yyyy`. (Validar que no est√© incompleta o ausente).\n3. **Monto Total**: En pesos colombianos (COP). Usar solo valores totales (ignorar subtotales).\n4. **Glosa / Descripci√≥n**: Breve texto explicando de qu√© trata el gasto o ingreso (Ej: \"Compra de v√≠veres\", \"Pago de arriendo\", etc.)\n5. **Proveedor o Comercio**: Nombre del establecimiento donde se hizo la transacci√≥n.\n6. **NIT o Documento Tributario**: Detecta y extrae el NIT del proveedor. Si no existe NIT, intenta identificar c√©dula o alg√∫n documento oficial. Si no se encuentra, informar que no hay documento tributario.\n7. **M√©todo de Pago**: Detectar si fue con Efectivo, Tarjeta de Cr√©dito, Tarjeta de D√©bito, Transferencia, Nequi, Daviplata, etc. (En caso de duda, indicar \"No especificado\").\n8. **Categor√≠a sugerida** (opcional): Prop√≥n una categor√≠a financiera general (Ej: Alimentaci√≥n, Transporte, Servicios, Arriendo, etc.).\n9. **Ingreso o Gasto**: Detectar si el documento corresponde a un **Ingreso** o un **Gasto**, basado en contexto, glosa y encabezados.\n\nAdem√°s, incluye al final una breve descripci√≥n en lenguaje natural del tipo de imagen analizada. Por ejemplo: ‚ÄúSe trata de un recibo POS con fecha clara y valor total, pero no se detecta NIT.‚Äù o ‚ÄúFactura electr√≥nica v√°lida con todos los campos presentes‚Äù.\n\nüîé Si falta alguno de los datos obligatorios (como fecha, monto), ind√≠calo expl√≠citamente con el mensaje `\"error\": \"Campo faltante: ...\"` o `\"advertencia\": \"No se detect√≥ la fecha del documento \"`.\n\nTu respuesta debe estar en formato JSON estructurado y f√°cil de procesar por un sistema automatizado.\n",
        "imageUrls": "={{ $json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        288,
        -1696
      ],
      "id": "a134d132-0acb-4c00-933a-7e5f24dfb34a",
      "name": "Analyze image1",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash-lite",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash-lite"
        },
        "text": "Act√∫a como un contador p√∫blico certificado experto en Colombia, con amplios conocimientos tributarios y financieros en Am√©rica Latina. Tambi√©n eres un ingeniero experto en prompts y an√°lisis OCR. Tu tarea es analizar de forma precisa y estructurada la imagen proporcionada (comprobante, recibo, factura, voucher, etc.) y extraer la siguiente informaci√≥n en formato JSON, validando cada campo cuidadosamente:\n\n1. **Tipo de Documento**: (Ej: Factura POS, Factura Electr√≥nica, Recibo de Caja, Voucher, Cuenta de Cobro, etc.)\n2. **Fecha del Comprobante**: en formato `dd-mm-yyyy`. (Validar que no est√© incompleta o ausente).\n3. **Monto Total**: En pesos colombianos (COP). Usar solo valores totales (ignorar subtotales).\n4. **Glosa / Descripci√≥n**: Breve texto explicando de qu√© trata el gasto o ingreso (Ej: \"Compra de v√≠veres\", \"Pago de arriendo\", etc.)\n5. **Proveedor o Comercio**: Nombre del establecimiento donde se hizo la transacci√≥n.\n6. **NIT o Documento Tributario**: Detecta y extrae el NIT del proveedor. Si no existe NIT, intenta identificar c√©dula o alg√∫n documento oficial. Si no se encuentra, informar que no hay documento tributario.\n7. **M√©todo de Pago**: Detectar si fue con Efectivo, Tarjeta de Cr√©dito, Tarjeta de D√©bito, Transferencia, Nequi, Daviplata, etc. (En caso de duda, indicar \"No especificado\").\n8. **Categor√≠a sugerida** (opcional): Prop√≥n una categor√≠a financiera general (Ej: Alimentaci√≥n, Transporte, Servicios, Arriendo, etc.).\n9. **Ingreso o Gasto**: Detectar si el documento corresponde a un **Ingreso** o un **Gasto**, basado en contexto, glosa y encabezados.\n\nAdem√°s, incluye al final una breve descripci√≥n en lenguaje natural del tipo de imagen analizada. Por ejemplo: ‚ÄúSe trata de un recibo POS con fecha clara y valor total, pero no se detecta NIT.‚Äù o ‚ÄúFactura electr√≥nica v√°lida con todos los campos presentes‚Äù.\n\nüîé Si falta alguno de los datos obligatorios (como fecha, monto), ind√≠calo expl√≠citamente con el mensaje `\"error\": \"Campo faltante: ...\"` o `\"advertencia\": \"No se detect√≥ la fecha del documento \"`.\n\nTu respuesta debe estar en formato JSON estructurado y f√°cil de procesar por un sistema automatizado.",
        "documentUrls": "={{ $json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        288,
        -1888
      ],
      "id": "dd5ee8b2-33c2-47e1-90c2-a39a1330199e",
      "name": "Analyze document",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $('Redis1').item.json.message.join('\\n').replace(/test/gi, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2080,
        -2080
      ],
      "id": "b16be175-31b3-40ec-8282-fda69612e161",
      "name": "Unir Mensajes"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=\nDivide el siguiente mensaje en hasta *4 partes m√°s peque√±as* solo si es necesario, asegur√°ndote de que cada parte tenga sentido completo.\n\n### *Reglas:*\n\n- Si el mensaje es *corto* (hasta *160 caracteres*), devu√©lvelo en *una sola parte*.\n\n- Si es *mediano* (hasta *400 caracteres*), div√≠delo en *2 partes*.\n\n- Si es *largo* (hasta *600 caracteres*), div√≠delo en *3 partes*.\n\n- Si es *muy largo* (m√°s de *600 caracteres*), agr√©gale una *parte4*.\n\n- *Evita dividir el mensaje innecesariamente*. Usa la *menor cantidad de partes posible*.\n\n- *No cortes oraciones en puntos, comas o conectores* para mantener la coherencia.\n\n- *Si hay una lista con varios √≠tems, no se debe dividir*, toda la lista debe ir en un mismo mensaje.\n\n- *No incluyas datos sensibles del usuario* en la respuesta, como:\n\n  - `user_id: <n√∫mero>`\n  - `subscriber_id: <n√∫mero>`\n  - `first_name: <nombre>`\n  - *Elimina estos datos sin dejar rastros.*\n\n- *Si no hay mensaje, no devuelvas nada.*\n\n---\n\n### *Formato de Salida:*\n\n- Devuelve la respuesta en *formato JSON* con *solo las partes necesarias*.\n- Usa `\\n\\n` para agregar saltos de l√≠nea cuando sea necesario o para mejorar la legibilidad en listas.\n- *Nunca uses comillas `\"` para resaltar palabras*. En su lugar, usa un solo asterisco: *palabra*.\n\n#### *Ejemplo de salida:*\n\n{\n\"parte1\": \"Texto de la primera parte.\",\n\"parte2\": \"Texto de la segunda parte.\"\n}\n\n### *Mensaje:*\n\n\"{{ $json.output }}\"\n"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        160,
        -640
      ],
      "id": "c7e0a775-e14d-44c0-b699-fadc2da7ce1a",
      "name": "Message a model1",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mony",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1024,
        -1888
      ],
      "id": "45ed3f18-c1c2-49ae-9c8a-afd23d9d571c",
      "name": "Webhook",
      "webhookId": "afc7954a-020f-4194-89fd-fa609358b4b0"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "24753cf1-0e65-46ba-8117-cafa44f119a0",
              "name": "metadata",
              "value": "={\n\"account_id\": \n\"{{ $json.body.account.id }}\",\n\"conversation_id\": \n\"{{ $json.body.conversation.messages[0].conversation_id }}\"\n}",
              "type": "object"
            },
            {
              "id": "e6ac796a-86cf-4dce-a3f3-1f3b8ea8e180",
              "name": "contacts",
              "value": "=[{\n\"profile\": \n{\n\"name\": \n\"{{ $json.body.conversation.meta.sender.name.split(' ')[0] }}\"\n},\n\"wa_id\": \n\"{{ $json.body.conversation.messages[0].conversation.contact_inbox.source_id }}\"\n}]",
              "type": "array"
            },
            {
              "id": "fe4740db-2480-4726-a9ff-e74b454ce8e0",
              "name": "messages",
              "value": "= [{ \"from\":  \"{{ $json.body.conversation.meta.sender.phone_number }}\", \"id\":  \"{{ $json.body.conversation.messages[0].id }}\", \"timestamp\":  \"{{ $json.body.conversation.messages[0].created_at }}\",\n\"text\":  { \"body\":  {{ JSON.stringify($json.body.conversation.messages[0].content) }} },\n\"file\":  { \"body\":  \"{{ $json.body.conversation.messages[0].attachments[0].data_url }}\" },\n\"type\":  \"{{ $json.body.attachments?.[0]?.file_type || $json.body.conversation.messages?.[0]?.content_type }}\" }]",
              "type": "array"
            },
            {
              "id": "8bf1bf21-59a9-4c92-8e31-7e20a7cae8d4",
              "name": "field",
              "value": "={{ $json.body.conversation.labels }}",
              "type": "array"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -576,
        -1984
      ],
      "id": "8b05ddde-7986-4a24-bd8b-abf47cd24b8a",
      "name": "WhatsApp Trigger"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "abaa9de2-4388-46df-9440-7c458be2669a",
              "leftValue": "={{ $json.body.message_type }}",
              "rightValue": "incoming",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "2b50ffbe-a3c8-4299-b6f3-86f9f79de33b",
              "leftValue": "={{ $json.body.conversation.labels }}",
              "rightValue": "=apagar-agente",
              "operator": {
                "type": "array",
                "operation": "notContains",
                "rightType": "any"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -800,
        -1888
      ],
      "id": "fba175fb-7a3a-472d-bad6-0fba72a4ce19",
      "name": "If1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -576,
        -1792
      ],
      "id": "6116a8a3-5384-4725-8d76-bcc6bd252f2b",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "name",
              "value": "={{ $json.contacts[0].profile.name }}"
            },
            {
              "key": "phone",
              "value": "={{ $json.messages[0].from }}"
            },
            {
              "key": "message",
              "value": "={{ $json.messages[0].text.body }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -352,
        -1984
      ],
      "id": "83604ef4-62e8-46e2-a3a9-d0227b77a456",
      "name": "Execution Data1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9d776135-119d-4f26-b527-ab8bbf287a82",
              "name": "metadata",
              "value": "={{ $json.metadata }}",
              "type": "object"
            },
            {
              "id": "b6cb9f52-1a4c-4f2c-9b4b-34fd6e3a8d8b",
              "name": "contacts",
              "value": "={{ $json.contacts }}",
              "type": "array"
            },
            {
              "id": "c9ae006b-e74b-44b6-b1ca-2ade7ae36c06",
              "name": "messages",
              "value": "={{ $json.messages }}",
              "type": "array"
            },
            {
              "id": "2fd7d02b-a2ab-4372-aa73-9fad91ba0f5d",
              "name": "field",
              "value": "={{ $json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -160,
        -1984
      ],
      "id": "ca7dfa0e-2f32-4e34-93ef-a766b0dabc8f",
      "name": "initData"
    }
  ],
  "pinData": {
    "whatsap trigger": [
      {
        "json": {
          "messaging_product": "whatsapp",
          "metadata": {
            "display_phone_number": "573143400476",
            "phone_number_id": "735679592965149"
          },
          "contacts": [
            {
              "profile": {
                "name": "Pedro Rodriguez"
              },
              "wa_id": "573228854498"
            }
          ],
          "messages": [
            {
              "from": "573228854498",
              "id": "wamid.HBgMNTczMjI4ODU0NDk4FQIAEhgUM0ZCOUNFRjE5M0FFNzZENzAxQUEA",
              "timestamp": "1755298718",
              "text": {
                "body": "organizar gastos"
              },
              "type": "text"
            }
          ],
          "field": "messages"
        }
      }
    ],
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "automation.whitelabel.lat",
            "user-agent": "rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34",
            "content-length": "2782",
            "accept": "application/json",
            "accept-encoding": "gzip;q=1.0,deflate;q=0.6,identity;q=0.3",
            "content-type": "application/json",
            "x-forwarded-for": "54.82.14.220",
            "x-forwarded-host": "automation.whitelabel.lat",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "4f3b0c84f963",
            "x-real-ip": "54.82.14.220"
          },
          "params": {},
          "query": {},
          "body": {
            "account": {
              "id": 3,
              "name": "Mony"
            },
            "additional_attributes": {},
            "content_attributes": {},
            "content_type": "text",
            "content": "Tuve 180.000 ayer \n\nGaste 28.000 en cosas para m√≠ primer d√≠a de trabajo. \nGaste 30.000 en transporte a una conferencia.\nGaste 64000 en transportes",
            "conversation": {
              "additional_attributes": {},
              "can_reply": true,
              "channel": "Channel::Whatsapp",
              "contact_inbox": {
                "id": 216,
                "contact_id": 217,
                "inbox_id": 2,
                "source_id": "573018080570",
                "created_at": "2025-08-27T22:57:33.702Z",
                "updated_at": "2025-08-27T22:57:33.702Z",
                "hmac_verified": false,
                "pubsub_token": "ossGkNcZmrmjgwbzimBWupxE"
              },
              "id": 214,
              "inbox_id": 2,
              "messages": [
                {
                  "id": 1358,
                  "content": "Tuve 180.000 ayer \n\nGaste 28.000 en cosas para m√≠ primer d√≠a de trabajo. \nGaste 30.000 en transporte a una conferencia.\nGaste 64000 en transportes",
                  "account_id": 3,
                  "inbox_id": 2,
                  "conversation_id": 214,
                  "message_type": 0,
                  "created_at": 1756336167,
                  "updated_at": "2025-08-27T23:09:27.875Z",
                  "private": false,
                  "status": "sent",
                  "source_id": "wamid.HBgMNTczMDE4MDgwNTcwFQIAEhggMjRFRTZDRkE5RjU4M0ZCMDdFRDQ3QTc2OUFBQUQxREYA",
                  "content_type": "text",
                  "content_attributes": {},
                  "sender_type": "Contact",
                  "sender_id": 217,
                  "external_source_ids": {},
                  "additional_attributes": {},
                  "processed_message_content": "Tuve 180.000 ayer \n\nGaste 28.000 en cosas para m√≠ primer d√≠a de trabajo. \nGaste 30.000 en transporte a una conferencia.\nGaste 64000 en transportes",
                  "sentiment": {},
                  "conversation": {
                    "assignee_id": null,
                    "unread_count": 10,
                    "last_activity_at": 1756336167,
                    "contact_inbox": {
                      "source_id": "573018080570"
                    }
                  },
                  "sender": {
                    "additional_attributes": {},
                    "custom_attributes": {},
                    "email": null,
                    "id": 217,
                    "identifier": null,
                    "name": "Valentina",
                    "phone_number": "+573018080570",
                    "thumbnail": "",
                    "blocked": false,
                    "type": "contact"
                  }
                }
              ],
              "labels": [],
              "meta": {
                "sender": {
                  "additional_attributes": {},
                  "custom_attributes": {},
                  "email": null,
                  "id": 217,
                  "identifier": null,
                  "name": "Valentina",
                  "phone_number": "+573018080570",
                  "thumbnail": "",
                  "blocked": false,
                  "type": "contact"
                },
                "assignee": null,
                "team": null,
                "hmac_verified": false
              },
              "status": "pending",
              "custom_attributes": {},
              "snoozed_until": null,
              "unread_count": 10,
              "first_reply_created_at": null,
              "priority": null,
              "waiting_since": 1756335453,
              "agent_last_seen_at": 0,
              "contact_last_seen_at": 0,
              "last_activity_at": 1756336167,
              "timestamp": 1756336167,
              "created_at": 1756335453,
              "updated_at": 1756336167.8773613
            },
            "created_at": "2025-08-27T23:09:27.875Z",
            "id": 1358,
            "inbox": {
              "id": 2,
              "name": "Whatsapp Mony"
            },
            "message_type": "incoming",
            "private": false,
            "sender": {
              "account": {
                "id": 3,
                "name": "Mony"
              },
              "additional_attributes": {},
              "avatar": "",
              "custom_attributes": {},
              "email": null,
              "id": 217,
              "identifier": null,
              "name": "Valentina",
              "phone_number": "+573018080570",
              "thumbnail": "",
              "blocked": false
            },
            "source_id": "wamid.HBgMNTczMDE4MDgwNTcwFQIAEhggMjRFRTZDRkE5RjU4M0ZCMDdFRDQ3QTc2OUFBQUQxREYA",
            "event": "message_created"
          },
          "webhookUrl": "https://automation.whitelabel.lat/webhook/mony",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "7CI8d1lC1EC1eqnL"
  },
  "shared": [
    {
      "createdAt": "2025-05-22T03:11:30.320Z",
      "updatedAt": "2025-05-22T03:11:30.320Z",
      "role": "workflow:owner",
      "workflowId": "AdcpHFHuUVLPnrVw",
      "projectId": "jOPTDk8NtR0eZIqG"
    }
  ],
  "staticData": {
    "node:Formbricks": {}
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-08-28T20:10:07.348Z",
  "versionId": "8550359b-da50-43f1-a5d2-7cedcd003633"
}