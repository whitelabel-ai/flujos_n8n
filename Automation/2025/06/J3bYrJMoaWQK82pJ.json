{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Webhook1": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Google Sheets3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "solicitud a proveedores para actualizar",
            "type": "main",
            "index": 0
          },
          {
            "node": "Actualizaciones",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agregar nuevo producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets3": {
      "main": [
        [
          {
            "node": "Get Proveedores1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Proveedores1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Cancelacion Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelacion Mensaje": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Productos Solicitados1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items4": {
      "main": [
        [],
        [
          {
            "node": "Wait5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Order1": {
      "main": [
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait5": {
      "main": [
        [
          {
            "node": "Send Order1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items5": {
      "main": [
        [],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Productos Solicitados1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Google Sheets5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Update Status1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items6": {
      "main": [
        [],
        [
          {
            "node": "Wait6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait6": {
      "main": [
        [
          {
            "node": "Status Cancelar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets5": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Cancelar Pedido": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "solicitud a proveedores para actualizar": {
      "main": [
        [
          {
            "node": "Solicitudes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Solicitudes": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizaciones": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items7": {
      "main": [
        [],
        [
          {
            "node": "Wait7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Order2": {
      "main": [
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait7": {
      "main": [
        [
          {
            "node": "Google Sheets4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets2": {
      "main": [
        [
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items8": {
      "main": [
        [],
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait8": {
      "main": [
        [
          {
            "node": "Google Sheets2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Wait8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets4": {
      "main": [
        [
          {
            "node": "Send Order2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status2": {
      "main": [
        [
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code5": {
      "main": [
        [
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets6": {
      "main": [
        [
          {
            "node": "Update Status2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items9": {
      "main": [
        [],
        [
          {
            "node": "Google Sheets6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message1": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-20T17:04:35.550Z",
  "id": "J3bYrJMoaWQK82pJ",
  "isArchived": false,
  "meta": null,
  "name": "3. Actualizar Pedidos de Clientes",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "order-update",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2224,
        1248
      ],
      "id": "0b251d0d-fb52-4eac-a3fb-2547b867abf1",
      "name": "Webhook1",
      "webhookId": "589fc230-8dbc-4987-8d13-eee96159157a"
    },
    {
      "parameters": {
        "jsCode": "const body = items[0].json.body;\n\nconst prev = body.previousOrder.products;\nconst updated = body.updatedOrder.products;\n\n// Funci√≥n para formatear fecha\nfunction formatearFecha(fechaISO) {\n  const fecha = new Date(fechaISO);\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const a√±o = fecha.getFullYear();\n  const horas = String(fecha.getHours()).padStart(2, '0');\n  const minutos = String(fecha.getMinutes()).padStart(2, '0');\n  const segundos = String(fecha.getSeconds()).padStart(2, '0');\n  return `${dia}/${mes}/${a√±o}, ${horas}:${minutos}:${segundos}`;\n}\n\nconst fechaFormateada = formatearFecha(body.updatedOrder.createdAt);\nlet resultados = [];\n\n// Recorremos productos actualizados\nfor (let i = 0; i < updated.length; i++) {\n  const productoNuevo = updated[i];\n  const productoPrevio = prev.find(p =>\n    p.product.name === productoNuevo.product.name &&\n    p.palet.name === productoNuevo.palet.name\n  );\n\n  if (!productoPrevio) {\n    const mismoProductoOtroPalet = prev.find(p =>\n      p.product.name === productoNuevo.product.name &&\n      p.palet.name !== productoNuevo.palet.name\n    );\n\n    if (mismoProductoOtroPalet) {\n      resultados.push({\n        tipo: 'Delete',\n        NUM_PEDIDO: body.updatedOrder.receptionNumber,\n        CIF_CLIENTE: body.updatedOrder.clientCIF,\n        NOMBRE_CLIENTE: body.updatedOrder.clientName,\n        PRODUCTOS: mismoProductoOtroPalet.product.name,\n        PALET: mismoProductoOtroPalet.palet.name,\n        CANT_PALETS: mismoProductoOtroPalet.paletQuantity,\n        CAJAS: mismoProductoOtroPalet.caja.name,\n        CANT_CAJAS: mismoProductoOtroPalet.cajaQuantity,\n        STATUS: body.updatedOrder.status,\n        FECHA: fechaFormateada\n      });\n\n      resultados.push({\n        tipo: 'New',\n        NUM_PEDIDO: body.updatedOrder.receptionNumber,\n        CIF_CLIENTE: body.updatedOrder.clientCIF,\n        NOMBRE_CLIENTE: body.updatedOrder.clientName,\n        PRODUCTOS: productoNuevo.product.name,\n        PALET: productoNuevo.palet.name,\n        CANT_PALETS: productoNuevo.paletQuantity,\n        CAJAS: productoNuevo.caja.name,\n        CANT_CAJAS: productoNuevo.cajaQuantity,\n        STATUS: body.updatedOrder.status,\n        FECHA: fechaFormateada\n      });\n    } else {\n      resultados.push({\n        tipo: 'New',\n        NUM_PEDIDO: body.updatedOrder.receptionNumber,\n        CIF_CLIENTE: body.updatedOrder.clientCIF,\n        NOMBRE_CLIENTE: body.updatedOrder.clientName,\n        PRODUCTOS: productoNuevo.product.name,\n        PALET: productoNuevo.palet.name,\n        CANT_PALETS: productoNuevo.paletQuantity,\n        CAJAS: productoNuevo.caja.name,\n        CANT_CAJAS: productoNuevo.cajaQuantity,\n        STATUS: body.updatedOrder.status,\n        FECHA: fechaFormateada\n      });\n    }\n    continue;\n  }\n\n  const cambios = [];\n\n  // Verificamos cambios y preparamos el entry solo si hay cambios reales\n  if (productoNuevo.paletQuantity !== productoPrevio.paletQuantity) {\n    cambios.push(`CANT_PALETS: ${productoPrevio.paletQuantity} ‚Üí ${productoNuevo.paletQuantity}`);\n  }\n\n  if (productoNuevo.cajaQuantity !== productoPrevio.cajaQuantity) {\n    cambios.push(`CANT_CAJAS: ${productoPrevio.cajaQuantity} ‚Üí ${productoNuevo.cajaQuantity}`);\n  }\n\n  if (productoNuevo.caja.name !== productoPrevio.caja.name) {\n    cambios.push(`CAJAS: ${productoPrevio.caja.name} ‚Üí ${productoNuevo.caja.name}`);\n  }\n\n  if (cambios.length > 0) {\n    resultados.push({\n      tipo: 'Update',\n      NUM_PEDIDO: body.updatedOrder.receptionNumber,\n      CIF_CLIENTE: body.updatedOrder.clientCIF,\n      NOMBRE_CLIENTE: body.updatedOrder.clientName,\n      PRODUCTOS: productoNuevo.product.name,\n      PALET: productoNuevo.palet.name,\n      CANT_PALETS: productoNuevo.paletQuantity,\n      CANT_PALETS_ANTES: productoPrevio.paletQuantity,\n      CAJAS: productoNuevo.caja.name,\n      CAJAS_ANTES: productoPrevio.caja.name,\n      CANT_CAJAS: productoNuevo.cajaQuantity,\n      CANT_CAJAS_ANTES: productoPrevio.cajaQuantity,\n      CAMBIOS: cambios.join(' | '),\n      STATUS: body.updatedOrder.status,\n      FECHA: fechaFormateada\n    });\n  }\n}\n\n// Verificar eliminados\nfor (let i = 0; i < prev.length; i++) {\n  const pPrev = prev[i];\n  const existe = updated.find(p =>\n    p.product.name === pPrev.product.name &&\n    p.palet.name === pPrev.palet.name\n  );\n  if (!existe) {\n    resultados.push({\n      tipo: 'Delete',\n      NUM_PEDIDO: body.updatedOrder.receptionNumber,\n      CIF_CLIENTE: body.updatedOrder.clientCIF,\n      NOMBRE_CLIENTE: body.updatedOrder.clientName,\n      PRODUCTOS: pPrev.product.name,\n      PALET: pPrev.palet.name,\n      CANT_PALETS: pPrev.paletQuantity,\n      CAJAS: pPrev.caja.name,\n      CANT_CAJAS: pPrev.cajaQuantity,\n      STATUS: body.updatedOrder.status,\n      FECHA: fechaFormateada\n    });\n  }\n}\n\n// Eliminar duplicados exactos\nfunction deduplicar(array) {\n  const seen = new Set();\n  return array.filter(item => {\n    const clave = `${item.tipo}|${item.PRODUCTOS}|${item.PALET}|${item.CAJAS}|${item.CANT_CAJAS}|${item.CANT_PALETS}`;\n    if (seen.has(clave)) {\n      return false;\n    }\n    seen.add(clave);\n    return true;\n  });\n}\n\nconst resultadosUnicos = deduplicar(resultados);\n\nreturn resultadosUnicos.map(r => ({ json: r }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2000,
        1248
      ],
      "id": "594ae5a2-c9b6-4ec1-b5e0-492402f7d62e",
      "name": "Code4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8b7e7eed-e35c-4067-8889-8972d8b0e4a8",
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "Delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Eliminar Producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6388165d-4c6e-4855-8e67-cbfae97af8d7",
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "Update",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Actualizar Producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "New",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "454cdc57-e42b-4a5e-bb4c-1335cff03519"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Nuevo producto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1776,
        1248
      ],
      "id": "11d10bda-8863-4083-82ba-c544301e03ad",
      "name": "Switch"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTOS }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "CAJAS",
              "lookupValue": "={{ $json.CAJAS }}"
            },
            {
              "lookupColumn": "STATUS",
              "lookupValue": "=Solicitado"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1568,
        288
      ],
      "id": "e883884b-17af-4843-84bc-a55d825f01d0",
      "name": "Google Sheets3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1996169798,
          "mode": "list",
          "cachedResultName": "Proveedores",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=1996169798"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "PROVEEDOR_ID",
              "lookupValue": "={{ $json.PROVEEDOR_ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1344,
        224
      ],
      "id": "5e94b1f6-266d-4da7-886b-72984f494436",
      "name": "Get Proveedores1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        -1120,
        288
      ],
      "id": "5cb835b3-1d33-4730-8e6e-a5900643969d",
      "name": "Merge2"
    },
    {
      "parameters": {
        "jsCode": "const results = [];\nconst zonaHoraria = 'America/Bogota';\nconst ahora = new Date(new Date().toLocaleString('en-US', { timeZone: zonaHoraria }));\n\n// Funci√≥n para formatear fecha como \"DD/MM/YYYY, HH:mm:ss\"\nfunction formatearFechaCompleta(fecha) {\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const a√±o = fecha.getFullYear();\n  const horas = String(fecha.getHours()).padStart(2, '0');\n  const minutos = String(fecha.getMinutes()).padStart(2, '0');\n  const segundos = String(fecha.getSeconds()).padStart(2, '0');\n  return `${dia}/${mes}/${a√±o}, ${horas}:${minutos}:${segundos}`;\n}\n\n// Funci√≥n para solo la fecha\nfunction formatearFecha(fecha) {\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const a√±o = fecha.getFullYear();\n  return `${dia}/${mes}/${a√±o}`;\n}\n\nconst fechaCompleta = formatearFechaCompleta(ahora);\nconst fechaSimple = formatearFecha(ahora);\nconst saludo = ahora.getHours() < 12 ? 'Buen d√≠a' : 'Buena tarde';\nconst entrega = `hoy - (${fechaSimple})`;\n\n// Agrupar productos por proveedor\nconst proveedores = {};\n\nfor (const item of items) {\n  const prod = item.json;\n  const proveedorId = prod.PROVEEDOR_ID;\n\n  if (!proveedores[proveedorId]) {\n    proveedores[proveedorId] = {\n      ...prod,\n      PRODUCTOS: [],\n      FECHA: fechaSimple,\n      ENTREGA: entrega\n    };\n    delete proveedores[proveedorId].ID_PRODUCTO;\n    delete proveedores[proveedorId].PRODUCTO;\n    delete proveedores[proveedorId].CANT_PALETS;\n    delete proveedores[proveedorId].CANT_CAJAS;\n    delete proveedores[proveedorId].PALET;\n    delete proveedores[proveedorId].CAJAS;\n    delete proveedores[proveedorId].NUM_PEDIDO;\n    delete proveedores[proveedorId].STATUS;\n    delete proveedores[proveedorId].comentarios;\n    delete proveedores[proveedorId].MENSAJE_PROVEEDOR;\n    delete proveedores[proveedorId].FECHA_CANCELACION;\n  }\n\n  proveedores[proveedorId].PRODUCTOS.push({\n    ...prod,\n    STATUS: \"Cancelado\",\n    FECHA: fechaCompleta,\n    FECHA_CANCELACION: fechaCompleta\n  });\n}\n\n// Crear mensaje para cada proveedor\nfor (const proveedor of Object.values(proveedores)) {\n  const productosPorPedido = {};\n\n  for (const prod of proveedor.PRODUCTOS) {\n    const numPedido = prod.NUM_PEDIDO || 'SIN_PEDIDO';\n    if (!productosPorPedido[numPedido]) {\n      productosPorPedido[numPedido] = [];\n    }\n    productosPorPedido[numPedido].push(\n      `- ${prod.CANT_PALETS} x ${prod.CANT_CAJAS} - ${prod.PRODUCTO} - ${prod.PALET} - ${prod.CAJAS}`\n    );\n  }\n\n  let mensaje = `üö´ *Cancelaci√≥n de pedido*\\n${saludo}, le informamos que el siguiente pedido para ${entrega} ha sido cancelado:\\n\\n`;\n  for (const [numPedido, lineas] of Object.entries(productosPorPedido)) {\n    mensaje += `‚û°Ô∏è *pedido N¬∞: ${numPedido}*\\n`;\n    mensaje += lineas.join('\\n\\n') + '\\n\\n';\n  }\n\n  proveedor.MENSAJE_PROVEEDOR = mensaje.trim();\n  results.push({ json: proveedor });\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        288
      ],
      "id": "83061611-5694-45be-b7ff-96b5ba582a87",
      "name": "Cancelacion Mensaje"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -528,
        -48
      ],
      "id": "34b09465-5dd0-4d0e-bfcb-28b79289adf5",
      "name": "Loop Over Items4"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "Pedro",
        "remoteJid": "=+{{ $json[\"N¬∫ DE TEL√âFONO\"] }}",
        "messageText": "={{ $json.MENSAJE_PROVEEDOR }}",
        "options_message": {
          "delay": 1000
        }
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        -80,
        -48
      ],
      "id": "82c84595-7630-4ba1-bff4-06fecf361587",
      "name": "Send Order1",
      "credentials": {
        "evolutionApi": {
          "id": "OFo9A7x3qE1W1DKN",
          "name": "Evolution account Pedro"
        }
      },
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -304,
        -128
      ],
      "id": "4ad33018-9fa3-4a05-8016-18f929597000",
      "name": "Wait5",
      "webhookId": "b2cca949-bbbb-4ac2-a65b-c5cad2698fbb"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -304,
        272
      ],
      "id": "df26fa3d-201e-4669-80f7-9d751a387bc2",
      "name": "Loop Over Items5"
    },
    {
      "parameters": {
        "jsCode": "// 1. Extraer y unir todos los productos v√°lidos (CANT_PALETS > 0)\nlet productosValidos = [];\n\nfor (const item of items) {\n  const proveedor = item.json;\n  const productos = proveedor.PRODUCTOS || [];\n  const status = \"Cancelado\";\n\n  const filtrados = productos\n    .filter(p => p.CANT_PALETS > 0)\n    .map(p => ({\n      row_number: p.row_number,\n      ID_PRODUCTO: p.ID_PRODUCTO,\n      PROVEEDOR_ID: proveedor.PROVEEDOR_ID,\n      FINCA: proveedor.FINCA,\n      N_SOLICITUD: p.N_SOLICITUD,\n      PRODUCTO: p.PRODUCTO,\n      STATUS: status,\n    }));\n\n  productosValidos.push(...filtrados);\n}\n\n// 2. Eliminar duplicados por combinaci√≥n ID_PRODUCTO + N_SOLICITUD + numero de fila\nconst vistos = new Set();\nconst productosUnicos = productosValidos.filter(p => {\n  const clave = `${p.N_SOLICITUD}-${p.row_number}`;\n  if (vistos.has(clave)) return false;\n  vistos.add(clave);\n  return true;\n});\n\n// 3. Devolver los productos √∫nicos\nreturn productosUnicos.map(p => ({ json: p }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        272
      ],
      "id": "f6f7ce8a-95b4-4a5a-809e-14883ed1d9c2",
      "name": "Productos Solicitados1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "STATUS": "={{ $json.STATUS }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Stock",
              "displayName": "Stock",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ID_PRODUCTO",
              "displayName": "ID_PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PROVEEDOR_ID",
              "displayName": "PROVEEDOR_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "FINCA",
              "displayName": "FINCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTO",
              "displayName": "PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        144,
        272
      ],
      "id": "68f6c735-d5a9-4745-bf47-d83be088b0cb",
      "name": "Update Status1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const results = [];\nconst status = \"Cancelado\";\n\nfor (const item of items) {\n  const productos = item.json.PRODUCTOS;\n  const finca = item.json.FINCA;\n  const proveedorId = item.json.PROVEEDOR_ID;\n  const fecha = item.json.FECHA;\n  const entrega = item.json.ENTREGA;\n\n  for (const prod of productos) {\n    if (prod.CANT_PALETS > 0) {\n      results.push({\n        json: {\n          NUM_PEDIDO: prod.NUM_PEDIDO,\n          FECHA: fecha,\n          PROVEEDOR_ID: proveedorId,\n          FINCA: finca,\n          ID_PRODUCTO: prod.ID_PRODUCTO,\n          PRODUCTO: prod.PRODUCTO,\n          CANT_PALETS: prod.CANT_PALETS,\n          CANT_CAJAS: prod.CANT_CAJAS,\n          PALET: prod.PALET,\n          CAJAS: prod.CAJAS,\n          ENTREGA: entrega,\n          STATUS: status,\n        }\n      });\n    }\n  }\n}\n\n// Eliminar duplicados por NUM_PEDIDO, PRODUCTO, PALET, CAJAS\nconst uniqueResultsMap = new Map();\n\nfor (const entry of results) {\n  const j = entry.json;\n  const key = `${j.NUM_PEDIDO}|${j.PRODUCTO}|${j.PALET}|${j.CAJAS}`;\n  if (!uniqueResultsMap.has(key)) {\n    uniqueResultsMap.set(key, entry);\n  }\n}\n\nreturn Array.from(uniqueResultsMap.values());\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        560
      ],
      "id": "0595a6e3-76c2-40a5-b4c4-45a51328a7f6",
      "name": "Code1"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -80,
        224
      ],
      "id": "8a8bb3c8-5992-4168-81d9-ddb2c7992ae8",
      "name": "Wait2",
      "webhookId": "76dbbe67-0287-425f-8299-bef21be90c71"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -80,
        560
      ],
      "id": "79f7a4e3-576a-4768-987a-b8fc36971688",
      "name": "Loop Over Items6"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        144,
        544
      ],
      "id": "c3e600f4-6869-49a2-b8b1-d5db4b2d37ca",
      "name": "Wait6",
      "webhookId": "76dbbe67-0287-425f-8299-bef21be90c71"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTOS }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "CAJAS",
              "lookupValue": "={{ $json.CAJAS }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -304,
        560
      ],
      "id": "4ff6a534-f60b-4be9-a4ed-8a08eba5c4cf",
      "name": "Google Sheets5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "STATUS": "Cancelado"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        368,
        560
      ],
      "id": "5c035260-2f96-44d8-b870-474aa7027eab",
      "name": "Status Cancelar Pedido",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTOS }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "CAJAS",
              "lookupValue": "={{ $json.CAJAS_ANTES }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1456,
        1120
      ],
      "id": "8febd942-b5b6-46d6-b9d0-cca4e2b78125",
      "name": "solicitud a proveedores para actualizar",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=solicitudes: {{ JSON.stringify($json.Solicitudes) }},\nactualizaciones: {{ JSON.stringify($json.Actualizaciones) }},",
        "options": {
          "systemMessage": "=Eres un **agente experto en an√°lisis log√≠stico automatizado y validaci√≥n de pedidos**. Tu responsabilidad es comparar las **solicitudes originales** con las **actualizaciones del pedido**, detectando cambios por proveedor y generando un **mensaje claro, completo y √∫nico por proveedor**. Este mensaje debe permitirles ajustar su preparaci√≥n log√≠stica **sin errores ni ambig√ºedades**, **evitando notificaciones innecesarias**.\n\n---\n\n### üß© ENTRADAS:\n\nRecibir√°s dos bloques de datos en formato JSON:\n\n* solicitudes: distribuci√≥n original de productos por proveedor, incluyendo:\n\n  * PRODUCTO\n  * PALET\n  * CAJAS (tipo de caja)\n  * CANT_PALETS\n  * CANT_CAJAS\n  * PROVEEDOR_ID\n  * NUM_PEDIDO\n\n* actualizaciones: nueva distribuci√≥n deseada, en el mismo formato.\n\n---\n\n### üéØ OBJETIVO:\n\nGenerar **un mensaje por proveedor** que detalle **√∫nicamente los cambios necesarios**, agrupados por producto. Estos pueden ser:\n\n1. **Aumentos o reducciones de cantidad** (CANT_PALETS, CANT_CAJAS)\n2. **Cambios en tipo de caja** (CAJAS)\n3. **Cancelaciones** (si CANT_PALETS = 0, sin importar CANT_CAJAS)\n4. **Altas nuevas** (producto presente en actualizaciones, pero no en solicitudes)\n\n---\n\n### üîç L√ìGICA DE COMPARACI√ìN Y DISTRIBUCI√ìN:\n\n#### 1. **Identificaci√≥n √∫nica de un producto**:\n\nBasada en: NUM_PEDIDO, PRODUCTO, PALET, PROVEEDOR_ID.\n\n#### 2. **Distribuci√≥n racional de cambios entre proveedores**:\n\n**Objetivo: minimizar la cantidad de modificaciones notificadas a proveedores.**\n\nAplica estas reglas:\n\n* En **aumentos**: asigna la diferencia **al proveedor que ya ten√≠a m√°s cantidad** del producto.\n* En **reducciones**: En reducciones:\n- Aplica la reducci√≥n al proveedor con m√°s palets del producto.\n- Si un proveedor queda con 0 palets, debe notificarse como Cancelaci√≥n y agregar el STATUS: \"Cancelado\".\n- Nunca omitir a un proveedor que ten√≠a el producto originalmente, aunque termine en 0. Siempre debe recibir notificaci√≥n si hubo cambio.\n- Si un proveedor ya tiene exactamente la cantidad final requerida, no se le notifica.\nNo se debe mencionar que un producto fue reasignado a otro proveedor.\nNo se deben generar instrucciones si no hay cambios efectivos en CANT_PALETS o CAJAS, excepto si hay cambio de tipo de caja.\n\n* Si un proveedor ya tiene la cantidad que se necesita seg√∫n el pedido actualizado, **no se le informa ning√∫n cambio**.\n* No se debe mencionar que se reasign√≥ un producto de un proveedor a otro.\n* **No se generan instrucciones si no hay cambios efectivos** en palets o tipo de caja.\n\n#### 3. **Cambios de tipo de caja**:\n\nSi cambia CAJAS, aunque las cantidades permanezcan iguales, **s√≠ se notifica el cambio, siempre a todos los proveedores implicados**.\n\n#### 4. **Cancelaciones y altas nuevas**:\n\n* Si un producto se reduce a CANT_PALETS = 0, se considera **cancelado**, y se siempre se notifica al proveedor la cancelacion y el STATUS: Cancelado.\n* Si aparece en actualizaciones pero no en solicitudes, se trata como **alta nueva**.\n\n---\n\n### ‚úÖ VALIDACIONES CR√çTICAS:\n\n* [ ] ¬øLa suma final de palets por producto coincide con la actualizaci√≥n?\n* [ ] ¬øSe evit√≥ duplicar aumentos en m√°s de un proveedor?\n* [ ] ¬øSe aplicaron reducciones solo a los proveedores necesarios?\n* [ ] ¬øSe notificaron solo los cambios reales?\n* [ ] ¬øSe evitaron notificaciones de redistribuci√≥n entre proveedores?\n* [ ] ¬øSe notificaron cambios de tipo de caja aunque no haya cambios en cantidad?\n* [ ] ¬øSe detectaron y notificaron cancelaciones y altas nuevas?\n* [ ] ¬øNo se omitieron proveedores que ten√≠an productos originalmente y ahora se redujeron a 0?\n\n\n\n---\nüì§ FORMATO DE SALIDA POR PROVEEDOR:\n\n{\n  \"PROVEEDOR_ID\": 2580,\n  \"NUM_PEDIDO\": \"PED-XXXX\",\n  \"CAMBIOS\": [\n    {\n      \"PRODUCTO\": \"PIMIENTO CALIFORNIA NARANJA I GG\",\n      \"row_number\": \"numero de fila de la solisitud a actualizar\",\n      \"comentarios\": \"descripcion corta y detallada del cambio realizado\",\n      \"STATUS\": \"Solicitado\",\n      \"ANTES\": {\n        \"CANT_PALETS\": 11,\n        \"CANT_CAJAS\": 220,\n        \"CAJAS\": \"BANDEJA GENERICA 60X40X20 S/N ETIQ\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"DESPUES\": {\n        \"CANT_PALETS\": 16,\n        \"CANT_CAJAS\": 320,\n        \"CAJAS\": \"BANDEJA GENERICA 60X40X20 S/N ETIQ\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"TIPO_CAMBIO\": [\"Aumento\"]\n    },\n    {\n      \"PRODUCTO\": \"PIMIENTO CALIFORNIA ROJO I G\",\n      \"row_number\": \"numero de fila de la solisitud a actualizar\",\n      \"comentarios\": \"descripcion corta y detallada del cambio realizado\",\n      \"STATUS\": \"Cancelado\", //siempre que la cantidad de cajas sea 0 se debe informar al proveedor la cancelacion y el STATUS Cancelado\n      \"ANTES\": {\n        \"CANT_PALETS\": 1,\n        \"CANT_CAJAS\": 20,\n        \"CAJAS\": \"GEN√âRICA\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"DESPUES\": {\n        \"CANT_PALETS\": 0,\n        \"CANT_CAJAS\": 0,\n        \"CAJAS\": \"GEN√âRICA\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"TIPO_CAMBIO\": [\"Cancelaci√≥n\"]\n    },\n    {\n      \"PRODUCTO\": \"PIMIENTO LAMUYO VERDE\",\n      \"row_number\": \"numero de fila de la solisitud a actualizar\",\n      \"comentarios\": \"descripcion corta y detallada del cambio realizado\",\n      \"STATUS\": \"Solicitado\",\n      \"ANTES\": {\n        \"CANT_PALETS\": 2,\n        \"CANT_CAJAS\": 40,\n        \"CAJAS\": \"CAJA ABIERTA 40X30\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"DESPUES\": {\n        \"CANT_PALETS\": 2,\n        \"CANT_CAJAS\": 40,\n        \"CAJAS\": \"BANDEJA TERMOSELLADA 40X30\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"TIPO_CAMBIO\": [\"Cambio de tipo de caja\"]\n  ],\n  \"MENSAJE_PROVEEDOR\": \"Respecto al *pedido PED-XXXX*, ten en cuenta los siguientes cambios:\\n\\n- El producto **PIMIENTO CALIFORNIA NARANJA I GG** en palet *BOX FRUVECO* pasa de 11 a 16 palets. \\n\\n- El producto **PIMIENTO CALIFORNIA ROJO I G** en palet *BOX FRUVECO* ha sido **cancelado**. \\n\\n- El producto **PIMIENTO LAMUYO VERDE** mantiene cantidades, pero cambia el tipo de caja: antes *CAJA ABIERTA 40X30*, ahora *BANDEJA TERMOSELLADA 40X30*.\\n\\n\\nGracias por tu colaboraci√≥n.\"\n}\n\nIMPORTANTE, si no hay cambios en un producto, no se notifica al proveedor, Siempre que un producto se reduzca a 0 palets en un proveedor, se debe informar como cancelado, incluso si otro proveedor asume el total del pedido. No se debe omitir al proveedor cancelado bajo ning√∫n motivo.\nMUY IMPORTANTE Y NO OLVIDAR:\n\"STATUS\": \"Cancelado\", si se reduce a 0 la catidad de Palets o cancela el pedido,\n\"STATUS\": \"Solicitado\", para cualquier otra actualizacion\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -896,
        1248
      ],
      "id": "7d5904c0-0706-4142-b52b-94758b541fdc",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash-lite-preview-02-05",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -800,
        1472
      ],
      "id": "af490438-5f58-4baf-b8bd-2c4c313e3611",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "Solicitudes",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -1248,
        1120
      ],
      "id": "f9ed810d-af0b-4e71-b274-d75363fdea2c",
      "name": "Solicitudes"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "Actualizaciones",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -1344,
        1344
      ],
      "id": "c676bcd3-0bbd-4210-b05f-5d998ee775af",
      "name": "Actualizaciones"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1120,
        1248
      ],
      "id": "171b4c91-b218-46ed-9c00-24544966dec9",
      "name": "Merge4"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el texto plano del agente\nconst raw = items[0].json.output;\n\n// Intentar extraer el JSON entre los delimitadores ```json y ```\nconst match = raw.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n\n// Si no encuentra un bloque v√°lido, intentar parsear como JSON directo\nconst cleanJsonString = match ? match[1] : raw;\n\n// Intentar parsear el contenido\nlet parsed;\ntry {\n  parsed = JSON.parse(cleanJsonString);\n} catch (error) {\n  throw new Error(\"No se pudo parsear el JSON: \" + error.message);\n}\n\n// Verificamos que sea un array\nif (!Array.isArray(parsed)) {\n  throw new Error(\"El JSON parseado no es un array.\");\n}\n\n// Devolvemos cada objeto como item independiente\nreturn parsed.map(obj => ({ json: obj }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        1248
      ],
      "id": "0a3670b7-f2ee-4ce3-8cda-f1997e4dbf66",
      "name": "Code3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -304,
        864
      ],
      "id": "36fcc83a-0aff-4dc3-af04-d70fd4b16f57",
      "name": "Loop Over Items7"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "Pedro",
        "remoteJid": "=+{{ $json[\"N¬∫ DE TEL√âFONO\"] }}",
        "messageText": "=Hola, {{ $json[\"ENCARGADO \"].split(' ')[0] }}, {{ $('Wait7').item.json.MENSAJE_PROVEEDOR }}",
        "options_message": {
          "delay": 1000
        }
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        368,
        864
      ],
      "id": "b3680795-30fc-4aa7-96eb-e8fa46650ccd",
      "name": "Send Order2",
      "credentials": {
        "evolutionApi": {
          "id": "OFo9A7x3qE1W1DKN",
          "name": "Evolution account Pedro"
        }
      },
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -80,
        864
      ],
      "id": "fd04f20a-6d57-4106-bfef-bfac6b636518",
      "name": "Wait7",
      "webhookId": "b2cca949-bbbb-4ac2-a65b-c5cad2698fbb"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PROVEEDOR_ID",
              "displayName": "PROVEEDOR_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FINCA",
              "displayName": "FINCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ID_PRODUCTO",
              "displayName": "ID_PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRODUCTO",
              "displayName": "PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ENTREGA",
              "displayName": "ENTREGA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "comentarios",
              "displayName": "comentarios",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        368,
        1168
      ],
      "id": "bd019af0-c659-4dfd-8106-965a4821ae67",
      "name": "Google Sheets2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "content": "## UPDATE REQUEST TO SUPPLIER",
        "height": 280,
        "width": 920
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -384,
        1040
      ],
      "id": "8089bc08-8f6e-4660-9e10-2c30eb1d65c5",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -304,
        1168
      ],
      "id": "ec38f703-6a8a-4834-a3ea-d9389e33dccb",
      "name": "Loop Over Items8"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        144,
        1168
      ],
      "id": "35276fb2-a7f8-4599-8403-d2082fc9aa80",
      "name": "Wait8",
      "webhookId": "76dbbe67-0287-425f-8299-bef21be90c71"
    },
    {
      "parameters": {
        "jsCode": "const proveedor = items[0].json;\n\nconst salida = [];\n\nfor (const cambio of proveedor.CAMBIOS) {\n  // Verificar si hay \"Cancelaci√≥n\" en TIPO_CAMBIO\n  const esCancelacion = cambio.TIPO_CAMBIO.includes(\"Cancelaci√≥n\");\n\n  salida.push({\n    row_number: cambio.row_number,\n    STATUS: esCancelacion ? \"Cancelado\" : cambio.STATUS,\n    CANT_PALETS: cambio.DESPUES.CANT_PALETS,\n    CANT_CAJAS: cambio.DESPUES.CANT_CAJAS,\n    CAJAS: cambio.DESPUES.CAJAS,\n    PALET: cambio.DESPUES.PALET,\n    comentarios: cambio.comentarios\n  });\n}\n\nreturn salida.map(item => ({ json: item }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        1168
      ],
      "id": "99fbb003-651b-45b8-b130-1e85cc7949bb",
      "name": "Code2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1996169798,
          "mode": "list",
          "cachedResultName": "Proveedores",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=1996169798"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "PROVEEDOR_ID",
              "lookupValue": "={{ $json.PROVEEDOR_ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        144,
        864
      ],
      "id": "ba8ab9ab-e24b-41a9-b075-338f82ee1b0d",
      "name": "Google Sheets4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "NUM_PEDIDO": "={{ $json.NUM_PEDIDO }}",
            "CIF_CLIENTE": "={{ $json.CIF_CLIENTE }}",
            "NOMBRE_CLIENTE": "={{ $json.NOMBRE_CLIENTE }}",
            "PRODUCTOS": "={{ $json.PRODUCTOS }}",
            "PALET": "={{ $json.PALET }}",
            "CANT_PALETS": "={{ $json.CANT_PALETS }}",
            "CAJAS": "={{ $json.CAJAS }}",
            "CANT_CAJAS": "={{ $json.CANT_CAJAS }}",
            "STATUS": "=Pendiente",
            "FECHA": "={{ $json.FECHA }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1568,
        1488
      ],
      "id": "137d499f-65b4-43b8-8d0a-98d532c2053b",
      "name": "Agregar nuevo producto",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "PRODUCTOS": "={{ $('Code5').item.json.PRODUCTO }}",
            "PALET": "={{ $('Code5').item.json.PALET }}",
            "CAJAS": "={{ $('Code5').item.json.CAJAS }}",
            "CANT_PALETS": "={{ $('Code5').item.json.CANT_PALETS }}",
            "CANT_CAJAS": "={{ $('Code5').item.json.CANT_CAJAS }}",
            "CAMBIOS": "={{ $('Code5').item.json.COMENTARIOS }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CAMBIOS",
              "displayName": "CAMBIOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        368,
        1472
      ],
      "id": "90315912-84d0-45c8-8781-01c3e0ebc0d3",
      "name": "Update Status2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const resumen = {};\n\nfor (const item of items) {\n  const data = item.json;\n  const num_pedido = data.NUM_PEDIDO;\n\n  for (const cambio of data.CAMBIOS) {\n    const producto = cambio.PRODUCTO;\n    const despues = cambio.DESPUES;\n    const antes = cambio.ANTES;\n    const proveedor = data.PROVEEDOR_ID;\n\n    const palet = despues.PALET;\n    const cajas = despues.CAJAS;\n    const cant_palets = despues.CANT_PALETS;\n    const cant_cajas = despues.CANT_CAJAS;\n\n    const clave = `${num_pedido}||${producto}||${palet}||${cajas}`;\n\n    if (!resumen[clave]) {\n      resumen[clave] = {\n        NUM_PEDIDO: num_pedido,\n        PRODUCTO: producto,\n        PALET: palet,\n        CAJAS: cajas,\n        CANT_PALETS: 0,\n        CANT_CAJAS: 0,\n        CAMBIOS_PROVEEDOR: [],\n        COMENTARIOS: []\n      };\n    }\n\n    resumen[clave].CANT_PALETS += cant_palets;\n    resumen[clave].CANT_CAJAS = cant_cajas; // asumimos homog√©neo\n\n    // Comentario individual por proveedor\n    const comentario = `Proveedor ${proveedor} - palets: ${antes.CANT_PALETS} ‚Üí ${despues.CANT_PALETS}`;\n    resumen[clave].COMENTARIOS.push(comentario);\n\n    resumen[clave].CAMBIOS_PROVEEDOR.push({\n      PROVEEDOR_ID: proveedor,\n      ANTES: antes.CANT_PALETS,\n      DESPUES: despues.CANT_PALETS\n    });\n  }\n}\n\n// Armar salida con trazabilidad\nconst salida = Object.values(resumen).map(r => {\n  const comentario = \n    `Palets finales: ${r.CANT_PALETS}, cajas: ${r.CANT_CAJAS}, ` +\n    `palet: ${r.PALET}, cajas: ${r.CAJAS}. Cambios por proveedor:\\n- ` +\n    r.COMENTARIOS.join('\\n- ');\n\n  return {\n    json: {\n      NUM_PEDIDO: r.NUM_PEDIDO,\n      PRODUCTO: r.PRODUCTO,\n      PALET: r.PALET,\n      CAJAS: r.CAJAS,\n      CANT_PALETS: r.CANT_PALETS,\n      CANT_CAJAS: r.CANT_CAJAS,\n      COMENTARIOS: comentario\n    }\n  };\n});\n\nreturn salida;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        1472
      ],
      "id": "a793f0e6-ea1a-4eb2-b792-083dc4bee28e",
      "name": "Code5"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTO }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "STATUS",
              "lookupValue": "Solicitado"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        144,
        1472
      ],
      "id": "840e14ac-5ae3-4472-937b-37ca2a85be5c",
      "name": "Google Sheets6",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -80,
        1472
      ],
      "id": "4c88ab12-0903-4511-a351-48f26d8b2a48",
      "name": "Loop Over Items9"
    },
    {
      "parameters": {
        "content": "# actualizacion de pedidos",
        "height": 340,
        "width": 600,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2896,
        1024
      ],
      "id": "3e0dbcba-b99a-4f9f-8e06-dc03d03975b5",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=473624239173850",
        "recipientPhoneNumber": "=+{{ $json[\"N¬∫ DE TEL√âFONO\"] }}",
        "textBody": "={{ $json.MENSAJE_PROVEEDOR }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        112,
        -48
      ],
      "id": "0658b776-4510-47af-bf2b-3ae39de2466d",
      "name": "Send message",
      "webhookId": "18375922-777c-4b77-8cb5-9a4d0c01898d",
      "credentials": {
        "whatsAppApi": {
          "id": "IzfsUgwJnA4EF09z",
          "name": "whatsap Valeia"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=473624239173850",
        "recipientPhoneNumber": "=+{{ $json[\"N¬∫ DE TEL√âFONO\"] }}",
        "textBody": "=Hola, {{ $json[\"ENCARGADO \"].split(' ')[0] }}, {{ $('Wait7').item.json.MENSAJE_PROVEEDOR }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        576,
        848
      ],
      "id": "973b7040-01d3-499c-9cb4-135c95daf6fd",
      "name": "Send message1",
      "webhookId": "18375922-777c-4b77-8cb5-9a4d0c01898d",
      "credentials": {
        "whatsAppApi": {
          "id": "IzfsUgwJnA4EF09z",
          "name": "whatsap Valeia"
        }
      }
    }
  ],
  "pinData": {},
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-11-30T20:19:28.997Z",
      "createdAt": "2025-11-30T20:19:28.997Z",
      "role": "workflow:owner",
      "workflowId": "J3bYrJMoaWQK82pJ",
      "projectId": "Io87W9y1OT3XcmCD"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-09-09T17:13:58.420Z",
  "versionId": "5cb5f441-b6a6-4705-ac93-1bf03fa85420"
}