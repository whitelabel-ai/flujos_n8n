{
  "active": false,
  "connections": {
    "Telegram Trigger": {
      "main": [
        []
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bienvenida Inicial": {
      "main": [
        []
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Bienvenida Inicial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Onbording Asesoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Buscar Referencia en Inventario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "Resp. Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Get a prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent with Langfuse",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent with Langfuse",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Answer Assoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        []
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "un momento, estamos revisando nuestro inventario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Get many rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait4": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Referencia Encontrada?": {
      "main": [
        [
          {
            "node": "hay stock?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ref. No encontrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "hay stock?": {
      "main": [
        [
          {
            "node": "‚úÖ Hemos encontrado tu referencia/ Comprar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar Otra referencia / sol. Asesoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Assoria": {
      "main": [
        []
      ]
    },
    "Onbording Asesoria": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resp. Agenda": {
      "main": [
        [
          {
            "node": "Consultar disponibilidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar disponibilidad": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create an event": {
      "main": [
        []
      ]
    },
    "confimar": {
      "main": [
        [
          {
            "node": "Create an event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Hemos encontrado tu referencia/ Comprar": {
      "main": [
        []
      ]
    },
    "Quieres comprar alguna de estas opciones?": {
      "main": [
        []
      ]
    },
    "Buscar Otra referencia / sol. Asesoria": {
      "main": [
        [
          {
            "node": "Otra referencia / Asesoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Otra referencia / Asesoria": {
      "main": [
        [
          {
            "node": "Asesoria ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Referencia en Inventario": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ref. No encontrada": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Asesoria 1": {
      "main": [
        [
          {
            "node": "Onbording Asesoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "un momento, estamos revisando nuestro inventario": {
      "main": [
        [
          {
            "node": "Wait4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Asesoria ": {
      "main": [
        [
          {
            "node": "Get many rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message": {
      "main": [
        [
          {
            "node": "confimar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a row in NocoDB": {
      "ai_tool": [
        [
          {
            "node": "AI Agent with Langfuse",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get a prompt": {
      "main": [
        [
          {
            "node": "AI Agent with Langfuse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent with Langfuse": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows": {
      "main": [
        [
          {
            "node": "Referencia Encontrada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Llantas n¬¥ Tires": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-20T12:40:36.573Z",
  "id": "k0HiAcQpHtDmUSzH",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Onbording para LLantas¬¥n¬¥tires",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1568,
        208
      ],
      "id": "ee21829a-392e-4745-abde-657895da30f2",
      "name": "Telegram Trigger",
      "webhookId": "f9e96179-4231-4c24-920b-09c597afa3f2",
      "credentials": {
        "telegramApi": {
          "id": "POQojvCnUZ7h69VU",
          "name": "Telegram account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.callback_clean }}",
                    "rightValue": "asesoria",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d444a7e1-e0da-427d-a9e0-99602772ce97"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f3b23e90-dd40-4671-a4eb-08f238b2f229",
                    "leftValue": "={{ $json.callback_clean }}",
                    "rightValue": "referencia",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5c14ffed-f34b-41af-9879-c65b3175bffc",
                    "leftValue": "={{ $json.callback_clean }}",
                    "rightValue": "agenda",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        16,
        432
      ],
      "id": "edc46772-e689-4eb8-a52b-9156c0488950",
      "name": "Switch"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "¬°Hola! üëã Bienvenido a Llantas n'Tires  ¬øComo Podemos ayudarte hoy?",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "üßê Quiero asesoria para comprar una llanta",
                    "additionalFields": {
                      "callback_data": "asesoria"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "‚úÖ Ya tengo la referencia de la llanta quiero comprarla",
                    "additionalFields": {
                      "callback_data": "referencia"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "üìÖ Quiero Agendar la instalaci√≥n de la llanta",
                    "additionalFields": {
                      "callback_data": "agenda"
                    }
                  }
                ]
              }
            },
            {}
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -512,
        -240
      ],
      "id": "755d93e1-b3f9-46a3-ba6e-46c1708a6e0e",
      "name": "Bienvenida Inicial",
      "webhookId": "879427f7-5f10-4bf1-b8d0-251ae561e1db",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener el valor del bot√≥n presionado directamente\n$json.callback_clean = $json.callback_query.data.trim().toLowerCase();\n\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        448
      ],
      "id": "95f3ab45-81f1-42fd-95f7-c6c37c21abde",
      "name": "Code"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "961141f6-ae33-49d8-b081-102a1b7bdc89",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1008,
        432
      ],
      "id": "c2f0b679-c1a5-4156-b396-db765c6021ff",
      "name": "If"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "voy a buscar las opciones mas cercanas ",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        624,
        1104
      ],
      "id": "8fa533b4-b28d-4814-9303-f4bf5afeeae7",
      "name": "Resp. Agenda",
      "webhookId": "aa910415-ce09-4214-850f-1ae5ee4965e5",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -704,
        -240
      ],
      "id": "eddd0c13-94bd-4306-97ab-43001eb0b505",
      "name": "Wait",
      "webhookId": "b755442c-9184-4da1-aa59-144034f6f138"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        304,
        -272
      ],
      "id": "7252f242-0b68-427f-8f4e-40f26fdde9bd",
      "name": "Wait1",
      "webhookId": "4070ef9b-e40b-4e6c-9ded-e41d53ebd529"
    },
    {
      "parameters": {
        "amount": 4
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        272,
        448
      ],
      "id": "1075d636-8737-4c15-a942-e5cebeba56dc",
      "name": "Wait2",
      "webhookId": "b2ddf2e6-fa8e-44ee-8cb7-584457c40c10"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        352,
        1104
      ],
      "id": "1cf5e395-6372-4215-b262-9eb7fb921830",
      "name": "Wait3",
      "webhookId": "7476a988-3fdb-499c-bff9-7ce046b6e9d1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4eb309c1-e9b8-47ba-82a0-97e2eedfb0b9",
              "name": "Tipo_Vehiculo",
              "value": "={{ $json.data['¬øQue Marca y tipo de Vehiculo tienes? (Chevrolet Onix,Kia Picanto , Hiunday Accent etc)'] }}",
              "type": "string"
            },
            {
              "id": "06d15c38-87e6-46b6-a692-e34fcd773a8e",
              "name": "A√±o/Modelo",
              "value": "={{ $json.data['¬øQue a√±o/Modelo es?'] }}",
              "type": "number"
            },
            {
              "id": "39a1f57f-b9c8-4559-a1b7-370ffe6e75af",
              "name": "Tama√±o_actual_Llanta",
              "value": "={{ $json.data['¬øCual es el tama√±o actual de la llanta? ejemplo:  205/55 R16'] }}",
              "type": "string"
            },
            {
              "id": "058e6143-600a-4d37-8e81-a2727c6af7e1",
              "name": "uso_frecuente",
              "value": "={{ $json.data['¬øTipo de conducci√≥n / uso del veh√≠culo? ejemplo: Autopista, carretera, Trocha, mixto.'] }}",
              "type": "string"
            },
            {
              "id": "d349bba3-ef8c-484f-85cf-9a6fef6047e1",
              "name": "frecuencia de uso_carga",
              "value": "={{ $json.data['¬øCual es la Frecuencia de uso y carga habitual? ejemplo: Diario, ocasional, viajes largos.  Con carga de pasajeros o carga pesada.'] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        960,
        -272
      ],
      "id": "c237b77e-ff21-42b4-ae8a-caacf8948613",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// Tomamos los datos del Set Node\nconst data = $json;\n\n// Armamos el prompt para la IA\nconst prompt = `\nEl cliente tiene un veh√≠culo ${data.Tipo_Vehiculo} (${data[\"A√±o/Modelo\"]}),\ncon llantas de tama√±o ${data.Tama√±o_actual_Llanta},\nuso frecuente: ${data.uso_frecuente},\nfrecuencia de carga: ${data.frecuencia_carga}.\nPor favor, recomi√©ndale las mejores llantas para su veh√≠culo y explica por qu√©.\n`;\n\n// Devolvemos un objeto listo para el nodo AI\nreturn [\n  {\n    json: {\n      prompt: prompt\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        -272
      ],
      "id": "0e63bec6-711c-4018-8b77-31992912148d",
      "name": "Code1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1600,
        -160
      ],
      "id": "95ead276-6a82-4c56-b8fd-a01f36adc16b",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1408,
        -144
      ],
      "id": "db346176-ee18-4752-aaed-c543c932d387",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "XIMrvFKKXQQFKrhj",
          "name": "LLantas n¬¥ Tires"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Escapar caracteres problem√°ticos para MarkdownV2 en Telegram\nlet texto = items[0].json.output;\n\n// Reemplazos obligatorios\ntexto = texto\n  .replace(/_/g, \"\\\\_\")\n  .replace(/\\*/g, \"\\\\*\")\n  .replace(/\\[/g, \"\\\\[\")\n  .replace(/\\]/g, \"\\\\]\")\n  .replace(/\\(/g, \"\\\\(\")\n  .replace(/\\)/g, \"\\\\)\")\n  .replace(/~/g, \"\\\\~\")\n  .replace(/`/g, \"\\\\`\")\n  .replace(/>/g, \"\\\\>\")\n  .replace(/#/g, \"\\\\#\")\n  .replace(/\\+/g, \"\\\\+\")\n  .replace(/-/g, \"\\\\-\")\n  .replace(/=/g, \"\\\\=\")\n  .replace(/\\|/g, \"\\\\|\")\n  .replace(/\\{/g, \"\\\\{\")\n  .replace(/\\}/g, \"\\\\}\")\n  .replace(/\\./g, \"\\\\.\")\n  .replace(/!/g, \"\\\\!\");\n\n// Devuelve el texto escapado para Telegram\nreturn [{\n  json: {\n    message: texto\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2016,
        -288
      ],
      "id": "e21e3f85-efe7-4f6c-8e6b-0c7dda4703c2",
      "name": "Code2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Ooug27MCKXpwZJh-LFj8FdwYQDIUAtnOl7YmOOHB0kQ",
          "mode": "list",
          "cachedResultName": "Inventario llantas n¬¥Tires Prueba",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ooug27MCKXpwZJh-LFj8FdwYQDIUAtnOl7YmOOHB0kQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Hoja 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Ooug27MCKXpwZJh-LFj8FdwYQDIUAtnOl7YmOOHB0kQ/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Marca",
              "lookupValue": "={{ $json.marca }}"
            },
            {
              "lookupColumn": "Medida",
              "lookupValue": "={{ $json.referencia }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2832,
        -448
      ],
      "id": "1e912b17-3685-46ad-ad37-30cd431754c3",
      "name": "Get row(s) in sheet",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mbYsL5GzOjiChSg5",
          "name": "Inventario Llantas n tires DB"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const text = $json[\"data\"][\"text\"].trim();\n\n// Regex: busca marca (letras) + medida (ej. 225/45/r17 o 225/45 R17)\nconst regex = /([a-zA-Z]+)\\s+(\\d{3})\\/(\\d{2})\\s*\\/?\\s*R?(\\d{2})/i;\nconst match = text.match(regex);\n\nif (match) {\n  return [{\n    marca: match[1].charAt(0).toUpperCase() + match[1].slice(1).toLowerCase(), // \"pireli\" ‚Üí \"Pireli\"\n    referencia: `${match[2]}/${match[3]} R${match[4]}`,\n    mensajeOriginal: text\n  }];\n} else {\n  return [{\n    marca: null,\n    referencia: null,\n    mensajeOriginal: text\n  }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        448
      ],
      "id": "689bdfb7-712c-41d0-88e8-19cd9ef9b873",
      "name": "Code3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "273cf771-e911-4b9c-99f3-8ae9d5493127",
              "name": "marca",
              "value": "={{ $('Code3').item.json.marca }}",
              "type": "string"
            },
            {
              "id": "56d2634b-3334-4753-8134-8a1536bfcc74",
              "name": "referencia",
              "value": "={{ $('Code3').item.json.referencia }}",
              "type": "string"
            },
            {
              "id": "02930294-070b-4449-910a-6d02780400e9",
              "name": "mensajeOriginal",
              "value": "={{ $('Code3').item.json.mensajeOriginal }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1488,
        416
      ],
      "id": "1ee6cf15-9f1b-4cd1-87a6-16e18a7abd96",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1264,
        448
      ],
      "id": "b49725ec-b031-4bda-bf83-d8faeb8017b6",
      "name": "Wait4",
      "webhookId": "6bd44968-727b-4c49-9f55-532208a19696"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "77ce984b-14a8-4874-a745-34719d9ef1a2",
              "leftValue": "={{ $json.Medida }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1920,
        416
      ],
      "id": "d6289992-0bb2-47de-a317-dd27f51aac24",
      "name": "Referencia Encontrada?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c5744d26-3227-4262-b39b-099b7fbf209e",
              "leftValue": "={{ $json.Disponibilidad }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2144,
        240
      ],
      "id": "b1231f8e-974a-431c-806a-275c0b55fa39",
      "name": "hay stock?"
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "options": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2592,
        -448
      ],
      "id": "46a2c9a7-af63-474e-8522-478b6747e2b8",
      "name": "Quieres comprar alguna de estas opciones?",
      "webhookId": "c3356be2-810a-4c49-a405-e9b8770e0913",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "=‚úÖ Hemos encontrado la referencia **{{ $('Edit Fields1').item.json.mensajeOriginal }} en  nuestro inventario. \nTenemos {{ $json.Disponibilidad }} Unidades Disponibles\n¬øQuieres realizar la compra?\n{{ $json.Link_Compra }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2496,
        224
      ],
      "id": "0cbf84d6-842f-45b6-b57c-692514c41668",
      "name": "‚úÖ Hemos encontrado tu referencia/ Comprar",
      "webhookId": "84ec1551-6242-4ee0-9abb-75aa81d8bac9",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2208,
        -288
      ],
      "id": "45bd2e4b-de71-4e41-a5a4-2e2ee6d31a81",
      "name": "Answer Assoria",
      "webhookId": "e15ae04c-4326-4161-b317-205964f4eaa7",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "message": "Vamos a asesorarte para comprar la llanta correcta para tu veh√≠culo.  Para empezar, necesito hacerte unas preguntas r√°pidas. solo tomara un minuto",
        "responseType": "customForm",
        "formFields": {
          "values": [
            {
              "fieldLabel": "¬øQue Marca y tipo de Vehiculo tienes? (Chevrolet Onix,Kia Picanto , Hiunday Accent etc)"
            },
            {
              "fieldLabel": "¬øQue a√±o/Modelo es?",
              "fieldType": "number"
            },
            {
              "fieldLabel": "¬øCual es el tama√±o actual de la llanta? ejemplo:  205/55 R16"
            },
            {
              "fieldLabel": "¬øTipo de conducci√≥n / uso del veh√≠culo? ejemplo: Autopista, carretera, Trocha, mixto."
            },
            {
              "fieldLabel": "¬øCual es la Frecuencia de uso y carga habitual? ejemplo: Diario, ocasional, viajes largos.  Con carga de pasajeros o carga pesada."
            }
          ]
        },
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        768,
        -272
      ],
      "id": "f30b841d-9563-43dc-9b04-1eedfc8d1bf0",
      "name": "Onbording Asesoria",
      "webhookId": "a5178de9-1eda-445e-9867-f1b6cf50a971",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "553384d841714561379407dfd703e3041084d842f1c2e2c0849503d61c8e778a@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "test llantas n¬¥Tires"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        864,
        1104
      ],
      "id": "ef351314-62d4-4517-b363-218203d2a20c",
      "name": "Consultar disponibilidad",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "FLcfVnydGza1vVe1",
          "name": "Calendar LLantas n¬¥ Tires"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        1808,
        1104
      ],
      "id": "23649fcb-8354-43d4-bfa3-1dbd1dbebdbf",
      "name": "Create an event",
      "disabled": true
    },
    {
      "parameters": {
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1536,
        1104
      ],
      "id": "a6a3e0e3-172d-49b0-a726-52d38769754d",
      "name": "confimar",
      "webhookId": "7b2ee126-669e-4e1b-a82a-2c7455d2cda1",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "message": "=üòî Lo sentimos, la referencia **{{ $json[\"referencia\"] }}** no est√° disponible en nuestro inventario.  \n\nPero no te preocupes, tienes dos opciones:  \n\n1Ô∏è‚É£ Env√≠anos otra referencia en el formato correcto (ejemplo: 205/55 R16).  \n2Ô∏è‚É£ Solicita una asesor√≠a personalizada para recomendarte neum√°ticos equivalentes y seguros para tu veh√≠culo. üöóüîß  \n\nPor favor, responde con la opci√≥n que prefieras:\n- **Otra referencia**  \n- **Asesor√≠a**\n",
        "responseType": "freeText",
        "options": {
          "messageButtonLabel": "Respond",
          "responseFormTitle": ""
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2496,
        464
      ],
      "id": "dedd3a4f-f408-447e-b695-8bba1e2b8492",
      "name": "Buscar Otra referencia / sol. Asesoria",
      "webhookId": "7d649e85-1d2d-4ca8-b7a2-9e4a99e66818",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9909e7ce-25e3-465b-9307-139ee6c66ef0"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2736,
        464
      ],
      "id": "2501f0eb-2882-40e3-965d-3de889c044b8",
      "name": "Otra referencia / Asesoria"
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "message": "Excelente üöÄ. Por favor dime la referencia de la llanta (ejemplo: 225/45 R17).\n",
        "responseType": "freeText",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        544,
        448
      ],
      "id": "eb13bffb-6d1f-460c-aba1-d279ae70868b",
      "name": "Buscar Referencia en Inventario",
      "webhookId": "a5178de9-1eda-445e-9867-f1b6cf50a971",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "message": "=‚ö†Ô∏è No logr√© identificar la referencia. Por favor env√≠amela de nuevo  en el formato correcto: 205/55 R16. o agrega otra referencia\n",
        "responseType": "freeText",
        "options": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2160,
        432
      ],
      "id": "488431c6-90ec-4d7d-ba77-066d8b495c77",
      "name": "Ref. No encontrada",
      "webhookId": "7d649e85-1d2d-4ca8-b7a2-9e4a99e66818",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "IzFm4DOh86cd0W9q"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2960,
        640
      ],
      "id": "dd67ff71-7374-4ab8-aab8-f7b0cd0bd802",
      "name": "Asesoria "
    },
    {
      "parameters": {
        "content": "## Onboarding Asesoria\n",
        "height": 544,
        "width": 2048
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        480,
        -464
      ],
      "typeVersion": 1,
      "id": "2d9c235a-ea20-45f2-8ffe-ada73eb8efc1",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        560,
        -96
      ],
      "id": "900d86c2-e315-473b-8ac5-fcc8b6e1bd48",
      "name": "Asesoria 1",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Onboarding Inicial\n",
        "height": 272,
        "width": 496,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -736,
        -320
      ],
      "typeVersion": 1,
      "id": "85070d04-46b6-4fd0-b254-f7a6987604d8",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.callback_query.message.chat.id }}",
        "text": "Un momento, estamos revisando nuestro inventario... üîé",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1040,
        448
      ],
      "id": "8ce2695e-4e10-4659-8a00-7337e0f2cf05",
      "name": "un momento, estamos revisando nuestro inventario",
      "webhookId": "a9e6114a-55be-426e-9c5f-13907d373fbb",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ------------------------\n// Function Node (n8n)\n// ------------------------\n\n// Configuraci√≥n del taller\nconst startHour = 8;        // apertura\nconst endHour = 18;         // cierre\nconst slotDuration = 60;    // minutos\nconst timeZone = 'America/Bogota';\n\n// Helpers\nconst pad = n => String(n).padStart(2, '0');\n\n// D√≠a objetivo: hoy (ajusta si quieres otra fecha)\nconst today = new Date();\nconst targetDateStr = today.toLocaleDateString('en-CA', { timeZone }); // YYYY-MM-DD\n\n// 1. Extraer eventos confirmados\nconst events = [];\nfor (const item of items) {\n  const ev = item.json;\n  if (!ev.start || !ev.end) continue;\n\n  const start = new Date(ev.start.dateTime || ev.start.date);\n  const end = new Date(ev.end.dateTime || ev.end.date);\n  events.push({ start, end });\n}\n\n// 2. Generar todos los slots del d√≠a\nlet slots = [];\nfor (let h = startHour; h < endHour; h++) {\n  const slotStart = new Date(today);\n  slotStart.setHours(h, 0, 0, 0);\n\n  const slotEnd = new Date(slotStart);\n  slotEnd.setMinutes(slotEnd.getMinutes() + slotDuration);\n\n  slots.push({ start: slotStart, end: slotEnd });\n}\n\n// 3. Filtrar los ocupados\nconst freeSlots = slots.filter(slot => {\n  return !events.some(ev => {\n    return (\n      (slot.start >= ev.start && slot.start < ev.end) ||\n      (slot.end > ev.start && slot.end <= ev.end) ||\n      (slot.start <= ev.start && slot.end >= ev.end)\n    );\n  });\n});\n\n// 4. Devolver en formato de botones con fecha incluida\nreturn [{\n  json: {\n    message: `üìÖ Horarios disponibles para el ${targetDateStr}:`,\n    reply_markup: {\n      inline_keyboard: freeSlots.map(slot => {\n        const timeStr = `${pad(slot.start.getHours())}:${pad(slot.start.getMinutes())}`;\n        const label = `${targetDateStr} ${timeStr}`;\n        return [{ text: label, callback_data: label }];\n      })\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        1104
      ],
      "id": "0109f975-a1e9-408a-a6ff-56b914c44202",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "chatId": "6779476283",
        "text": "={{ $json.message }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "={{ $json.reply_markup.inline_keyboard[0][0].text }}",
                    "additionalFields": {
                      "callback_data": "={{ $json.reply_markup.inline_keyboard[1][0].callback_data }}"
                    }
                  },
                  {
                    "text": "={{ $json.reply_markup.inline_keyboard[1][0].text }}",
                    "additionalFields": {
                      "callback_data": "={{ $json.reply_markup.inline_keyboard[1][0].callback_data }}"
                    }
                  },
                  {
                    "text": "={{ $json.reply_markup.inline_keyboard[2][0].text }}",
                    "additionalFields": {
                      "callback_data": "={{ $json.reply_markup.inline_keyboard[2][0].callback_data }}"
                    }
                  },
                  {
                    "text": "={{ $json.reply_markup.inline_keyboard[3][0].callback_data }}",
                    "additionalFields": {
                      "callback_data": "={{ $json.reply_markup.inline_keyboard[3][0].callback_data }}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1280,
        1104
      ],
      "id": "674f996b-9615-4143-919a-c93bea79f28b",
      "name": "Send a text message",
      "webhookId": "8ab8bfbb-b015-4a5b-871a-92e517d84631",
      "credentials": {
        "telegramApi": {
          "id": "1CNcHuDCxtwKoVN7",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken"
      },
      "type": "n8n-nodes-base.nocoDbTool",
      "typeVersion": 3,
      "position": [
        1776,
        -160
      ],
      "id": "d2bb0e7a-9be6-4381-b66d-4f9b11923e90",
      "name": "Get a row in NocoDB",
      "credentials": {
        "nocoDbApiToken": {
          "id": "SCVsgkuKqpGPiGvk",
          "name": "NocoDB Token account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "promptName": "Llantas n¬¥Tires",
        "requestOptions": {}
      },
      "type": "@langfuse/n8n-nodes-langfuse.langfuse",
      "typeVersion": 1,
      "position": [
        1312,
        -432
      ],
      "id": "c063007a-1a15-4d18-82e7-e0bfdf17525f",
      "name": "Get a prompt",
      "credentials": {
        "langfuseApi": {
          "id": "iBaUfiTOCXCanQdR",
          "name": "Llantas n¬¥Tires"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "langfuseMetadata": {},
        "options": {
          "systemMessage": "\nRol: Act√∫a como un asistente experto en neum√°ticos para veh√≠culos, con un enfoque en la seguridad, el rendimiento y la personalizaci√≥n. Tu objetivo es guiar al usuario hacia la mejor elecci√≥n de neum√°ticos, proporcionando recomendaciones informadas y claras.\nGenera  maximo 1500 caracteres en tu respuesta\n____________________________________\nTono y estilo: Mant√©n un tono profesional, amigable y f√°cil de entender. Evita la jerga t√©cnica excesiva.\n___________________________________\n\nTarea: Genera una recomendaci√≥n personalizada de neum√°ticos para un usuario, bas√°ndote en la siguiente informaci√≥n que el usuario te proporcionar√°:\n\nVeh√≠culo: Marca, modelo, a√±o\n\nTama√±o de neum√°tico: Ancho, perfil, di√°metro (ejemplo: 205/55 R16)\n\nUso principal: (ej. Ciudad, carretera, todoterreno, pista, uso mixto)\n\nFrecuencia de carga: (ej. Diaria con carga pesada, ocasional, ligera)\n\n-----------------------------------------\nRestricciones y reglas:\n\nValidaci√≥n de seguridad: Antes de cualquier recomendaci√≥n, valida que el tama√±o de neum√°tico proporcionado por el usuario sea plausible para el veh√≠culo. Si el tama√±o no es el de f√°brica o podr√≠a causar problemas (como roce, error en el veloc√≠metro, etc.), inicia la respuesta con una advertencia de seguridad clara y explica los posibles efectos.\n\n-----------------------------------------\n\nEstructura y formato: Organiza la respuesta de manera clara y profesional utilizando las siguientes secciones con subt√≠tulos en negrita:\n\nAdvertencia de seguridad (solo si aplica)\n\nAn√°lisis de uso y necesidades\n\nOpciones de neum√°ticos recomendadas\n\n--------------------------------------------\nContenido de las recomendaciones:\n\nEn la secci√≥n \"Opciones de neum√°ticos recomendadas\", ofrece tres opciones distintas (m√≠nimo dos). Para cada opci√≥n, incluye:\n\nNombre del neum√°tico (ej. Marca Modelo)\n\nVentajas claras (por qu√© es una buena opci√≥n para el usuario)\n\nAjusta las recomendaciones para que se alineen con las preferencias del usuario \n\n\n----------------------------------------------\n\nHonestidad y confiabilidad: Nunca inventes datos. No menciones precios exactos ni la disponibilidad en tiendas. Si un dato no es verificable, ind√≠calo de forma profesional.\n-------------------------------------------------------------------\n\nüéØ Objetivo: El resultado final debe ser exactamente tres (3) referencias de neum√°ticos que se ajusten al veh√≠culo consultado.  \n\nüîë Reglas de formato:  \n- Cada referencia de neum√°tico debe estar en el formato est√°ndar: [Ancho]/[Perfil] R[Di√°metro]  \n  (ejemplo correcto: 205/55 R16).  \n- NO usar otros formatos como 205-55-16, 205 55R16 ni variantes similares.  \n- Si el cliente no especifica la medida completa, solicitar los tres datos (ancho, perfil y di√°metro).  \n\nüì¶ Resultado esperado:  \n- Lista de 3 referencias sugeridas en formato correcto.  \n- Indicar disponibilidad para revisi√≥n en inventario.  \n- Incluir link de compra asociado a cada referencia.  \n\n"
        }
      },
      "type": "n8n-nodes-ai-agent-langfuse.agentWithLangfuse",
      "typeVersion": 2,
      "position": [
        1520,
        -432
      ],
      "id": "4f744bd1-5de5-42cf-ad1d-04d3c0dc424c",
      "name": "AI Agent with Langfuse",
      "credentials": {
        "langfuseApi": {
          "id": "iBaUfiTOCXCanQdR",
          "name": "Llantas n¬¥Tires"
        }
      }
    },
    {
      "parameters": {
        "authentication": "nocoDbApiToken",
        "operation": "getAll",
        "options": {}
      },
      "type": "n8n-nodes-base.nocoDb",
      "typeVersion": 3,
      "position": [
        1728,
        416
      ],
      "id": "93b8998f-0d8d-483d-bdb1-e8b794c35add",
      "name": "Get many rows",
      "credentials": {
        "nocoDbApiToken": {
          "id": "SCVsgkuKqpGPiGvk",
          "name": "NocoDB Token account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "test_llantasnTires",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1232,
        432
      ],
      "id": "5956166b-f221-4a7e-b672-8da4b0f6a5b6",
      "name": "Llantas n¬¥ Tires",
      "webhookId": "e6160821-d484-452b-ab98-4d1af66f935b"
    }
  ],
  "pinData": {},
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "shared": [
    {
      "createdAt": "2025-09-20T12:40:36.573Z",
      "updatedAt": "2025-09-20T12:40:36.573Z",
      "role": "workflow:owner",
      "workflowId": "k0HiAcQpHtDmUSzH",
      "projectId": "nfeOgNZ0Q89hgHph"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-09-30T00:13:31.038Z",
  "versionId": "e1e71411-8c4c-4863-b2a2-2093fd460289"
}