{
  "active": false,
  "connections": {
    "Webhook1": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Google Sheets3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "solicitud a proveedores para actualizar",
            "type": "main",
            "index": 0
          },
          {
            "node": "Actualizaciones",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agregar nuevo producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets3": {
      "main": [
        [
          {
            "node": "Get Proveedores1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Proveedores1": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Cancelacion Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelacion Mensaje": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Productos Solicitados1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items4": {
      "main": [
        [],
        [
          {
            "node": "Wait5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait5": {
      "main": [
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items5": {
      "main": [
        [],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Productos Solicitados1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status1": {
      "main": [
        [
          {
            "node": "Loop Over Items5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Google Sheets5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Update Status1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items6": {
      "main": [
        [],
        [
          {
            "node": "Wait6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait6": {
      "main": [
        [
          {
            "node": "Status Cancelar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets5": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Cancelar Pedido": {
      "main": [
        [
          {
            "node": "Loop Over Items6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "solicitud a proveedores para actualizar": {
      "main": [
        [
          {
            "node": "Solicitudes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Solicitudes": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizaciones": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items7": {
      "main": [
        [],
        [
          {
            "node": "Wait7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait7": {
      "main": [
        [
          {
            "node": "Google Sheets4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets2": {
      "main": [
        [
          {
            "node": "Loop Over Items8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items8": {
      "main": [
        [],
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait8": {
      "main": [
        [
          {
            "node": "Google Sheets2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Wait8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets4": {
      "main": [
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status2": {
      "main": [
        [
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code5": {
      "main": [
        [
          {
            "node": "Loop Over Items9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets6": {
      "main": [
        [
          {
            "node": "Update Status2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items9": {
      "main": [
        [],
        [
          {
            "node": "Google Sheets6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "Loop Over Items4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message1": {
      "main": [
        [
          {
            "node": "Loop Over Items7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-09T17:15:19.897Z",
  "id": "gpCq9UcwQGr4Usvw",
  "isArchived": false,
  "meta": null,
  "name": "1.2. Actualizar Pedidos de Clientes",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "3b5bea81-13db-4b72-b6e4-1ac94e2529a2",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2224,
        1168
      ],
      "id": "3db2338a-49fa-445b-a74b-97606f4bb751",
      "name": "Webhook1",
      "webhookId": "3b5bea81-13db-4b72-b6e4-1ac94e2529a2"
    },
    {
      "parameters": {
        "jsCode": "const body = items[0].json.body;\n\nconst prev = body.previousOrder.products;\nconst updated = body.updatedOrder.products;\n\n// Funci√≥n para formatear fecha\nfunction formatearFecha(fechaISO) {\n  const fecha = new Date(fechaISO);\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const a√±o = fecha.getFullYear();\n  const horas = String(fecha.getHours()).padStart(2, '0');\n  const minutos = String(fecha.getMinutes()).padStart(2, '0');\n  const segundos = String(fecha.getSeconds()).padStart(2, '0');\n  return `${dia}/${mes}/${a√±o}, ${horas}:${minutos}:${segundos}`;\n}\n\nconst fechaFormateada = formatearFecha(body.updatedOrder.createdAt);\nlet resultados = [];\n\n// Recorremos productos actualizados\nfor (let i = 0; i < updated.length; i++) {\n  const productoNuevo = updated[i];\n  const productoPrevio = prev.find(p =>\n    p.product.name === productoNuevo.product.name &&\n    p.palet.name === productoNuevo.palet.name\n  );\n\n  if (!productoPrevio) {\n    const mismoProductoOtroPalet = prev.find(p =>\n      p.product.name === productoNuevo.product.name &&\n      p.palet.name !== productoNuevo.palet.name\n    );\n\n    if (mismoProductoOtroPalet) {\n      resultados.push({\n        tipo: 'Delete',\n        NUM_PEDIDO: body.updatedOrder.receptionNumber,\n        CIF_CLIENTE: body.updatedOrder.clientCIF,\n        NOMBRE_CLIENTE: body.updatedOrder.clientName,\n        PRODUCTOS: mismoProductoOtroPalet.product.name,\n        PALET: mismoProductoOtroPalet.palet.name,\n        CANT_PALETS: mismoProductoOtroPalet.paletQuantity,\n        CAJAS: mismoProductoOtroPalet.caja.name,\n        CANT_CAJAS: mismoProductoOtroPalet.cajaQuantity,\n        STATUS: body.updatedOrder.status,\n        FECHA: fechaFormateada\n      });\n\n      resultados.push({\n        tipo: 'New',\n        NUM_PEDIDO: body.updatedOrder.receptionNumber,\n        CIF_CLIENTE: body.updatedOrder.clientCIF,\n        NOMBRE_CLIENTE: body.updatedOrder.clientName,\n        PRODUCTOS: productoNuevo.product.name,\n        PALET: productoNuevo.palet.name,\n        CANT_PALETS: productoNuevo.paletQuantity,\n        CAJAS: productoNuevo.caja.name,\n        CANT_CAJAS: productoNuevo.cajaQuantity,\n        STATUS: body.updatedOrder.status,\n        FECHA: fechaFormateada\n      });\n    } else {\n      resultados.push({\n        tipo: 'New',\n        NUM_PEDIDO: body.updatedOrder.receptionNumber,\n        CIF_CLIENTE: body.updatedOrder.clientCIF,\n        NOMBRE_CLIENTE: body.updatedOrder.clientName,\n        PRODUCTOS: productoNuevo.product.name,\n        PALET: productoNuevo.palet.name,\n        CANT_PALETS: productoNuevo.paletQuantity,\n        CAJAS: productoNuevo.caja.name,\n        CANT_CAJAS: productoNuevo.cajaQuantity,\n        STATUS: body.updatedOrder.status,\n        FECHA: fechaFormateada\n      });\n    }\n    continue;\n  }\n\n  const cambios = [];\n\n  // Verificamos cambios y preparamos el entry solo si hay cambios reales\n  if (productoNuevo.paletQuantity !== productoPrevio.paletQuantity) {\n    cambios.push(`CANT_PALETS: ${productoPrevio.paletQuantity} ‚Üí ${productoNuevo.paletQuantity}`);\n  }\n\n  if (productoNuevo.cajaQuantity !== productoPrevio.cajaQuantity) {\n    cambios.push(`CANT_CAJAS: ${productoPrevio.cajaQuantity} ‚Üí ${productoNuevo.cajaQuantity}`);\n  }\n\n  if (productoNuevo.caja.name !== productoPrevio.caja.name) {\n    cambios.push(`CAJAS: ${productoPrevio.caja.name} ‚Üí ${productoNuevo.caja.name}`);\n  }\n\n  if (cambios.length > 0) {\n    resultados.push({\n      tipo: 'Update',\n      NUM_PEDIDO: body.updatedOrder.receptionNumber,\n      CIF_CLIENTE: body.updatedOrder.clientCIF,\n      NOMBRE_CLIENTE: body.updatedOrder.clientName,\n      PRODUCTOS: productoNuevo.product.name,\n      PALET: productoNuevo.palet.name,\n      CANT_PALETS: productoNuevo.paletQuantity,\n      CANT_PALETS_ANTES: productoPrevio.paletQuantity,\n      CAJAS: productoNuevo.caja.name,\n      CAJAS_ANTES: productoPrevio.caja.name,\n      CANT_CAJAS: productoNuevo.cajaQuantity,\n      CANT_CAJAS_ANTES: productoPrevio.cajaQuantity,\n      CAMBIOS: cambios.join(' | '),\n      STATUS: body.updatedOrder.status,\n      FECHA: fechaFormateada\n    });\n  }\n}\n\n// Verificar eliminados\nfor (let i = 0; i < prev.length; i++) {\n  const pPrev = prev[i];\n  const existe = updated.find(p =>\n    p.product.name === pPrev.product.name &&\n    p.palet.name === pPrev.palet.name\n  );\n  if (!existe) {\n    resultados.push({\n      tipo: 'Delete',\n      NUM_PEDIDO: body.updatedOrder.receptionNumber,\n      CIF_CLIENTE: body.updatedOrder.clientCIF,\n      NOMBRE_CLIENTE: body.updatedOrder.clientName,\n      PRODUCTOS: pPrev.product.name,\n      PALET: pPrev.palet.name,\n      CANT_PALETS: pPrev.paletQuantity,\n      CAJAS: pPrev.caja.name,\n      CANT_CAJAS: pPrev.cajaQuantity,\n      STATUS: body.updatedOrder.status,\n      FECHA: fechaFormateada\n    });\n  }\n}\n\n// Eliminar duplicados exactos\nfunction deduplicar(array) {\n  const seen = new Set();\n  return array.filter(item => {\n    const clave = `${item.tipo}|${item.PRODUCTOS}|${item.PALET}|${item.CAJAS}|${item.CANT_CAJAS}|${item.CANT_PALETS}`;\n    if (seen.has(clave)) {\n      return false;\n    }\n    seen.add(clave);\n    return true;\n  });\n}\n\nconst resultadosUnicos = deduplicar(resultados);\n\nreturn resultadosUnicos.map(r => ({ json: r }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2000,
        1168
      ],
      "id": "ff16cdc5-5332-43f2-bfd1-55b63e77c6c1",
      "name": "Code4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8b7e7eed-e35c-4067-8889-8972d8b0e4a8",
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "Delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Eliminar Producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6388165d-4c6e-4855-8e67-cbfae97af8d7",
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "Update",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Actualizar Producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo }}",
                    "rightValue": "New",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "454cdc57-e42b-4a5e-bb4c-1335cff03519"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Nuevo producto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1776,
        1152
      ],
      "id": "e2faae95-3cbb-48cb-b9db-34d57e368019",
      "name": "Switch"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTOS }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "CAJAS",
              "lookupValue": "={{ $json.CAJAS }}"
            },
            {
              "lookupColumn": "STATUS",
              "lookupValue": "=Solicitado"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1552,
        256
      ],
      "id": "d1769a0e-8771-40f3-912e-dde3e6e60013",
      "name": "Google Sheets3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1996169798,
          "mode": "list",
          "cachedResultName": "Proveedores",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=1996169798"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "PROVEEDOR_ID",
              "lookupValue": "={{ $json.PROVEEDOR_ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1328,
        192
      ],
      "id": "fad32321-7347-43a6-b455-a2e9990849a5",
      "name": "Get Proveedores1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        -1104,
        256
      ],
      "id": "6ac1d19c-cd67-41c1-84cf-8289ce365a5d",
      "name": "Merge2"
    },
    {
      "parameters": {
        "jsCode": "const results = [];\nconst zonaHoraria = 'America/Bogota';\nconst ahora = new Date(new Date().toLocaleString('en-US', { timeZone: zonaHoraria }));\n\n// Funci√≥n para formatear fecha como \"DD/MM/YYYY, HH:mm:ss\"\nfunction formatearFechaCompleta(fecha) {\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const a√±o = fecha.getFullYear();\n  const horas = String(fecha.getHours()).padStart(2, '0');\n  const minutos = String(fecha.getMinutes()).padStart(2, '0');\n  const segundos = String(fecha.getSeconds()).padStart(2, '0');\n  return `${dia}/${mes}/${a√±o}, ${horas}:${minutos}:${segundos}`;\n}\n\n// Funci√≥n para solo la fecha\nfunction formatearFecha(fecha) {\n  const dia = String(fecha.getDate()).padStart(2, '0');\n  const mes = String(fecha.getMonth() + 1).padStart(2, '0');\n  const a√±o = fecha.getFullYear();\n  return `${dia}/${mes}/${a√±o}`;\n}\n\nconst fechaCompleta = formatearFechaCompleta(ahora);\nconst fechaSimple = formatearFecha(ahora);\nconst saludo = ahora.getHours() < 12 ? 'Buen d√≠a' : 'Buena tarde';\nconst entrega = `hoy - (${fechaSimple})`;\n\n// Agrupar productos por proveedor\nconst proveedores = {};\n\nfor (const item of items) {\n  const prod = item.json;\n  const proveedorId = prod.PROVEEDOR_ID;\n\n  if (!proveedores[proveedorId]) {\n    proveedores[proveedorId] = {\n      ...prod,\n      PRODUCTOS: [],\n      FECHA: fechaSimple,\n      ENTREGA: entrega\n    };\n    delete proveedores[proveedorId].ID_PRODUCTO;\n    delete proveedores[proveedorId].PRODUCTO;\n    delete proveedores[proveedorId].CANT_PALETS;\n    delete proveedores[proveedorId].CANT_CAJAS;\n    delete proveedores[proveedorId].PALET;\n    delete proveedores[proveedorId].CAJAS;\n    delete proveedores[proveedorId].NUM_PEDIDO;\n    delete proveedores[proveedorId].STATUS;\n    delete proveedores[proveedorId].comentarios;\n    delete proveedores[proveedorId].MENSAJE_PROVEEDOR;\n    delete proveedores[proveedorId].FECHA_CANCELACION;\n  }\n\n  proveedores[proveedorId].PRODUCTOS.push({\n    ...prod,\n    STATUS: \"Cancelado\",\n    FECHA: fechaCompleta,\n    FECHA_CANCELACION: fechaCompleta\n  });\n}\n\n// Crear mensaje para cada proveedor\nfor (const proveedor of Object.values(proveedores)) {\n  const productosPorPedido = {};\n\n  for (const prod of proveedor.PRODUCTOS) {\n    const numPedido = prod.NUM_PEDIDO || 'SIN_PEDIDO';\n    if (!productosPorPedido[numPedido]) {\n      productosPorPedido[numPedido] = [];\n    }\n    productosPorPedido[numPedido].push(\n      `- ${prod.CANT_PALETS} x ${prod.CANT_CAJAS} - ${prod.PRODUCTO} - ${prod.PALET} - ${prod.CAJAS}`\n    );\n  }\n\n  let mensaje = `üö´ *Cancelaci√≥n de pedido*\\n${saludo}, le informamos que el siguiente pedido para ${entrega} ha sido cancelado:\\n\\n`;\n  for (const [numPedido, lineas] of Object.entries(productosPorPedido)) {\n    mensaje += `‚û°Ô∏è *pedido N¬∞: ${numPedido}*\\n`;\n    mensaje += lineas.join('\\n\\n') + '\\n\\n';\n  }\n\n  proveedor.MENSAJE_PROVEEDOR = mensaje.trim();\n  results.push({ json: proveedor });\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        256
      ],
      "id": "82f1d849-4879-4c5f-b0c3-540dca610fbe",
      "name": "Cancelacion Mensaje"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -528,
        -64
      ],
      "id": "67e2f2cf-6a06-42c1-a865-6851e53fe798",
      "name": "Loop Over Items4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -304,
        -128
      ],
      "id": "e203a12d-9f82-4e8d-8abc-d594be5ab353",
      "name": "Wait5",
      "webhookId": "9cfc9ee3-cd3d-49e2-833e-e02e70e0f36f"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -304,
        240
      ],
      "id": "6872a842-b1be-439c-ba7d-99e178c29db8",
      "name": "Loop Over Items5"
    },
    {
      "parameters": {
        "jsCode": "// 1. Extraer y unir todos los productos v√°lidos (CANT_PALETS > 0)\nlet productosValidos = [];\n\nfor (const item of items) {\n  const proveedor = item.json;\n  const productos = proveedor.PRODUCTOS || [];\n  const status = \"Cancelado\";\n\n  const filtrados = productos\n    .filter(p => p.CANT_PALETS > 0)\n    .map(p => ({\n      row_number: p.row_number,\n      ID_PRODUCTO: p.ID_PRODUCTO,\n      PROVEEDOR_ID: proveedor.PROVEEDOR_ID,\n      FINCA: proveedor.FINCA,\n      N_SOLICITUD: p.N_SOLICITUD,\n      PRODUCTO: p.PRODUCTO,\n      STATUS: status,\n    }));\n\n  productosValidos.push(...filtrados);\n}\n\n// 2. Eliminar duplicados por combinaci√≥n ID_PRODUCTO + N_SOLICITUD + numero de fila\nconst vistos = new Set();\nconst productosUnicos = productosValidos.filter(p => {\n  const clave = `${p.N_SOLICITUD}-${p.row_number}`;\n  if (vistos.has(clave)) return false;\n  vistos.add(clave);\n  return true;\n});\n\n// 3. Devolver los productos √∫nicos\nreturn productosUnicos.map(p => ({ json: p }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        240
      ],
      "id": "1a7fa924-fa9f-45ca-aa59-a59dba24b7c8",
      "name": "Productos Solicitados1"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "STATUS": "={{ $json.STATUS }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Stock",
              "displayName": "Stock",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ID_PRODUCTO",
              "displayName": "ID_PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PROVEEDOR_ID",
              "displayName": "PROVEEDOR_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "FINCA",
              "displayName": "FINCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTO",
              "displayName": "PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        144,
        240
      ],
      "id": "cef31747-9f7b-4239-b723-745769efcc37",
      "name": "Update Status1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const results = [];\nconst status = \"Cancelado\";\n\nfor (const item of items) {\n  const productos = item.json.PRODUCTOS;\n  const finca = item.json.FINCA;\n  const proveedorId = item.json.PROVEEDOR_ID;\n  const fecha = item.json.FECHA;\n  const entrega = item.json.ENTREGA;\n\n  for (const prod of productos) {\n    if (prod.CANT_PALETS > 0) {\n      results.push({\n        json: {\n          NUM_PEDIDO: prod.NUM_PEDIDO,\n          FECHA: fecha,\n          PROVEEDOR_ID: proveedorId,\n          FINCA: finca,\n          ID_PRODUCTO: prod.ID_PRODUCTO,\n          PRODUCTO: prod.PRODUCTO,\n          CANT_PALETS: prod.CANT_PALETS,\n          CANT_CAJAS: prod.CANT_CAJAS,\n          PALET: prod.PALET,\n          CAJAS: prod.CAJAS,\n          ENTREGA: entrega,\n          STATUS: status,\n        }\n      });\n    }\n  }\n}\n\n// Eliminar duplicados por NUM_PEDIDO, PRODUCTO, PALET, CAJAS\nconst uniqueResultsMap = new Map();\n\nfor (const entry of results) {\n  const j = entry.json;\n  const key = `${j.NUM_PEDIDO}|${j.PRODUCTO}|${j.PALET}|${j.CAJAS}`;\n  if (!uniqueResultsMap.has(key)) {\n    uniqueResultsMap.set(key, entry);\n  }\n}\n\nreturn Array.from(uniqueResultsMap.values());\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        528
      ],
      "id": "48d37549-9b89-4ab6-a8ef-515b0e2afc7f",
      "name": "Code1"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -80,
        192
      ],
      "id": "0e30631d-f4ae-4da5-920d-d3135f4e0a35",
      "name": "Wait2",
      "webhookId": "1b338eb5-78ca-43be-a57f-fd6b26339339"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -80,
        528
      ],
      "id": "56051e7d-0fcf-44c0-a593-ece944807dce",
      "name": "Loop Over Items6"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        144,
        496
      ],
      "id": "4d20a9bc-3005-4ead-863e-5b6592a78e45",
      "name": "Wait6",
      "webhookId": "0e85990e-3ee1-4bec-923d-ed0155bd94d5"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTOS }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "CAJAS",
              "lookupValue": "={{ $json.CAJAS }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -304,
        528
      ],
      "id": "cbf1176c-6253-412e-bf61-e29ba620070b",
      "name": "Google Sheets5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "STATUS": "Cancelado"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        368,
        528
      ],
      "id": "c81cdba3-904c-445c-b3bf-53ade6dee5a8",
      "name": "Status Cancelar Pedido",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTOS }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "CAJAS",
              "lookupValue": "={{ $json.CAJAS_ANTES }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1552,
        736
      ],
      "id": "96196aee-f563-45dd-885b-c023f3c8fef7",
      "name": "solicitud a proveedores para actualizar",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=solicitudes: {{ JSON.stringify($json.Solicitudes) }},\nactualizaciones: {{ JSON.stringify($json.Actualizaciones) }},",
        "options": {
          "systemMessage": "=Eres un **agente experto en an√°lisis log√≠stico automatizado y validaci√≥n de pedidos**. Tu responsabilidad es comparar las **solicitudes originales** con las **actualizaciones del pedido**, detectando cambios por proveedor y generando un **mensaje claro, completo y √∫nico por proveedor**. Este mensaje debe permitirles ajustar su preparaci√≥n log√≠stica **sin errores ni ambig√ºedades**, **evitando notificaciones innecesarias**.\n\n---\n\n### üß© ENTRADAS:\n\nRecibir√°s dos bloques de datos en formato JSON:\n\n* solicitudes: distribuci√≥n original de productos por proveedor, incluyendo:\n\n  * PRODUCTO\n  * PALET\n  * CAJAS (tipo de caja)\n  * CANT_PALETS\n  * CANT_CAJAS\n  * PROVEEDOR_ID\n  * NUM_PEDIDO\n\n* actualizaciones: nueva distribuci√≥n deseada, en el mismo formato.\n\n---\n\n### üéØ OBJETIVO:\n\nGenerar **un mensaje por proveedor** que detalle **√∫nicamente los cambios necesarios**, agrupados por producto. Estos pueden ser:\n\n1. **Aumentos o reducciones de cantidad** (CANT_PALETS, CANT_CAJAS)\n2. **Cambios en tipo de caja** (CAJAS)\n3. **Cancelaciones** (si CANT_PALETS = 0, sin importar CANT_CAJAS)\n4. **Altas nuevas** (producto presente en actualizaciones, pero no en solicitudes)\n\n---\n\n### üîç L√ìGICA DE COMPARACI√ìN Y DISTRIBUCI√ìN:\n\n#### 1. **Identificaci√≥n √∫nica de un producto**:\n\nBasada en: NUM_PEDIDO, PRODUCTO, PALET, PROVEEDOR_ID.\n\n#### 2. **Distribuci√≥n racional de cambios entre proveedores**:\n\n**Objetivo: minimizar la cantidad de modificaciones notificadas a proveedores.**\n\nAplica estas reglas:\n\n* En **aumentos**: asigna la diferencia **al proveedor que ya ten√≠a m√°s cantidad** del producto.\n* En **reducciones**: En reducciones:\n- Aplica la reducci√≥n al proveedor con m√°s palets del producto.\n- Si un proveedor queda con 0 palets, debe notificarse como Cancelaci√≥n y agregar el STATUS: \"Cancelado\".\n- Nunca omitir a un proveedor que ten√≠a el producto originalmente, aunque termine en 0. Siempre debe recibir notificaci√≥n si hubo cambio.\n- Si un proveedor ya tiene exactamente la cantidad final requerida, no se le notifica.\nNo se debe mencionar que un producto fue reasignado a otro proveedor.\nNo se deben generar instrucciones si no hay cambios efectivos en CANT_PALETS o CAJAS, excepto si hay cambio de tipo de caja.\n\n* Si un proveedor ya tiene la cantidad que se necesita seg√∫n el pedido actualizado, **no se le informa ning√∫n cambio**.\n* No se debe mencionar que se reasign√≥ un producto de un proveedor a otro.\n* **No se generan instrucciones si no hay cambios efectivos** en palets o tipo de caja.\n\n#### 3. **Cambios de tipo de caja**:\n\nSi cambia CAJAS, aunque las cantidades permanezcan iguales, **s√≠ se notifica el cambio, siempre a todos los proveedores implicados**.\n\n#### 4. **Cancelaciones y altas nuevas**:\n\n* Si un producto se reduce a CANT_PALETS = 0, se considera **cancelado**, y se siempre se notifica al proveedor la cancelacion y el STATUS: Cancelado.\n* Si aparece en actualizaciones pero no en solicitudes, se trata como **alta nueva**.\n\n---\n\n### ‚úÖ VALIDACIONES CR√çTICAS:\n\n* [ ] ¬øLa suma final de palets por producto coincide con la actualizaci√≥n?\n* [ ] ¬øSe evit√≥ duplicar aumentos en m√°s de un proveedor?\n* [ ] ¬øSe aplicaron reducciones solo a los proveedores necesarios?\n* [ ] ¬øSe notificaron solo los cambios reales?\n* [ ] ¬øSe evitaron notificaciones de redistribuci√≥n entre proveedores?\n* [ ] ¬øSe notificaron cambios de tipo de caja aunque no haya cambios en cantidad?\n* [ ] ¬øSe detectaron y notificaron cancelaciones y altas nuevas?\n* [ ] ¬øNo se omitieron proveedores que ten√≠an productos originalmente y ahora se redujeron a 0?\n\n\n\n---\nüì§ FORMATO DE SALIDA POR PROVEEDOR:\n\n{\n  \"PROVEEDOR_ID\": 2580,\n  \"NUM_PEDIDO\": \"PED-XXXX\",\n  \"CAMBIOS\": [\n    {\n      \"PRODUCTO\": \"PIMIENTO CALIFORNIA NARANJA I GG\",\n      \"row_number\": \"numero de fila de la solisitud a actualizar\",\n      \"comentarios\": \"descripcion corta y detallada del cambio realizado\",\n      \"STATUS\": \"Solicitado\",\n      \"ANTES\": {\n        \"CANT_PALETS\": 11,\n        \"CANT_CAJAS\": 220,\n        \"CAJAS\": \"BANDEJA GENERICA 60X40X20 S/N ETIQ\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"DESPUES\": {\n        \"CANT_PALETS\": 16,\n        \"CANT_CAJAS\": 320,\n        \"CAJAS\": \"BANDEJA GENERICA 60X40X20 S/N ETIQ\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"TIPO_CAMBIO\": [\"Aumento\"]\n    },\n    {\n      \"PRODUCTO\": \"PIMIENTO CALIFORNIA ROJO I G\",\n      \"row_number\": \"numero de fila de la solisitud a actualizar\",\n      \"comentarios\": \"descripcion corta y detallada del cambio realizado\",\n      \"STATUS\": \"Cancelado\", //siempre que la cantidad de cajas sea 0 se debe informar al proveedor la cancelacion y el STATUS Cancelado\n      \"ANTES\": {\n        \"CANT_PALETS\": 1,\n        \"CANT_CAJAS\": 20,\n        \"CAJAS\": \"GEN√âRICA\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"DESPUES\": {\n        \"CANT_PALETS\": 0,\n        \"CANT_CAJAS\": 0,\n        \"CAJAS\": \"GEN√âRICA\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"TIPO_CAMBIO\": [\"Cancelaci√≥n\"]\n    },\n    {\n      \"PRODUCTO\": \"PIMIENTO LAMUYO VERDE\",\n      \"row_number\": \"numero de fila de la solisitud a actualizar\",\n      \"comentarios\": \"descripcion corta y detallada del cambio realizado\",\n      \"STATUS\": \"Solicitado\",\n      \"ANTES\": {\n        \"CANT_PALETS\": 2,\n        \"CANT_CAJAS\": 40,\n        \"CAJAS\": \"CAJA ABIERTA 40X30\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"DESPUES\": {\n        \"CANT_PALETS\": 2,\n        \"CANT_CAJAS\": 40,\n        \"CAJAS\": \"BANDEJA TERMOSELLADA 40X30\",\n        \"PALET\": \"BOX FRUVECO\"\n      },\n      \"TIPO_CAMBIO\": [\"Cambio de tipo de caja\"]\n  ],\n  \"MENSAJE_PROVEEDOR\": \"Respecto al *pedido PED-XXXX*, ten en cuenta los siguientes cambios:\\n\\n- El producto **PIMIENTO CALIFORNIA NARANJA I GG** en palet *BOX FRUVECO* pasa de 11 a 16 palets. \\n\\n- El producto **PIMIENTO CALIFORNIA ROJO I G** en palet *BOX FRUVECO* ha sido **cancelado**. \\n\\n- El producto **PIMIENTO LAMUYO VERDE** mantiene cantidades, pero cambia el tipo de caja: antes *CAJA ABIERTA 40X30*, ahora *BANDEJA TERMOSELLADA 40X30*.\\n\\n\\nGracias por tu colaboraci√≥n.\"\n}\n\nIMPORTANTE, si no hay cambios en un producto, no se notifica al proveedor, Siempre que un producto se reduzca a 0 palets en un proveedor, se debe informar como cancelado, incluso si otro proveedor asume el total del pedido. No se debe omitir al proveedor cancelado bajo ning√∫n motivo.\nMUY IMPORTANTE Y NO OLVIDAR:\n\"STATUS\": \"Cancelado\", si se reduce a 0 la catidad de Palets o cancela el pedido,\n\"STATUS\": \"Solicitado\", para cualquier otra actualizacion\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -880,
        1168
      ],
      "id": "866c75a0-5ffb-4b29-a08a-6d5937dc4fb6",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.0-flash-lite-preview-02-05",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -816,
        1392
      ],
      "id": "8f756e4d-6706-4c9a-a854-5f41ccf6d734",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "Solicitudes",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -1328,
        736
      ],
      "id": "12038085-425c-4019-902d-e846308c8b80",
      "name": "Solicitudes"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "Actualizaciones",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -1328,
        1264
      ],
      "id": "c80216f2-7dae-4674-9437-14a6ac69b129",
      "name": "Actualizaciones"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1104,
        1168
      ],
      "id": "b7661068-65dc-4499-a7fe-77cfaa8ec1f7",
      "name": "Merge4"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el texto plano del agente\nconst raw = items[0].json.output;\n\n// Intentar extraer el JSON entre los delimitadores ```json y ```\nconst match = raw.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n\n// Si no encuentra un bloque v√°lido, intentar parsear como JSON directo\nconst cleanJsonString = match ? match[1] : raw;\n\n// Intentar parsear el contenido\nlet parsed;\ntry {\n  parsed = JSON.parse(cleanJsonString);\n} catch (error) {\n  throw new Error(\"No se pudo parsear el JSON: \" + error.message);\n}\n\n// Verificamos que sea un array\nif (!Array.isArray(parsed)) {\n  throw new Error(\"El JSON parseado no es un array.\");\n}\n\n// Devolvemos cada objeto como item independiente\nreturn parsed.map(obj => ({ json: obj }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        1168
      ],
      "id": "7ea8d05d-20ee-4ccb-8edb-91e7291ab230",
      "name": "Code3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -304,
        816
      ],
      "id": "e506f791-31bc-4fe0-a5ec-7d839874ff76",
      "name": "Loop Over Items7"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -80,
        816
      ],
      "id": "7b9edbc4-7fb2-4bb1-a552-79497353457f",
      "name": "Wait7",
      "webhookId": "d43b75d6-66cd-420b-9d59-66be566daba5"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 581820534,
          "mode": "list",
          "cachedResultName": "Solicitud a Proveedor",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=581820534"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PROVEEDOR_ID",
              "displayName": "PROVEEDOR_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FINCA",
              "displayName": "FINCA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ID_PRODUCTO",
              "displayName": "ID_PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PRODUCTO",
              "displayName": "PRODUCTO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ENTREGA",
              "displayName": "ENTREGA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "comentarios",
              "displayName": "comentarios",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        368,
        1104
      ],
      "id": "f1dc64e0-832c-42f6-8b65-72f1294eec7a",
      "name": "Google Sheets2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "content": "## UPDATE REQUEST TO SUPPLIER",
        "height": 280,
        "width": 920
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -384,
        976
      ],
      "id": "ba080304-2d0e-408e-b2b8-7e5af3a15d8c",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -304,
        1104
      ],
      "id": "550da248-e530-4621-aca1-a2948e37f349",
      "name": "Loop Over Items8"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        144,
        1104
      ],
      "id": "daaabf6d-9976-4914-a394-a2fcd8ef1468",
      "name": "Wait8",
      "webhookId": "75db1286-5ad8-4964-ac16-402ab69b4a6f"
    },
    {
      "parameters": {
        "jsCode": "const proveedor = items[0].json;\n\nconst salida = [];\n\nfor (const cambio of proveedor.CAMBIOS) {\n  // Verificar si hay \"Cancelaci√≥n\" en TIPO_CAMBIO\n  const esCancelacion = cambio.TIPO_CAMBIO.includes(\"Cancelaci√≥n\");\n\n  salida.push({\n    row_number: cambio.row_number,\n    STATUS: esCancelacion ? \"Cancelado\" : cambio.STATUS,\n    CANT_PALETS: cambio.DESPUES.CANT_PALETS,\n    CANT_CAJAS: cambio.DESPUES.CANT_CAJAS,\n    CAJAS: cambio.DESPUES.CAJAS,\n    PALET: cambio.DESPUES.PALET,\n    comentarios: cambio.comentarios\n  });\n}\n\nreturn salida.map(item => ({ json: item }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        1104
      ],
      "id": "69d4af29-ad1f-44a4-967f-0479abbe9bb6",
      "name": "Code2"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1996169798,
          "mode": "list",
          "cachedResultName": "Proveedores",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=1996169798"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "PROVEEDOR_ID",
              "lookupValue": "={{ $json.PROVEEDOR_ID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        144,
        816
      ],
      "id": "2ac5ae3b-f406-489b-b2bb-9e507712ad4f",
      "name": "Google Sheets4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "NUM_PEDIDO": "={{ $json.NUM_PEDIDO }}",
            "CIF_CLIENTE": "={{ $json.CIF_CLIENTE }}",
            "NOMBRE_CLIENTE": "={{ $json.NOMBRE_CLIENTE }}",
            "PRODUCTOS": "={{ $json.PRODUCTOS }}",
            "PALET": "={{ $json.PALET }}",
            "CANT_PALETS": "={{ $json.CANT_PALETS }}",
            "CAJAS": "={{ $json.CAJAS }}",
            "CANT_CAJAS": "={{ $json.CANT_CAJAS }}",
            "STATUS": "=Pendiente",
            "FECHA": "={{ $json.FECHA }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -1552,
        1408
      ],
      "id": "c13624d7-8e07-4879-9739-8a4c20aa0a80",
      "name": "Agregar nuevo producto",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "PRODUCTOS": "={{ $('Code5').item.json.PRODUCTO }}",
            "PALET": "={{ $('Code5').item.json.PALET }}",
            "CAJAS": "={{ $('Code5').item.json.CAJAS }}",
            "CANT_PALETS": "={{ $('Code5').item.json.CANT_PALETS }}",
            "CANT_CAJAS": "={{ $('Code5').item.json.CANT_CAJAS }}",
            "CAMBIOS": "={{ $('Code5').item.json.COMENTARIOS }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "NUM_PEDIDO",
              "displayName": "NUM_PEDIDO",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CIF_CLIENTE",
              "displayName": "CIF_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "NOMBRE_CLIENTE",
              "displayName": "NOMBRE_CLIENTE",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "PRODUCTOS",
              "displayName": "PRODUCTOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PALET",
              "displayName": "PALET",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANT_PALETS",
              "displayName": "CANT_PALETS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CAJAS",
              "displayName": "CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CANT_CAJAS",
              "displayName": "CANT_CAJAS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "STATUS",
              "displayName": "STATUS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "FECHA",
              "displayName": "FECHA",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "CAMBIOS",
              "displayName": "CAMBIOS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        368,
        1392
      ],
      "id": "47c5294e-9588-466b-9220-dbd5460f5a6e",
      "name": "Update Status2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const resumen = {};\n\nfor (const item of items) {\n  const data = item.json;\n  const num_pedido = data.NUM_PEDIDO;\n\n  for (const cambio of data.CAMBIOS) {\n    const producto = cambio.PRODUCTO;\n    const despues = cambio.DESPUES;\n    const antes = cambio.ANTES;\n    const proveedor = data.PROVEEDOR_ID;\n\n    const palet = despues.PALET;\n    const cajas = despues.CAJAS;\n    const cant_palets = despues.CANT_PALETS;\n    const cant_cajas = despues.CANT_CAJAS;\n\n    const clave = `${num_pedido}||${producto}||${palet}||${cajas}`;\n\n    if (!resumen[clave]) {\n      resumen[clave] = {\n        NUM_PEDIDO: num_pedido,\n        PRODUCTO: producto,\n        PALET: palet,\n        CAJAS: cajas,\n        CANT_PALETS: 0,\n        CANT_CAJAS: 0,\n        CAMBIOS_PROVEEDOR: [],\n        COMENTARIOS: []\n      };\n    }\n\n    resumen[clave].CANT_PALETS += cant_palets;\n    resumen[clave].CANT_CAJAS = cant_cajas; // asumimos homog√©neo\n\n    // Comentario individual por proveedor\n    const comentario = `Proveedor ${proveedor} - palets: ${antes.CANT_PALETS} ‚Üí ${despues.CANT_PALETS}`;\n    resumen[clave].COMENTARIOS.push(comentario);\n\n    resumen[clave].CAMBIOS_PROVEEDOR.push({\n      PROVEEDOR_ID: proveedor,\n      ANTES: antes.CANT_PALETS,\n      DESPUES: despues.CANT_PALETS\n    });\n  }\n}\n\n// Armar salida con trazabilidad\nconst salida = Object.values(resumen).map(r => {\n  const comentario = \n    `Palets finales: ${r.CANT_PALETS}, cajas: ${r.CANT_CAJAS}, ` +\n    `palet: ${r.PALET}, cajas: ${r.CAJAS}. Cambios por proveedor:\\n- ` +\n    r.COMENTARIOS.join('\\n- ');\n\n  return {\n    json: {\n      NUM_PEDIDO: r.NUM_PEDIDO,\n      PRODUCTO: r.PRODUCTO,\n      PALET: r.PALET,\n      CAJAS: r.CAJAS,\n      CANT_PALETS: r.CANT_PALETS,\n      CANT_CAJAS: r.CANT_CAJAS,\n      COMENTARIOS: comentario\n    }\n  };\n});\n\nreturn salida;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        1392
      ],
      "id": "8d06aa6a-7cbd-4926-80b3-32f91561ef4a",
      "name": "Code5"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI",
          "mode": "list",
          "cachedResultName": "SOLICITUD DE PEDIDOS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 88857449,
          "mode": "list",
          "cachedResultName": "Pedidos",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xq63Q1Fp7Oxu1ZCBgp8KPL8wJbjYmY6dH519Je813SI/edit#gid=88857449"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "NUM_PEDIDO",
              "lookupValue": "={{ $json.NUM_PEDIDO }}"
            },
            {
              "lookupColumn": "PRODUCTOS",
              "lookupValue": "={{ $json.PRODUCTO }}"
            },
            {
              "lookupColumn": "PALET",
              "lookupValue": "={{ $json.PALET }}"
            },
            {
              "lookupColumn": "STATUS",
              "lookupValue": "Solicitado"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        144,
        1392
      ],
      "id": "7c73be73-b382-4c14-b8d8-e28baba21d01",
      "name": "Google Sheets6",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CM7JsKen8ouMDNPD",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -80,
        1392
      ],
      "id": "5892fcde-8985-4732-a0a8-d94aa5a1a5a8",
      "name": "Loop Over Items9"
    },
    {
      "parameters": {
        "content": "# actualizacion de pedidos",
        "height": 340,
        "width": 600,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2896,
        1024
      ],
      "id": "3101e777-9a63-4ef6-aa1a-ccb85e3bc206",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=663372310202428",
        "recipientPhoneNumber": "=+{{ $json[\"N¬∫ DE TEL√âFONO\"] }}",
        "textBody": "={{ $json.MENSAJE_PROVEEDOR }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -80,
        -64
      ],
      "id": "c6fcb61f-abd8-470e-9fea-2e67f2a919e2",
      "name": "Send message",
      "webhookId": "2519ab84-2410-451a-8efb-5ab4a0c1bc17",
      "credentials": {
        "whatsAppApi": {
          "id": "5UFcul7y3FYz9Hxd",
          "name": "Estarter"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=663372310202428",
        "recipientPhoneNumber": "=+{{ $json[\"N¬∫ DE TEL√âFONO\"] }}",
        "textBody": "=Hola, {{ $json[\"ENCARGADO \"].split(' ')[0] }}, {{ $('Wait7').item.json.MENSAJE_PROVEEDOR }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        368,
        816
      ],
      "id": "f32e160e-41d8-4439-becb-c87b0277028a",
      "name": "Send message1",
      "webhookId": "8a051f3b-5bcb-4ca8-95d8-cf7527a439e1",
      "credentials": {
        "whatsAppApi": {
          "id": "5UFcul7y3FYz9Hxd",
          "name": "Estarter"
        }
      }
    }
  ],
  "pinData": {},
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-09-09T17:15:19.897Z",
      "createdAt": "2025-09-09T17:15:19.897Z",
      "role": "workflow:owner",
      "workflowId": "gpCq9UcwQGr4Usvw",
      "projectId": "jOPTDk8NtR0eZIqG"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-09-09T21:55:11.429Z",
  "versionId": "b7edff7b-835b-40c6-ab77-6af57f16316b"
}