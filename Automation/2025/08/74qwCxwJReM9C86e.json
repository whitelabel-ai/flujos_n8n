{
  "active": true,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "ChatwootData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataImage": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataPdf": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Push Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "type message Whatsap": {
      "main": [
        [
          {
            "node": "Transcribe a recording1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataText": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing4": {
      "main": [
        [
          {
            "node": "DataText",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DataAudio": {
      "main": [
        [
          {
            "node": "setData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Unir Mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Message1": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatwootData": {
      "main": [
        [
          {
            "node": "initData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "whatsappData": {
      "main": [
        [
          {
            "node": "initData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "whatsap trigger": {
      "main": [
        [
          {
            "node": "whatsappData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "initData": {
      "main": [
        [
          {
            "node": "type message Whatsap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setData": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording1": {
      "main": [
        [
          {
            "node": "DataAudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image1": {
      "main": [
        [
          {
            "node": "DataImage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze document": {
      "main": [
        [
          {
            "node": "DataPdf",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unir Mensajes": {
      "main": [
        [
          {
            "node": "Redis6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data": {
      "main": [
        [
          {
            "node": "Qubra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Qubra",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "consultar_disponibilidad": {
      "ai_tool": [
        []
      ]
    },
    "consultar_eventos_dia": {
      "ai_tool": [
        []
      ]
    },
    "agendar_reunion": {
      "ai_tool": [
        []
      ]
    },
    "Redis Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Qubra",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Redis6": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Qubra": {
      "main": [
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Informe": {
      "ai_tool": [
        [
          {
            "node": "Qubra",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-20T15:34:51.644Z",
  "id": "74qwCxwJReM9C86e",
  "isArchived": false,
  "meta": null,
  "name": "Qubra",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "Qubra",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -336,
        1152
      ],
      "id": "4c2efc7a-dcaf-43d4-a78a-0ba7b053ee4b",
      "name": "Webhook",
      "webhookId": "1b2e128a-f193-4501-bd75-f31116e4e7da"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<img>{{ $json.content.parts[0].text }}</img>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        1424
      ],
      "id": "8cda2c99-b286-4d0d-87cc-12f9f371b9f4",
      "name": "DataImage"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<pdf>{{ $json.content.parts[0].text }}</pdf>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        1232
      ],
      "id": "a64f6d0c-8c1d-4b2e-9951-0d4a43f36167",
      "name": "DataPdf"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "key": "phone_number",
              "value": "={{ $json.phone_number }}"
            },
            {
              "key": "tipo_mensaje",
              "value": "={{ $json.tipo_mensaje }}"
            },
            {
              "key": "mensaje",
              "value": "={{ $json.mensaje }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        1648,
        1136
      ],
      "id": "ad56bcb0-df10-471f-b5ea-fb78b7209cc8",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_mensaje }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "38cdad62-0d9c-45bc-860e-9e03d107ba58"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "82df4052-c480-44a2-9d09-c195d4bc6879",
                    "leftValue": "={{ $json.tipo_mensaje }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d9c1a8cf-af4e-4bca-a66c-184829c009d8",
                    "leftValue": "={{ $json.tipo_mensaje }}",
                    "rightValue": "=file",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "document"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "71778507-22f2-4e0f-99d7-fdd87ed1f26b",
                    "leftValue": "={{ $json.tipo_mensaje }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        752,
        1104
      ],
      "id": "f2539b49-2e38-452b-9382-9a244b0e6b8d",
      "name": "type message Whatsap"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $('initData').item.json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        1040
      ],
      "id": "aaa68fd5-1aa1-4db9-b6c1-710c528a4ba7",
      "name": "DataText"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        976,
        1040
      ],
      "id": "754f4c8a-e4b5-442a-ada0-3e2753b9e40d",
      "name": "No Operation, do nothing4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $('initData').item.json.nombre }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $('initData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "=<audio>{{ $json.content.parts[0].text }}</audio>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        848
      ],
      "id": "7e84117b-b5e7-4aee-a3b8-037b37c1e2e8",
      "name": "DataAudio"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=chat_id_{{ $('setData').item.json.phone_number }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2992,
        1040
      ],
      "id": "8680412f-5d98-4cf1-905f-19204170875c",
      "name": "Redis6",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2768,
        1232
      ],
      "id": "6079847c-54ef-40e2-bd70-600be8b654de",
      "name": "No Operation, do nothing7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7fe6665-ef0d-4ec2-9800-88004951e528",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('setData').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2544,
        1136
      ],
      "id": "40a2648e-51e6-4c62-aa9f-77900d12457a",
      "name": "If2"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "=chat_id_{{ $json.phone_number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2320,
        1136
      ],
      "id": "cb2c1a28-0357-400b-bdae-27ea396d6400",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2096,
        1136
      ],
      "id": "38649d94-8808-4055-a2d8-424dd8659954",
      "name": "Wait1",
      "webhookId": "c42fd9d6-416c-4950-8662-76e241fbd897"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=chat_id_{{ $json.phone_number }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1872,
        1136
      ],
      "id": "ec191615-f4cb-4415-b8d9-ad39de488431",
      "name": "Push Message1",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Incoming Messages\n",
        "height": 812,
        "width": 2512,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        672,
        784
      ],
      "id": "0c740063-6c6f-4a54-9a17-45a42c47069e",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f69a465-0cc7-43dd-97d7-aaee90bacbe3",
              "name": "nombre",
              "value": "={{ $json.body.conversation.meta.sender.name.split(\" \")[0] }}",
              "type": "string"
            },
            {
              "id": "82031891-32ae-4442-b883-fad57ad08c79",
              "name": "phone_number",
              "value": "={{ $json.body.sessionId }}",
              "type": "string"
            },
            {
              "id": "8c4da55a-b196-497b-a9ef-c0ce734b8847",
              "name": "mensaje",
              "value": "={{ $json.body.message }}",
              "type": "string"
            },
            {
              "id": "01193a9d-40ea-48b1-96f1-592105684644",
              "name": "tipo_mensaje",
              "value": "={{ $json.body.type }}",
              "type": "string"
            },
            {
              "id": "c6b5261d-a252-4328-af15-9699dfc5ba2b",
              "name": "receptor",
              "value": "={{ $json.body.message_type }}",
              "type": "string"
            },
            {
              "id": "8a4d2988-720e-46c1-9927-90f62d5ddd72",
              "name": "tags",
              "value": "={{ $json.body.conversation.labels }}",
              "type": "array"
            },
            {
              "id": "2189dde7-a49e-4226-be25-22f3e62caf99",
              "name": "conversation_id",
              "value": "={{ $json.body.sessionId }}",
              "type": "string"
            },
            {
              "id": "c8242d40-84d3-4c64-adcc-d15b8de57a9a",
              "name": "account_id",
              "value": "={{ $json.body.account.id }}",
              "type": "number"
            },
            {
              "id": "7d6c4435-2ae7-4716-a211-c8d9898dcd48",
              "name": "api_access_token",
              "value": "AKgj4inXtQC2qoDuxiHxEFtL",
              "type": "string"
            },
            {
              "id": "aad140bb-399a-46df-b78b-98aa0a9fd6e8",
              "name": "data_url",
              "value": "={{ $json.body.attachments[0].data_url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -112,
        1152
      ],
      "id": "2d004512-c43e-4e90-bc9a-6c7af89a00b1",
      "name": "ChatwootData"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7fba40fd-13ea-470a-a784-d886fa69b736",
              "name": "account_id",
              "value": "={{ $json.metadata.display_phone_number }}",
              "type": "string"
            },
            {
              "id": "cb120617-0a0f-4b8d-8979-909001725c0d",
              "name": "phone_number_id",
              "value": "={{ $json.metadata.phone_number_id }}",
              "type": "string"
            },
            {
              "id": "5276d674-1b57-4af7-88f3-5f9616e64cc3",
              "name": "nombre",
              "value": "={{ $json.contacts[0].profile.name }}",
              "type": "string"
            },
            {
              "id": "92d97526-26b7-461c-b7ec-7cd13074512e",
              "name": "phone_number",
              "value": "={{ $json.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "0605a012-1740-4b13-8e7f-57e156ad2fbe",
              "name": "mensaje",
              "value": "={{ $json.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "5060779d-87fc-49af-9212-c7972aae9ff0",
              "name": "tipo_mensaje",
              "value": "={{ $json.messages[0].type }}",
              "type": "string"
            },
            {
              "id": "358f4697-0d6f-4184-bfbd-31ff4f2e2ac2",
              "name": "tags",
              "value": "={{ $json.field }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        112,
        832
      ],
      "id": "a813483b-0b60-4515-af63-7fee325d876f",
      "name": "whatsappData"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsap",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -160,
        832
      ],
      "id": "97b5f0b9-399e-45b8-b7b2-eac17de8e4d3",
      "name": "whatsap trigger",
      "webhookId": "6704f599-c49e-4dd2-848c-7d9401baf9a1",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb120617-0a0f-4b8d-8979-909001725c0d",
              "name": "phone_number_id",
              "value": "={{ $json.phone_number_id }}",
              "type": "string"
            },
            {
              "id": "5276d674-1b57-4af7-88f3-5f9616e64cc3",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "92d97526-26b7-461c-b7ec-7cd13074512e",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "0605a012-1740-4b13-8e7f-57e156ad2fbe",
              "name": "mensaje",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            },
            {
              "id": "5060779d-87fc-49af-9212-c7972aae9ff0",
              "name": "tipo_mensaje",
              "value": "={{ $json.tipo_mensaje }}",
              "type": "string"
            },
            {
              "id": "358f4697-0d6f-4184-bfbd-31ff4f2e2ac2",
              "name": "tags",
              "value": "={{ $json.tags }}",
              "type": "string"
            },
            {
              "id": "d7bd017f-435b-4c5c-89ba-77b2bdd3d56d",
              "name": "account_id",
              "value": "={{ $json.account_id }}",
              "type": "string"
            },
            {
              "id": "5df9085c-2dab-4895-87b6-26f1a70b74c6",
              "name": "conversation_id",
              "value": "={{ $json.conversation_id }}",
              "type": "string"
            },
            {
              "id": "3b0ab472-eb47-486f-87b8-92fe29a4f764",
              "name": "data_url",
              "value": "={{ $json.data_url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        544,
        1136
      ],
      "id": "c66ef3c9-e9e6-4e04-a1d4-c6be89134de4",
      "name": "initData"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f4f107ad-f4e3-4616-a1ec-515f7324ba23",
              "name": "nombre",
              "value": "={{ $json.nombre }}",
              "type": "string"
            },
            {
              "id": "6f55c6f4-4cb3-4cec-9d31-b956d3fffde0",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "bad14eb8-f005-4d91-bd83-600e6105d974",
              "name": "mensaje",
              "value": "={{ $json.mensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1424,
        1136
      ],
      "id": "2c42ce8c-55b2-4cc8-8925-385f9da2515d",
      "name": "setData"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "audioUrls": "={{ $json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        976,
        848
      ],
      "id": "3995e152-21f8-4001-b4ac-2e37b3789008",
      "name": "Transcribe a recording1",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash-lite",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash-lite"
        },
        "text": "Act√∫a como un contador p√∫blico certificado experto en Colombia, con amplios conocimientos tributarios y financieros en Am√©rica Latina. Tambi√©n eres un ingeniero experto en prompts y an√°lisis OCR. Tu tarea es analizar de forma precisa y estructurada la imagen proporcionada (comprobante, recibo, factura, voucher, etc.) y extraer la siguiente informaci√≥n en formato JSON, validando cada campo cuidadosamente:\n\n1. **Tipo de Documento**: (Ej: Factura POS, Factura Electr√≥nica, Recibo de Caja, Voucher, Cuenta de Cobro, etc.)\n2. **Fecha del Comprobante**: en formato `dd-mm-yyyy`. (Validar que no est√© incompleta o ausente).\n3. **Monto Total**: En pesos colombianos (COP). Usar solo valores totales (ignorar subtotales).\n4. **Glosa / Descripci√≥n**: Breve texto explicando de qu√© trata el gasto o ingreso (Ej: \"Compra de v√≠veres\", \"Pago de arriendo\", etc.)\n5. **Proveedor o Comercio**: Nombre del establecimiento donde se hizo la transacci√≥n.\n6. **NIT o Documento Tributario**: Detecta y extrae el NIT del proveedor. Si no existe NIT, intenta identificar c√©dula o alg√∫n documento oficial. Si no se encuentra, informar que no hay documento tributario.\n7. **M√©todo de Pago**: Detectar si fue con Efectivo, Tarjeta de Cr√©dito, Tarjeta de D√©bito, Transferencia, Nequi, Daviplata, etc. (En caso de duda, indicar \"No especificado\").\n8. **Categor√≠a sugerida** (opcional): Prop√≥n una categor√≠a financiera general (Ej: Alimentaci√≥n, Transporte, Servicios, Arriendo, etc.).\n9. **Ingreso o Gasto**: Detectar si el documento corresponde a un **Ingreso** o un **Gasto**, basado en contexto, glosa y encabezados.\n\nAdem√°s, incluye al final una breve descripci√≥n en lenguaje natural del tipo de imagen analizada. Por ejemplo: ‚ÄúSe trata de un recibo POS con fecha clara y valor total, pero no se detecta NIT.‚Äù o ‚ÄúFactura electr√≥nica v√°lida con todos los campos presentes‚Äù.\n\nüîé Si falta alguno de los datos obligatorios (como fecha, monto), ind√≠calo expl√≠citamente con el mensaje `\"error\": \"Campo faltante: ...\"` o `\"advertencia\": \"No se detect√≥ la fecha del documento \"`.\n\nTu respuesta debe estar en formato JSON estructurado y f√°cil de procesar por un sistema automatizado.\n",
        "imageUrls": "={{ $json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        976,
        1424
      ],
      "id": "f3cf25ed-e120-4198-9256-8d8857311f98",
      "name": "Analyze image1",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash-lite",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash-lite"
        },
        "text": "Act√∫a como un contador p√∫blico certificado experto en Colombia, con amplios conocimientos tributarios y financieros en Am√©rica Latina. Tambi√©n eres un ingeniero experto en prompts y an√°lisis OCR. Tu tarea es analizar de forma precisa y estructurada la imagen proporcionada (comprobante, recibo, factura, voucher, etc.) y extraer la siguiente informaci√≥n en formato JSON, validando cada campo cuidadosamente:\n\n1. **Tipo de Documento**: (Ej: Factura POS, Factura Electr√≥nica, Recibo de Caja, Voucher, Cuenta de Cobro, etc.)\n2. **Fecha del Comprobante**: en formato `dd-mm-yyyy`. (Validar que no est√© incompleta o ausente).\n3. **Monto Total**: En pesos colombianos (COP). Usar solo valores totales (ignorar subtotales).\n4. **Glosa / Descripci√≥n**: Breve texto explicando de qu√© trata el gasto o ingreso (Ej: \"Compra de v√≠veres\", \"Pago de arriendo\", etc.)\n5. **Proveedor o Comercio**: Nombre del establecimiento donde se hizo la transacci√≥n.\n6. **NIT o Documento Tributario**: Detecta y extrae el NIT del proveedor. Si no existe NIT, intenta identificar c√©dula o alg√∫n documento oficial. Si no se encuentra, informar que no hay documento tributario.\n7. **M√©todo de Pago**: Detectar si fue con Efectivo, Tarjeta de Cr√©dito, Tarjeta de D√©bito, Transferencia, Nequi, Daviplata, etc. (En caso de duda, indicar \"No especificado\").\n8. **Categor√≠a sugerida** (opcional): Prop√≥n una categor√≠a financiera general (Ej: Alimentaci√≥n, Transporte, Servicios, Arriendo, etc.).\n9. **Ingreso o Gasto**: Detectar si el documento corresponde a un **Ingreso** o un **Gasto**, basado en contexto, glosa y encabezados.\n\nAdem√°s, incluye al final una breve descripci√≥n en lenguaje natural del tipo de imagen analizada. Por ejemplo: ‚ÄúSe trata de un recibo POS con fecha clara y valor total, pero no se detecta NIT.‚Äù o ‚ÄúFactura electr√≥nica v√°lida con todos los campos presentes‚Äù.\n\nüîé Si falta alguno de los datos obligatorios (como fecha, monto), ind√≠calo expl√≠citamente con el mensaje `\"error\": \"Campo faltante: ...\"` o `\"advertencia\": \"No se detect√≥ la fecha del documento \"`.\n\nTu respuesta debe estar en formato JSON estructurado y f√°cil de procesar por un sistema automatizado.",
        "documentUrls": "={{ $json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        976,
        1232
      ],
      "id": "b24808f0-6bbc-43aa-b169-11e770e48126",
      "name": "Analyze document",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $('Redis1').item.json.message.join('\\n').replace(/test/gi, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2768,
        1040
      ],
      "id": "08e9fa4e-fa31-4114-b863-d209068c3c43",
      "name": "Unir Mensajes"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4e6ed31c-2d8f-4415-bdaf-404a870f1cc2",
              "name": "first_name",
              "value": "={{ $('setData').item.json.nombre.split(\" \")[0] }}",
              "type": "string"
            },
            {
              "id": "f312aa42-4354-4954-92ff-9549a49c1d5b",
              "name": "user_id",
              "value": "={{ $('setData').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "b89d5418-df60-419b-84f6-5bc7bc0dd09b",
              "name": "message",
              "value": "={{ $json.message.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1296,
        1920
      ],
      "id": "9734ecfd-31b0-4cb9-9433-f2d7e86d0402",
      "name": "Data"
    },
    {
      "parameters": {
        "content": "## AGENT MAIN",
        "height": 600,
        "width": 2240
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        640,
        1824
      ],
      "id": "21e20664-2247-40c9-9305-967c2213399b",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## RESPONS AGENT",
        "height": 600,
        "width": 1720,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        656,
        2544
      ],
      "id": "3dd2c5be-fe60-4346-9c68-13a66f33af22",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Corrige mensajes de usuarios quitando caracteres raros, errores ortogr√°ficos y signos innecesarios como acentos mal puestos, pero sin cambiar el sentido original del mensaje, si llega el mismo mensaje repetido exactamente, varias veces, corriges para que solo envies uno, ",
              "role": "system"
            },
            {
              "content": "=Corrige el siguiente mensaje:\\n\\n{{ $json.message }}\\n\\nDevuelve solo el mensaje corregido"
            }
          ]
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        736,
        1920
      ],
      "id": "2ae7e5b0-622a-4907-ab35-45ff2595c6f7",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1248,
        2176
      ],
      "id": "b60d1970-e4dc-45b6-bfc1-fbc288529d8b",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "jQiccHfpS9BFKE4C",
          "name": "automation.whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "resource": "calendar",
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2320,
        2112
      ],
      "id": "d1e080ce-89e3-4201-ab8a-554a69d2ad9f",
      "name": "consultar_disponibilidad",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "RMuQyYsn6eGZTZPX",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "en.co#holiday@group.v.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Holidays in Colombia"
        },
        "timeMin": "={{ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2480,
        2112
      ],
      "id": "a44848cd-8d13-4233-b6d7-3ed3f2a514ee",
      "name": "consultar_eventos_dia",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "RMuQyYsn6eGZTZPX",
          "name": "hola@whitelabel.lat"
        }
      }
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "hola@whitelabel.lat",
          "mode": "list",
          "cachedResultName": "hola@whitelabel.lat"
        },
        "start": "={{ $fromAI('Start', `fecha y hora del inicio de la reunion `, 'string') }}",
        "end": "={{ $fromAI('End', `fecha y hora del final de la reunion, normalmente 30 minutos despues de la fecha de inicio`, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ $fromAI('attendees0_Attendees', `correo electr√≥nico del invitado`, 'string') }}"
          ],
          "color": "1",
          "conferenceDataUi": {
            "conferenceDataValues": {
              "conferenceSolution": "hangoutsMeet"
            }
          },
          "description": "={{ $fromAI('Description', `Datos importantes del prospecto, como \nEmpresa: \nCargo: \nObjetivo: \nUrgencia: \nVolumen de operaciones: \nHerramientas actuales: \notros datos recopilados del prospecto. `, 'string') }}",
          "guestsCanInviteOthers": true,
          "sendUpdates": "all",
          "summary": "={{ $fromAI('Summary', ``, 'string') }}",
          "visibility": "private"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2112,
        2144
      ],
      "id": "d38eb7b5-e13a-4931-9963-e339dd69a9f2",
      "name": "agendar_reunion",
      "retryOnFail": false,
      "waitBetweenTries": 2000,
      "maxTries": 2,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "RMuQyYsn6eGZTZPX",
          "name": "hola@whitelabel.lat"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=chat_history_qubra_{{ $('Data').item.json.user_id }}",
        "sessionTTL": 500000,
        "contextWindowLength": 25
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        1488,
        2208
      ],
      "id": "91447d6f-d33b-4d6e-b044-71bc08118a0e",
      "name": "Redis Chat Memory1",
      "credentials": {
        "redis": {
          "id": "yzvE00xFtVHtaoZ1",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Divide el siguiente mensaje en hasta **4 partes m√°s peque√±as** solo si es necesario, asegur√°ndote de que cada parte tenga sentido completo.  \n\n### **Reglas:**  \n- Si el mensaje es *corto* (hasta *160 caracteres*), devu√©lvelo en **una sola parte**.  \n- Si es *mediano* (hasta *400 caracteres*), div√≠delo en **2 partes**.  \n- Si es *largo* (hasta *600 caracteres*), div√≠delo en **3 partes**. \n- Si es *muy largo* (m√°s de *600 caracteres*), agr√©gale una **parte4**.  \n\n- **Evita dividir el mensaje innecesariamente**. Usa la **menor cantidad de partes posible**.  \n- **No cortes oraciones en puntos, comas o conectores** para mantener la coherencia.  \n- **Reemplaza siempre la palabra \"Dosis\" por \"Cantidad\"**.  \n- **No incluyas datos sensibles** en la respuesta, como:  \n  - `user_id: <n√∫mero>`  \n  - `subscriber_id: <n√∫mero>`  \n  - `first_name: <nombre>`  \n  - **Elimina estos datos sin dejar rastros.**  \n\n---\n\n### **Formato de Salida:**  \n- Devuelve la respuesta en **formato JSON** con **solo las partes necesarias**.  \n- Usa `\\n\\n` para agregar saltos de l√≠nea cuando sea necesario o para mejorar la legibilidad en listas.  \n- **Nunca uses comillas `\"` para resaltar palabras**. En su lugar, usa un solo asterisco: *palabra*.  \n\n#### **Ejemplo de salida:**  \n\n{\n  \"parte1\": \"Texto de la primera parte.\",\n  \"parte2\": \"Texto de la segunda parte.\"\n}\n\n\n---\n\n### **Mensaje:**  \n\"{{ $json.output }}\" \n\n"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        720,
        2608
      ],
      "id": "5c412407-2bab-40e5-87d2-6b444035a7fb",
      "name": "Message a model1",
      "credentials": {
        "openAiApi": {
          "id": "UYsXoFpwT6Oh1GeF",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.message.content }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1072,
        2608
      ],
      "id": "d85573ae-3549-4c4b-82d3-17cfec5120fa",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=mensaje del usuario: {{ $json.message }},",
        "options": {
          "systemMessage": "=# Identidad de Qubra\n\nEres *Qubra*, el \"Curador Digital\" y agente conversacional oficial de *Vanguardistas*.\nTu misi√≥n es guiar a empresarios, due√±os de pymes y marcas personales en un *viaje consultivo y estrat√©gico* para descubrir su esencia, diagnosticar sus retos y preparar la informaci√≥n necesaria para que se genere un informe profesional de diagn√≥stico.\n\nNo eres un chatbot gen√©rico: eres *un consultor emp√°tico, estrat√©gico y motivador*, con personalidad art√≠stica y profesional.\n\nfecha y hora hoy: {{ $now }}\n\n## Personalidad\n\nCombinas 4 arquetipos:\n\n- üé® *Artista Creador:* Usas met√°foras y un lenguaje cercano, inspirador, creativo. Ayudas al usuario a ‚Äúpintar‚Äù la esencia de su marca con autenticidad.\n- üìä *Estratega Anal√≠tico:* Haces preguntas inteligentes, detectas patrones, sintetizas con claridad. Desarmas problemas de manera l√≥gica y accesible.\n- üèóÔ∏è *Constructor de Futuro:* Orientas hacia el cambio, mostrando nuevas perspectivas y posibilidades de mejora, evitando soluciones gen√©ricas.\n- ü§ù *Socio Estrat√©gico:* Te pones en los zapatos del usuario, entiendes su negocio y contexto real, y traduces lo complejo en ideas claras y aplicables.\n\nTu tono es *cercano, profesional, claro, estrat√©gico, emp√°tico y aut√©ntico*.\n\n---\n\n# Principios Fundamentales de Qubra\n\n‚úÖ *Autenticidad y Prop√≥sito:* Cada interacci√≥n debe reflejar la singularidad del usuario y conectar con lo que da sentido a su marca. Nunca dar respuestas gen√©ricas ni superficiales.\n‚úÖ *Claridad y Simplicidad (anti-tecnicismos):* Evita jerga t√©cnica o lenguaje fr√≠o. Explica siempre en t√©rminos humanos y accesibles, para que todo sea comprensible y accionable.\n‚úÖ *Empat√≠a y Validaci√≥n Emocional:* Reconoce frustraciones, miedos y deseos. No solo valides con frases amables: demuestra comprensi√≥n real y genera confianza a trav√©s del acompa√±amiento.\n‚úÖ *Disrupci√≥n y Perspectivas √önicas:* No te limites a repetir problemas. Muestra nuevas formas de ver el negocio, oportunidades inesperadas y caminos personalizados.\n‚úÖ *Socio Estrat√©gico:* Habla como un aliado del negocio, vinculando siempre el diagn√≥stico con la vida real del usuario (ventas, clientes, tiempo, esfuerzo).\n\n‚ùå Nunca usar un tono vendedor agresivo.\n‚ùå Nunca ofrecer soluciones enlatadas o impersonales.\n‚ùå Nunca abrumar con exceso de informaci√≥n.\n‚ùå Nunca juzgar o minimizar las respuestas del usuario.\n\n---\n\n# Objetivo de Qubra\n\n1. Guiar al usuario en una conversaci√≥n diagn√≥stica estructurada, para descubrir su realidad actual en marketing, procesos y tecnolog√≠a.\n2. Responder preguntas sobre Vanguardistas y su metodolog√≠a cuando sea necesario.\n3. Capturar todas las respuestas del usuario, validarlas y almacenarlas en memoria, para luego enviarlas a la `tool` *Generar Informe*.\n4. Al final, invitar al usuario a recibir su informe por email y pedir el correo de contacto.\n\n---\n\n# Flujo General de Conversaci√≥n\n\n## Etapa 1 ‚Äì Retratar (Expresionista üé®)\n(El objetivo aqu√≠ es conectar con la verdad emocional y el prop√≥sito de la marca, tal como lo hace el Expresionismo.)\n-*Inicio:*\n\n  -Da la bienvenida c√°lida y presenta a Qubra como el consultor digital de Vanguardistas.\n  -  Pide *nombre, empresa y correo* de manera amable para personalizar la experiencia.\n\n-  *Preguntas gu√≠a para descubrir esencia y visi√≥n:*\n\n  1. ‚Äú¬øQu√© es lo que te inspira a trabajar cada d√≠a?‚Äù\n  2. ‚Äú¬øQu√© vendes y a qu√© sector te diriges? (ejemplo: servicios de consultor√≠a para empresas, productos de bienestar, formaci√≥n presencial, etc.)‚Äù\n  3. ‚Äú¬øQu√© emociones quieres que tu marca transmita a tus clientes?‚Äù\n\n-  *Claves:*\n\n  -  Validar siempre la respuesta con empat√≠a, reconociendo tanto aspiraciones como miedos.\n  -  Usar met√°foras art√≠sticas para resaltar lo valioso de cada respuesta. Ejemplo: ‚ÄúLo que me cuentas es como los colores base de un lienzo: esenciales para pintar la identidad de tu marca‚Äù.\n  -  Mantener un tono inspirador, curioso y cercano.\n\n---\n\n## Etapa 2 ‚Äì Descomponer (Cubista üß©)\n\n-  *Objetivo:* identificar retos actuales en ventas, conocimiento del cliente y visibilidad digital.\n(En esta fase, se desglosa el negocio para obtener una visi√≥n multidimensional, al estilo Cubista.)\n\n-  *Preguntas gu√≠a:*\n\n  1. ‚Äú¬øCu√°l es el principal problema que enfrentas con respecto a tus ventas hoy?‚Äù\n  2. ‚Äú¬øHasta qu√© punto conoces a profundidad a tu cliente ideal y el problema espec√≠fico que [marca/empresa] resuelve para ellos?‚Äù\n  3. ‚Äú¬øC√≥mo describir√≠as la experiencia que tus clientes viven al interactuar con tu marca?‚Äù\n  4. ‚Äú¬øQu√© tan visible eres a nivel digital?‚Äù\n\n-  *Claves:*\n\n  -  Reconocer con empat√≠a cualquier frustraci√≥n. Ejemplo: ‚ÄúEntiendo lo que dices, muchas empresas sienten esa presi√≥n, pero tambi√©n revela una oportunidad de cambio‚Äù.\n  -  Reflexionar un ‚Äúfragmento de oportunidad‚Äù despu√©s de cada respuesta.\n  -  Mantener la conversaci√≥n fluida, evitando sonar a cuestionario r√≠gido.\n  -  Organizar mentalmente cada respuesta por categor√≠as: *ventas, cliente ideal, experiencia, visibilidad*.\n\n---\n\n## Etapa 3 ‚Äì Reinterpretar (Constructivista üèóÔ∏è)\n\n-  *Objetivo:* proyectar futuro y motivar acci√≥n.\n(Aqu√≠ se recopila la informaci√≥n necesaria para dise√±ar una soluci√≥n, como un artista Constructivista.)\n\n-  *Preguntas gu√≠a:*\n\n  1. ‚Äú¬øQu√© objetivo refleja mejor lo que quieres lograr con tu marca a nivel digital?‚Äù\n  2. ‚Äú¬øCu√°les son los recursos existentes que cuentas actualmente para mejorar tu presencia digital?‚Äù\n  3. ‚ÄúCuando mires atr√°s, ¬øqu√© te har√° sentir que este proceso ha sido un √©xito para tu negocio?‚Äù\n\n-  *Claves:*\n\n  -  Resumir lo aprendido en tono claro y motivador, como un socio que acompa√±a y entiende el negocio.\n  -  Evitar soluciones gen√©ricas: mostrar siempre caminos personalizados.\n  -  Explicar que Vanguardistas generar√° un *Informe Diagn√≥stico* con un mini plan de acci√≥n.\n  -Pedir confirmaci√≥n del *email de contacto* para enviar el informe.\n  -Cerrar agradeciendo y destacando que el informe ser√° un mapa inicial y √∫nico para impulsar su negocio.\n\n---\n\n# Manejo de Preguntas del Usuario\n\n- *Si la pregunta es sobre la metodolog√≠a o la empresa:* usa la `tool` *Buscar en Documentaci√≥n (RAG)* para responder con precisi√≥n y sencillez.\n- *Si la pregunta es fuera de contexto:* redirige con cortes√≠a hacia la conversaci√≥n diagn√≥stica. Ejemplo:\n\n  > ‚ÄúEs un tema interesante. Para darte un diagn√≥stico √∫til para tu negocio, ¬øte parece si seguimos explorando tu presencia digital?‚Äù\n\n---\n\n# Reglas de Qubra\n\n‚úÖ Siempre guiar la conversaci√≥n hacia el diagn√≥stico.\n‚úÖ Ser emp√°tico y profesional, nunca rob√≥tico ni vendedor agresivo.\n‚úÖ Reconocer frustraciones y esperanzas, mostrando comprensi√≥n real.\n‚úÖ Recordar el contexto completo y usar referencias a respuestas previas.\n‚úÖ Guardar y estructurar respuestas en memoria, para enviarlas a la `tool` Generar Informe.\n‚úÖ Pedir y validar el correo antes de finalizar la sesi√≥n.\n‚úÖ Mantener el tono Vanguardista: humano, estrat√©gico, art√≠stico, inspirador y aut√©ntico.\n\n‚ùå Nunca dar un diagn√≥stico final dentro del chat (eso lo hace la tool del informe).\n‚ùå Nunca improvisar informaci√≥n que no est√© en la documentaci√≥n de Vanguardistas.\n‚ùå Nunca terminar la conversaci√≥n sin ofrecer el pr√≥ximo paso (el informe).\n\n---\n\n# Tools disponibles\n\n1. *Generar Informe:* recibe el historial completo de conversaci√≥n (preguntas y respuestas) y crea el informe diagn√≥stico para el usuario.\n2. *Buscar en Documentaci√≥n (RAG):* permite consultar la documentaci√≥n de Vanguardistas para responder preguntas de proceso/metodolog√≠a.\n3. *Guardar Progreso en DB (opcional):* guarda estado de respuestas en caso de desconexi√≥n del chat.\n\n---\n\n# Instrucciones t√©cnicas\n\n- Mant√©n toda la informaci√≥n del usuario organizada en un objeto estructurado (ejemplo JSON) con campos:\n\n  - `nombre`\n  - `empresa`\n  - `correo`\n  - `respuestas_marketing`\n  - `respuestas_procesos`\n  - `respuestas_tecnologia`\n  - `respuestas_prop√≥sito`\n  - `preguntas_extra`\n\n- Una vez el usuario haya respondido lo suficiente, *invoca la tool Generar Informe* enviando el historial de conversaci√≥n + datos estructurados. \nIMPPORTANTE, Si faltan respuestas para alguna etapa, Qubra nunca debe mandar a la tool. Debe detectar huecos y pedir lo que falta con calidez.\n\n- Cierra siempre agradeciendo, resaltando lo valioso de las respuestas del usuario y confirmando el env√≠o del informe al correo.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1648,
        1888
      ],
      "id": "d9e3f58e-da1a-4ef7-8976-e5c0fef0f572",
      "name": "Qubra"
    },
    {
      "parameters": {
        "description": "cuando tengas las respuestas completas del usuario llama esta tool para generar el informe.",
        "workflowId": {
          "__rl": true,
          "value": "kU6PQmiycPyk0PMH",
          "mode": "list",
          "cachedResultName": "informe"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "¬øQu√© es lo que te inspira a trabajar cada d√≠a?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Qu__es_lo_que_te_inspira_a_trabajar_cada_d_a_', `respuesta del usuario a la pregunta ¬øQu√© es lo que te inspira a trabajar cada d√≠a?`, 'string') }}",
            "user_name": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('user_name', ``, 'string') }}",
            "user_email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('user_email', ``, 'string') }}",
            "user_empresa": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('user_empresa', `nombre de la empresa del usuario`, 'string') }}",
            "¬øQu√© vendes y a qu√© sector te diriges?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Qu__vendes_y_a_qu__sector_te_diriges_', `respuesta del usuario a la pregunta Qu√© vendes y a qu√© sector te diriges?`, 'string') }}",
            "¬øQu√© emociones quieres que tu marca transmita a tus clientes?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Qu__emociones_quieres_que_tu_marca_transmita_a_tus_clientes_', `respuesta del usuario a la pregunta ¬øQu√© emociones quieres que tu marca transmita a tus clientes?`, 'string') }}",
            "¬øCu√°l es el principal problema que enfrentas con respecto a tus ventas hoy? ": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Cu_l_es_el_principal_problema_que_enfrentas_con_respecto_a_tus', `respuesta del usuario a la pregunta ¬øCu√°l es el principal problema que enfrentas con respecto a tus ventas hoy?`, 'string') }}",
            "¬øHasta qu√© punto conoces a profundidad a tu cliente ideal y el problema espec√≠fico que tu marca/empresa resuelve para ellos?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Hasta_qu__punto_conoces_a_profundidad_a_tu_cliente_ideal_y_el_', `respuesta del usuario a la pregunta ¬øHasta qu√© punto conoces a profundidad a tu cliente ideal y el problema espec√≠fico que tu marca/empresa resuelve para ellos?`, 'string') }}",
            "¬øC√≥mo describir√≠as la experiencia que tus clientes viven al interactuar con tu marca?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_C_mo_describir_as_la_experiencia_que_tus_clientes_viven_al_int', `respuesta del usuario a la pregunta ¬øC√≥mo describir√≠as la experiencia que tus clientes viven al interactuar con tu marca?`, 'string') }}",
            "¬øQu√© tan visible eres a nivel digital?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Qu__tan_visible_eres_a_nivel_digital_', `respuesta del usuario a la pregunta`, 'string') }}",
            "¬øQu√© objetivo refleja mejor lo que quieres lograr con tu marca a nivel digital?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Qu__objetivo_refleja_mejor_lo_que_quieres_lograr_con_tu_marca_', `respuesta del usuario a la pregunta ¬øQu√© tan visible eres a nivel digital?`, 'string') }}",
            "¬øCu√°les son los recursos existentes que cuentas actualmente para mejorar tu presencia digital?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('_Cu_les_son_los_recursos_existentes_que_cuentas_actualmente_par', `respuesta del usuario a la pregunta ¬øQu√© objetivo refleja mejor lo que quieres lograr con tu marca a nivel digital?`, 'string') }}",
            "Cuando mires atr√°s, ¬øqu√© te har√° sentir que este proceso ha sido un √©xito para tu negocio?": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Cuando_mires_atr_s___qu__te_har__sentir_que_este_proceso_ha_sid', `respuesta del usuario a la pregunta ¬øCu√°les son los recursos existentes que cuentas actualmente para mejorar tu presencia digital?`, 'string') }}",
            "historial de conversaci√≥n": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('historial_de_conversaci_n', `historial completo de la conversacion Cuando mires atr√°s, ¬øqu√© te har√° sentir que este proceso ha sido un √©xito para tu negocio?`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "user_name",
              "displayName": "user_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "user_email",
              "displayName": "user_email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "user_empresa",
              "displayName": "user_empresa",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øQu√© es lo que te inspira a trabajar cada d√≠a?",
              "displayName": "¬øQu√© es lo que te inspira a trabajar cada d√≠a?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øQu√© vendes y a qu√© sector te diriges?",
              "displayName": "¬øQu√© vendes y a qu√© sector te diriges?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øQu√© emociones quieres que tu marca transmita a tus clientes?",
              "displayName": "¬øQu√© emociones quieres que tu marca transmita a tus clientes?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øCu√°l es el principal problema que enfrentas con respecto a tus ventas hoy? ",
              "displayName": "¬øCu√°l es el principal problema que enfrentas con respecto a tus ventas hoy? ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øHasta qu√© punto conoces a profundidad a tu cliente ideal y el problema espec√≠fico que tu marca/empresa resuelve para ellos?",
              "displayName": "¬øHasta qu√© punto conoces a profundidad a tu cliente ideal y el problema espec√≠fico que tu marca/empresa resuelve para ellos?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øC√≥mo describir√≠as la experiencia que tus clientes viven al interactuar con tu marca?",
              "displayName": "¬øC√≥mo describir√≠as la experiencia que tus clientes viven al interactuar con tu marca?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øQu√© tan visible eres a nivel digital?",
              "displayName": "¬øQu√© tan visible eres a nivel digital?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øQu√© objetivo refleja mejor lo que quieres lograr con tu marca a nivel digital?",
              "displayName": "¬øQu√© objetivo refleja mejor lo que quieres lograr con tu marca a nivel digital?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "¬øCu√°les son los recursos existentes que cuentas actualmente para mejorar tu presencia digital?",
              "displayName": "¬øCu√°les son los recursos existentes que cuentas actualmente para mejorar tu presencia digital?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Cuando mires atr√°s, ¬øqu√© te har√° sentir que este proceso ha sido un √©xito para tu negocio?",
              "displayName": "Cuando mires atr√°s, ¬øqu√© te har√° sentir que este proceso ha sido un √©xito para tu negocio?",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "historial de conversaci√≥n",
              "displayName": "historial de conversaci√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1824,
        2176
      ],
      "id": "1cbd9f54-8144-4ba4-b45c-8b133829abcc",
      "name": "Generar Informe"
    }
  ],
  "pinData": {
    "whatsap trigger": [
      {
        "json": {
          "messaging_product": "whatsapp",
          "metadata": {
            "display_phone_number": "573143400476",
            "phone_number_id": "735679592965149"
          },
          "contacts": [
            {
              "profile": {
                "name": "Pedro Rodriguez"
              },
              "wa_id": "573228854498"
            }
          ],
          "messages": [
            {
              "from": "573228854498",
              "id": "wamid.HBgMNTczMjI4ODU0NDk4FQIAEhgUM0ZCOUNFRjE5M0FFNzZENzAxQUEA",
              "timestamp": "1755298718",
              "text": {
                "body": "organizar gastos"
              },
              "type": "text"
            }
          ],
          "field": "messages"
        }
      }
    ],
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "automation.whitelabel.lat",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
            "content-length": "109",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "es-ES,es;q=0.9",
            "content-type": "application/json",
            "origin": "https://vanguardistas.netlify.app",
            "priority": "u=1, i",
            "referer": "https://vanguardistas.netlify.app/",
            "sec-ch-ua": "\"Not)A;Brand\";v=\"8\", \"Chromium\";v=\"138\", \"Google Chrome\";v=\"138\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "186.102.22.95",
            "x-forwarded-host": "automation.whitelabel.lat",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "4f3b0c84f963",
            "x-real-ip": "186.102.22.95"
          },
          "params": {},
          "query": {},
          "body": {
            "message": "si el correo esta bien",
            "sessionId": "session_dcef5b8b-dee2-46e2-a80b-3b3fdb414db6",
            "type": "text"
          },
          "webhookUrl": "https://automation.whitelabel.lat/webhook/Qubra",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo_name": "flujos_n8n",
  "repo_owner": "whitelabel-ai",
  "repo_path": "Automation/",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-08-20T22:04:47.872Z",
  "versionId": "10fa55f5-5bd0-4193-b275-48c98eecb287"
}